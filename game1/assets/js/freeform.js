$(function(){var ua,msie=window.navigator.userAgent.indexOf("MSIE "),lastCommand=null,panels=[".panel-colour",".panel-shapes",".panel-order",".panel-finish"];window.rtWin=window;var canvasObj=document.getElementById("canvas");canvasObj.width=window.innerWidth,canvasObj.height=window.innerHeight,window.canvas=new fabric.Canvas("canvas"),canvas.selection=!1,canvas.preserveObjectStacking=!0,canvas.backgroundColor="#00A6F6",canvas.renderAll();var HideControls={tl:!1,tr:!1,bl:!1,br:!1,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!0};function addObject(obj,canvasObj,objectid,shapeid){obj.transparentCorners=!1,obj.padding=20,obj.cornerSize=30,obj.cornerStyle="circle",obj.cornerFillColor="white",obj.borderDashArray=[10,20],obj.borderColor="grey",obj.cornerStrokeColor="grey",obj.cornerColor="white",obj.centeredRotation=!0,obj.lockScalingFlip=!0,obj.id=objectid,obj.shapeid=shapeid,obj.originX="center",obj.originY="center",obj.absolutePosition=!0,obj.setControlsVisibility(HideControls),canvasObj.add(obj),canvas.viewportCenterObject(obj),canvas.setActiveObject(obj),updatePreview()}function loadShape(id){var objectid=makeid();fabric.loadSVGFromURL("assets/img/"+id+".svg",function(objects,options){var obj;addObject(fabric.util.groupSVGElements(objects,options),canvas,objectid,id)}),addOrderItem(id,objectid),hideMenuPanel()}window.showMenuPanel=function(name){var w="30vw";window.innerHeight>window.innerWidth&&(w="60vw"),$(panels).each(function(index,value){value!=name?($(value).css("opacity","0"),$(value).css("display","none")):($(".inner-panel-holder").css("width",w),$(value).css("display","block"),$(value).css("opacity","1"),$(".side-nav").addClass("open"))})},window.addOrderItem=function(shapeID,objectID){var html='<div class="order-item" data-objectid="'+objectID+'"><table><tr><td class="layer-preview-holder"><div class="preview-holder" id="preview-order-'+objectID+'"><img src="assets/img/preview-'+shapeID+'.png" alt=""></div></td><td class="layer-button-holder"><div class="up-arrow btn"><img src="assets/img/arrow-up.png" alt=""></div><div class="down-arrow btn"><img src="assets/img/arrow-down.png" alt=""></div><div class="delete-button btn"><img src="assets/img/delete.png" alt=""></div></td></tr></table></div>';$(".panel-order .inner-content").prepend(html),$(".up-arrow").each(function(){$(this).off().on("click",function(){var id=$(this).closest(".order-item").data("objectid");moveUp($(this).closest(".order-item")),canvas.getObjects().forEach(function(o){o.id===id&&o.bringForward()})})}),$(".down-arrow").each(function(){$(this).off().on("click",function(){var id=$(this).closest(".order-item").data("objectid");moveDown($(this).closest(".order-item")),canvas.getObjects().forEach(function(o){o.id===id&&o.sendBackwards()})})}),$(".delete-button").each(function(){$(this).off().on("click",function(){var id=$(this).closest(".order-item").data("objectid");moveDown($(this).closest(".order-item")),canvas.getObjects().forEach(function(o){o.id===id&&canvas.remove(o)}),$(this).closest(".order-item").remove()})})},window.moveUp=function($item){$before=$item.prev(),$item.insertBefore($before)},window.moveDown=function($item){$after=$item.next(),$item.insertAfter($after)},window.hideMenuPanel=function(){$(panels).each(function(index,value){$(".inner-panel-holder").css("width","0vw"),$(value).css("opacity","0"),$(value).css("display","none"),$(".side-nav").removeClass("open")})},window.makeid=function(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<10;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},$(".btn-colour").on("click",function(){showMenuPanel(".panel-colour")}),$(".btn-shapes").on("click",function(){showMenuPanel(".panel-shapes")}),$(".btn-order").on("click",function(){showMenuPanel(".panel-order")}),$(".btn-finish").on("click",function(){showMenuPanel(".panel-finish")}),$(window).resize(function(){hideMenuPanel(),setTimeout(function(){canvas.setDimensions({width:window.innerWidth,height:window.innerHeight}),canvas.renderAll()},100)}),$(".shape-btn").each(function(){$(this).on("click",function(){loadShape($(this).data("shape-id"))})}),$(".background-pallete-group .colour-block").each(function(){$(this).on("click",function(){canvas.backgroundColor=$(this).data("color-value"),canvas.renderAll(),hideMenuPanel()})}),$(".image-pallete-group .colour-block").each(function(){$(this).on("click",function(){var activeObject=canvas.getActiveObject();null!=activeObject&&(activeObject.set("fill",$(this).data("color-value")),$("#preview-order-"+activeObject.id).css("background-color",$(this).data("color-value")),canvas.renderAll(),hideMenuPanel(),updatePreview())})}),$(document).on("click touchstart",function(evt){"nav-panel"!=evt.target.id&&($(evt.target).closest("#nav-panel").length||hideMenuPanel())}),$("canvas").on("click",function(){updatePreview()}),window.updatePreview=function(){var activeObject=canvas.getActiveObject();null!=activeObject?($(".panel-colour .preview-holder").css("background-color",activeObject.get("fill")),$(".panel-colour .preview-holder img").attr("src","assets/img/preview-"+activeObject.shapeid+".png")):($(".panel-colour .preview-holder").css("background-color","grey"),$(".panel-colour .preview-holder img").attr("src","assets/img/preview-default.png"))},$(".btn-menu").on("click",function(){lastCommand="menu",$("#confirmPopup").modal("show")}),$(".btn-new").on("click",function(){lastCommand="new",$("#confirmPopup").modal("show")}),$(".okbtn").on("click",function(){"new"==lastCommand?location.reload():location.href="./",lastCommand=null}),$(".btn-download-cube").on("click",function(){gtag("event","click",{event_category:"freeform-download",event_label:"cube",value:"1"});var offscreenCanvas=document.createElement("canvas");offscreenCanvas.width=1920,offscreenCanvas.height=1080;var context=offscreenCanvas.getContext("2d"),overlay=new Image,design=new Image,newTab=rtWin.open(),w=canvas.width,h=canvas.height,r=canvas.rotation,zoom;w>h?(zoom=1414/w,canvas.setWidth(1414,{cssOnly:!1}),canvas.setHeight(917,{cssOnly:!1})):(zoom=917/w,canvas.setWidth(917,{cssOnly:!1}),canvas.setHeight(1414,{cssOnly:!1})),canvas.setZoom(zoom),design.onload=function(){if(design.width<design.height){var rotateCanvas=document.createElement("canvas");rotateCanvas.width=1414,rotateCanvas.height=917;var rcontext=rotateCanvas.getContext("2d");rcontext.setTransform(0,-1,1,0,0,rotateCanvas.height),rcontext.drawImage(design,0,0);var rotatedImage=new Image;rotatedImage.onload=function(){context.drawImage(rotatedImage,256,81,1414,917),overlay.onload=function(){context.drawImage(overlay,0,0,1920,1080);var exportImage=new Image;exportImage.onload=function(){if(msie>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var imgtag='<img src="'+exportImageData+'" style="width:100%;height:auto;"/>';newTab.document.write(imgtag)}else newTab.document.body.append(exportImage);delete offscreenCanvas,delete rotateCanvas,$(exportImage).css("display","block"),$(exportImage).css("width","100%"),$(exportImage).css("height","auto"),$(exportImage).css("position","absolute"),$(exportImage).css("top","0px"),$(exportImage).css("left","0px"),canvas.setWidth(w),canvas.setHeight(h),canvas.setZoom(1)};var exportImageData=offscreenCanvas.toDataURL();exportImage.src=exportImageData},overlay.src="assets/img/cube-template.png"};var rotatedImagedata=rotateCanvas.toDataURL();rotatedImage.src=rotatedImagedata}else context.drawImage(design,256,81,1414,917),overlay.onload=function(){context.drawImage(overlay,0,0,1920,1080);var exportImage=new Image;exportImage.onload=function(){if(msie>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var imgtag='<img src="'+exportImageData+'" style="width:100%;height:auto;"/>';newTab.document.write(imgtag)}else newTab.document.body.append(exportImage);delete offscreenCanvas,$(exportImage).css("display","block"),$(exportImage).css("width","100%"),$(exportImage).css("height","auto"),$(exportImage).css("position","absolute"),$(exportImage).css("top","0px"),$(exportImage).css("left","0px"),canvas.setWidth(w),canvas.setHeight(h),canvas.setZoom(1)};var exportImageData=offscreenCanvas.toDataURL();exportImage.src=exportImageData},overlay.src="assets/img/cube-template.png"};var designdata=canvas.toDataURL();design.src=designdata}),$(".btn-download-wallpaper").on("click",function(){gtag("event","click",{event_category:"freeform-download",event_label:"wallpaper",value:"1"});var offscreenCanvas=document.createElement("canvas");canvas.width>canvas.height?(offscreenCanvas.width=1920,offscreenCanvas.height=1080):(offscreenCanvas.width=1080,offscreenCanvas.height=1920);var context=offscreenCanvas.getContext("2d"),overlay=new Image,design=new Image,newTab=rtWin.open(),w=canvas.width,h=canvas.height,r=canvas.rotation,zoom;w>h?(zoom=1920/w,canvas.setWidth(1920,{cssOnly:!1}),canvas.setHeight(1080,{cssOnly:!1})):(zoom=1080/w,canvas.setWidth(1080,{cssOnly:!1}),canvas.setHeight(1920,{cssOnly:!1})),canvas.setZoom(zoom),design.onload=function(){context.drawImage(design,0,0,canvas.width,canvas.height),overlay.onload=function(){context.drawImage(overlay,canvas.width-overlay.width-20,canvas.height-overlay.height-20,overlay.width,overlay.height);var exportImage=new Image;exportImage.onload=function(){if(msie>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var imgtag='<img src="'+exportImageData+'" style="width:100%;height:auto;"/>';newTab.document.write(imgtag)}else newTab.document.body.append(exportImage);delete offscreenCanvas,$(exportImage).css("display","block"),$(exportImage).css("width","100%"),$(exportImage).css("height","auto"),$(exportImage).css("position","absolute"),$(exportImage).css("top","0px"),$(exportImage).css("left","0px"),canvas.setWidth(w),canvas.setHeight(h),canvas.setZoom(1)};var exportImageData=offscreenCanvas.toDataURL();exportImage.src=exportImageData},overlay.src="assets/img/watermark.png"};var designdata=canvas.toDataURL();design.src=designdata})});