var fabric=fabric||{version:"2.4.0"};function resizeCanvasIfNeeded(pipelineState){var targetCanvas=pipelineState.targetCanvas,width=targetCanvas.width,height=targetCanvas.height,dWidth=pipelineState.destinationWidth,dHeight=pipelineState.destinationHeight;width===dWidth&&height===dHeight||(targetCanvas.width=dWidth,targetCanvas.height=dHeight)}function copyGLTo2DDrawImage(gl,pipelineState){var glCanvas=gl.canvas,targetCanvas=pipelineState.targetCanvas,ctx=targetCanvas.getContext("2d");ctx.translate(0,targetCanvas.height),ctx.scale(1,-1);var sourceY=glCanvas.height-targetCanvas.height;ctx.drawImage(glCanvas,0,sourceY,targetCanvas.width,targetCanvas.height,0,0,targetCanvas.width,targetCanvas.height)}function copyGLTo2DPutImageData(gl,pipelineState){var targetCanvas,ctx=pipelineState.targetCanvas.getContext("2d"),dWidth=pipelineState.destinationWidth,dHeight=pipelineState.destinationHeight,numBytes=dWidth*dHeight*4,u8=new Uint8Array(this.imageBuffer,0,numBytes),u8Clamped=new Uint8ClampedArray(this.imageBuffer,0,numBytes);gl.readPixels(0,0,dWidth,dHeight,gl.RGBA,gl.UNSIGNED_BYTE,u8);var imgData=new ImageData(u8Clamped,dWidth,dHeight);ctx.putImageData(imgData,0,0)}"undefined"!=typeof exports?exports.fabric=fabric:"function"==typeof define&&define.amd&&define([],function(){return fabric}),"undefined"!=typeof document&&"undefined"!=typeof window?(fabric.document=document,fabric.window=window):(fabric.document=require("jsdom").jsdom(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]}}),fabric.jsdomImplForWrapper=require("jsdom/lib/jsdom/living/generated/utils").implForWrapper,fabric.nodeCanvas=require("jsdom/lib/jsdom/utils").Canvas,fabric.window=fabric.document.defaultView,DOMParser=require("xmldom").DOMParser),fabric.isTouchSupported="ontouchstart"in fabric.window,fabric.isLikelyNode="undefined"!=typeof Buffer&&"undefined"==typeof window,fabric.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","instantiated_by_use","clip-path"],fabric.DPI=96,fabric.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:e[-+]?\\d+)?)",fabric.fontPaths={},fabric.iMatrix=[1,0,0,1,0,0],fabric.canvasModule="canvas",fabric.perfLimitSizeTotal=2097152,fabric.maxCacheSideLimit=4096,fabric.minCacheSideLimit=256,fabric.charWidthsCache={},fabric.textureSize=2048,fabric.enableGLFiltering=!0,fabric.devicePixelRatio=fabric.window.devicePixelRatio||fabric.window.webkitDevicePixelRatio||fabric.window.mozDevicePixelRatio||1,fabric.browserShadowBlurConstant=1,fabric.arcToSegmentsCache={},fabric.boundsOfCurveCache={},fabric.cachesBoundsOfCurve=!0,fabric.initFilterBackend=function(){return fabric.enableGLFiltering&&fabric.isWebglSupported&&fabric.isWebglSupported(fabric.textureSize)?(console.log("max texture size: "+fabric.maxTextureSize),new fabric.WebglFilterBackend({tileSize:fabric.textureSize})):fabric.Canvas2dFilterBackend?new fabric.Canvas2dFilterBackend:void 0},"undefined"!=typeof document&&"undefined"!=typeof window&&(window.fabric=fabric),function(){function _removeEventListener(eventName,handler){if(this.__eventListeners[eventName]){var eventListener=this.__eventListeners[eventName];handler?eventListener[eventListener.indexOf(handler)]=!1:fabric.util.array.fill(eventListener,!1)}}function observe(eventName,handler){if(this.__eventListeners||(this.__eventListeners={}),1===arguments.length)for(var prop in eventName)this.on(prop,eventName[prop]);else this.__eventListeners[eventName]||(this.__eventListeners[eventName]=[]),this.__eventListeners[eventName].push(handler);return this}function stopObserving(eventName,handler){if(this.__eventListeners){if(0===arguments.length)for(eventName in this.__eventListeners)_removeEventListener.call(this,eventName);else if(1===arguments.length&&"object"==typeof arguments[0])for(var prop in eventName)_removeEventListener.call(this,prop,eventName[prop]);else _removeEventListener.call(this,eventName,handler);return this}}function fire(eventName,options){if(this.__eventListeners){var listenersForEvent=this.__eventListeners[eventName];if(listenersForEvent){for(var i=0,len=listenersForEvent.length;i<len;i++)listenersForEvent[i]&&listenersForEvent[i].call(this,options||{});return this.__eventListeners[eventName]=listenersForEvent.filter(function(value){return!1!==value}),this}}}fabric.Observable={observe:observe,stopObserving:stopObserving,fire:fire,on:observe,off:stopObserving,trigger:fire}}(),fabric.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var i=0,length=arguments.length;i<length;i++)this._onObjectAdded(arguments[i]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(object,index,nonSplicing){var objects=this._objects;return nonSplicing?objects[index]=object:objects.splice(index,0,object),this._onObjectAdded&&this._onObjectAdded(object),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var objects=this._objects,index,somethingRemoved=!1,i=0,length=arguments.length;i<length;i++)-1!==(index=objects.indexOf(arguments[i]))&&(somethingRemoved=!0,objects.splice(index,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[i]));return this.renderOnAddRemove&&somethingRemoved&&this.requestRenderAll(),this},forEachObject:function(callback,context){for(var objects=this.getObjects(),i=0,len=objects.length;i<len;i++)callback.call(context,objects[i],i,objects);return this},getObjects:function(type){return void 0===type?this._objects.concat():this._objects.filter(function(o){return o.type===type})},item:function(index){return this._objects[index]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(object){return this._objects.indexOf(object)>-1},complexity:function(){return this._objects.reduce(function(memo,current){return memo+=current.complexity?current.complexity():0},0)}},fabric.CommonMethods={_setOptions:function(options){for(var prop in options)this.set(prop,options[prop])},_initGradient:function(filler,property){!filler||!filler.colorStops||filler instanceof fabric.Gradient||this.set(property,new fabric.Gradient(filler))},_initPattern:function(filler,property,callback){!filler||!filler.source||filler instanceof fabric.Pattern?callback&&callback():this.set(property,new fabric.Pattern(filler,callback))},_initClipping:function(options){if(options.clipTo&&"string"==typeof options.clipTo){var functionBody=fabric.util.getFunctionBody(options.clipTo);void 0!==functionBody&&(this.clipTo=new Function("ctx",functionBody))}},_setObject:function(obj){for(var prop in obj)this._set(prop,obj[prop])},set:function(key,value){return"object"==typeof key?this._setObject(key):"function"==typeof value&&"clipTo"!==key?this._set(key,value(this.get(key))):this._set(key,value),this},_set:function(key,value){this[key]=value},toggle:function(property){var value=this.get(property);return"boolean"==typeof value&&this.set(property,!value),this},get:function(property){return this[property]}},function(global){var sqrt=Math.sqrt,atan2=Math.atan2,pow=Math.pow,abs=Math.abs,PiBy180=Math.PI/180,PiBy2=Math.PI/2;fabric.util={cos:function(angle){if(0===angle)return 1;var angleSlice;switch(angle<0&&(angle=-angle),angle/PiBy2){case 1:case 3:return 0;case 2:return-1}return Math.cos(angle)},sin:function(angle){if(0===angle)return 0;var angleSlice,sign=1;switch(angle<0&&(sign=-1),angle/PiBy2){case 1:return sign;case 2:return 0;case 3:return-sign}return Math.sin(angle)},removeFromArray:function(array,value){var idx=array.indexOf(value);return-1!==idx&&array.splice(idx,1),array},getRandomInt:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},degreesToRadians:function(degrees){return degrees*PiBy180},radiansToDegrees:function(radians){return radians/PiBy180},rotatePoint:function(point,origin,radians){point.subtractEquals(origin);var v=fabric.util.rotateVector(point,radians);return new fabric.Point(v.x,v.y).addEquals(origin)},rotateVector:function(vector,radians){var sin=fabric.util.sin(radians),cos=fabric.util.cos(radians),rx,ry;return{x:vector.x*cos-vector.y*sin,y:vector.x*sin+vector.y*cos}},transformPoint:function(p,t,ignoreOffset){return ignoreOffset?new fabric.Point(t[0]*p.x+t[2]*p.y,t[1]*p.x+t[3]*p.y):new fabric.Point(t[0]*p.x+t[2]*p.y+t[4],t[1]*p.x+t[3]*p.y+t[5])},makeBoundingBoxFromPoints:function(points){var xPoints=[points[0].x,points[1].x,points[2].x,points[3].x],minX=fabric.util.array.min(xPoints),maxX,width=fabric.util.array.max(xPoints)-minX,yPoints=[points[0].y,points[1].y,points[2].y,points[3].y],minY=fabric.util.array.min(yPoints),maxY,height;return{left:minX,top:minY,width:width,height:fabric.util.array.max(yPoints)-minY}},invertTransform:function(t){var a=1/(t[0]*t[3]-t[1]*t[2]),r=[a*t[3],-a*t[1],-a*t[2],a*t[0]],o=fabric.util.transformPoint({x:t[4],y:t[5]},r,!0);return r[4]=-o.x,r[5]=-o.y,r},toFixed:function(number,fractionDigits){return parseFloat(Number(number).toFixed(fractionDigits))},parseUnit:function(value,fontSize){var unit=/\D{0,2}$/.exec(value),number=parseFloat(value);switch(fontSize||(fontSize=fabric.Text.DEFAULT_SVG_FONT_SIZE),unit[0]){case"mm":return number*fabric.DPI/25.4;case"cm":return number*fabric.DPI/2.54;case"in":return number*fabric.DPI;case"pt":return number*fabric.DPI/72;case"pc":return number*fabric.DPI/72*12;case"em":return number*fontSize;default:return number}},falseFunction:function(){return!1},getKlass:function(type,namespace){return type=fabric.util.string.camelize(type.charAt(0).toUpperCase()+type.slice(1)),fabric.util.resolveNamespace(namespace)[type]},getSvgAttributes:function(type){var attributes=["instantiated_by_use","style","id","class"];switch(type){case"linearGradient":attributes=attributes.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":attributes=attributes.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":attributes=attributes.concat(["offset","stop-color","stop-opacity"])}return attributes},resolveNamespace:function(namespace){if(!namespace)return fabric;var parts=namespace.split("."),len=parts.length,i,obj=global||fabric.window;for(i=0;i<len;++i)obj=obj[parts[i]];return obj},loadImage:function(url,callback,context,crossOrigin){if(url){var img=fabric.util.createImage(),onLoadCallback=function(){callback&&callback.call(context,img),img=img.onload=img.onerror=null};img.onload=onLoadCallback,img.onerror=function(){fabric.log("Error loading "+img.src),callback&&callback.call(context,null,!0),img=img.onload=img.onerror=null},0!==url.indexOf("data")&&crossOrigin&&(img.crossOrigin=crossOrigin),"data:image/svg"===url.substring(0,14)&&(img.onload=null,fabric.util.loadImageInDom(img,onLoadCallback)),img.src=url}else callback&&callback.call(context,url)},loadImageInDom:function(img,onLoadCallback){var div=fabric.document.createElement("div");div.style.width=div.style.height="1px",div.style.left=div.style.top="-100%",div.style.position="absolute",div.appendChild(img),fabric.document.querySelector("body").appendChild(div),img.onload=function(){onLoadCallback(),div.parentNode.removeChild(div),div=null}},enlivenObjects:function(objects,callback,namespace,reviver){function onLoaded(){++numLoadedObjects===numTotalObjects&&callback&&callback(enlivenedObjects)}var enlivenedObjects=[],numLoadedObjects=0,numTotalObjects=(objects=objects||[]).length;numTotalObjects?objects.forEach(function(o,index){var klass;o&&o.type?fabric.util.getKlass(o.type,namespace).fromObject(o,function(obj,error){error||(enlivenedObjects[index]=obj),reviver&&reviver(o,obj,error),onLoaded()}):onLoaded()}):callback&&callback(enlivenedObjects)},enlivenPatterns:function(patterns,callback){function onLoaded(){++numLoadedPatterns===numPatterns&&callback&&callback(enlivenedPatterns)}var enlivenedPatterns=[],numLoadedPatterns=0,numPatterns=(patterns=patterns||[]).length;numPatterns?patterns.forEach(function(p,index){p&&p.source?new fabric.Pattern(p,function(pattern){enlivenedPatterns[index]=pattern,onLoaded()}):(enlivenedPatterns[index]=p,onLoaded())}):callback&&callback(enlivenedPatterns)},groupSVGElements:function(elements,options,path){var object;return 1===elements.length?elements[0]:(options&&(options.width&&options.height?options.centerPoint={x:options.width/2,y:options.height/2}:(delete options.width,delete options.height)),object=new fabric.Group(elements,options),void 0!==path&&(object.sourcePath=path),object)},populateWithProperties:function(source,destination,properties){if(properties&&"[object Array]"===Object.prototype.toString.call(properties))for(var i=0,len=properties.length;i<len;i++)properties[i]in source&&(destination[properties[i]]=source[properties[i]])},drawDashedLine:function(ctx,x,y,x2,y2,da){var dx=x2-x,dy=y2-y,len=sqrt(dx*dx+dy*dy),rot=atan2(dy,dx),dc=da.length,di=0,draw=!0;for(ctx.save(),ctx.translate(x,y),ctx.moveTo(0,0),ctx.rotate(rot),x=0;len>x;)(x+=da[di++%dc])>len&&(x=len),ctx[draw?"lineTo":"moveTo"](x,0),draw=!draw;ctx.restore()},createCanvasElement:function(){return fabric.document.createElement("canvas")},copyCanvasElement:function(canvas){var newCanvas=fabric.document.createElement("canvas");return newCanvas.width=canvas.width,newCanvas.height=canvas.height,newCanvas.getContext("2d").drawImage(canvas,0,0),newCanvas},createImage:function(){return fabric.document.createElement("img")},clipContext:function(receiver,ctx){ctx.save(),ctx.beginPath(),receiver.clipTo(ctx),ctx.clip()},multiplyTransformMatrices:function(a,b,is2x2){return[a[0]*b[0]+a[2]*b[1],a[1]*b[0]+a[3]*b[1],a[0]*b[2]+a[2]*b[3],a[1]*b[2]+a[3]*b[3],is2x2?0:a[0]*b[4]+a[2]*b[5]+a[4],is2x2?0:a[1]*b[4]+a[3]*b[5]+a[5]]},qrDecompose:function(a){var angle=atan2(a[1],a[0]),denom=pow(a[0],2)+pow(a[1],2),scaleX=sqrt(denom),scaleY=(a[0]*a[3]-a[2]*a[1])/scaleX,skewX=atan2(a[0]*a[2]+a[1]*a[3],denom);return{angle:angle/PiBy180,scaleX:scaleX,scaleY:scaleY,skewX:skewX/PiBy180,skewY:0,translateX:a[4],translateY:a[5]}},customTransformMatrix:function(scaleX,scaleY,skewX){var skewMatrixX=[1,0,abs(Math.tan(skewX*PiBy180)),1],scaleMatrix=[abs(scaleX),0,0,abs(scaleY)];return fabric.util.multiplyTransformMatrices(scaleMatrix,skewMatrixX,!0)},resetObjectTransform:function(target){target.scaleX=1,target.scaleY=1,target.skewX=0,target.skewY=0,target.flipX=!1,target.flipY=!1,target.rotate(0)},saveObjectTransform:function(target){return{scaleX:target.scaleX,scaleY:target.scaleY,skewX:target.skewX,skewY:target.skewY,angle:target.angle,left:target.left,flipX:target.flipX,flipY:target.flipY,top:target.top}},getFunctionBody:function(fn){return(String(fn).match(/function[^{]*\{([\s\S]*)\}/)||{})[1]},isTransparent:function(ctx,x,y,tolerance){tolerance>0&&(x>tolerance?x-=tolerance:x=0,y>tolerance?y-=tolerance:y=0);var _isTransparent=!0,i,temp,imageData=ctx.getImageData(x,y,2*tolerance||1,2*tolerance||1),l=imageData.data.length;for(i=3;i<l&&!1!==(_isTransparent=(temp=imageData.data[i])<=0);i+=4);return imageData=null,_isTransparent},parsePreserveAspectRatioAttribute:function(attribute){var meetOrSlice="meet",alignX="Mid",alignY="Mid",aspectRatioAttrs=attribute.split(" "),align;return aspectRatioAttrs&&aspectRatioAttrs.length&&("meet"!==(meetOrSlice=aspectRatioAttrs.pop())&&"slice"!==meetOrSlice?(align=meetOrSlice,meetOrSlice="meet"):aspectRatioAttrs.length&&(align=aspectRatioAttrs.pop())),{meetOrSlice:meetOrSlice,alignX:alignX="none"!==align?align.slice(1,4):"none",alignY:alignY="none"!==align?align.slice(5,8):"none"}},clearFabricFontCache:function(fontFamily){(fontFamily=(fontFamily||"").toLowerCase())?fabric.charWidthsCache[fontFamily]&&delete fabric.charWidthsCache[fontFamily]:fabric.charWidthsCache={}},limitDimsByArea:function(ar,maximumArea){var roughWidth=Math.sqrt(maximumArea*ar),perfLimitSizeY=Math.floor(maximumArea/roughWidth);return{x:Math.floor(roughWidth),y:perfLimitSizeY}},capValue:function(min,value,max){return Math.max(min,Math.min(value,max))},findScaleToFit:function(source,destination){return Math.min(destination.width/source.width,destination.height/source.height)},findScaleToCover:function(source,destination){return Math.max(destination.width/source.width,destination.height/source.height)}}}("undefined"!=typeof exports?exports:this),function(){var _join=Array.prototype.join;function arcToSegments(toX,toY,rx,ry,large,sweep,rotateX){var argsString=_join.call(arguments);if(fabric.arcToSegmentsCache[argsString])return fabric.arcToSegmentsCache[argsString];var PI=Math.PI,th=rotateX*PI/180,sinTh=fabric.util.sin(th),cosTh=fabric.util.cos(th),fromX=0,fromY=0,px=-cosTh*toX*.5-sinTh*toY*.5,py=-cosTh*toY*.5+sinTh*toX*.5,rx2=(rx=Math.abs(rx))*rx,ry2=(ry=Math.abs(ry))*ry,py2=py*py,px2=px*px,pl=rx2*ry2-rx2*py2-ry2*px2,root=0;if(pl<0){var s=Math.sqrt(1-pl/(rx2*ry2));rx*=s,ry*=s}else root=(large===sweep?-1:1)*Math.sqrt(pl/(rx2*py2+ry2*px2));var cx=root*rx*py/ry,cy=-root*ry*px/rx,cx1=cosTh*cx-sinTh*cy+.5*toX,cy1=sinTh*cx+cosTh*cy+.5*toY,mTheta=calcVectorAngle(1,0,(px-cx)/rx,(py-cy)/ry),dtheta=calcVectorAngle((px-cx)/rx,(py-cy)/ry,(-px-cx)/rx,(-py-cy)/ry);0===sweep&&dtheta>0?dtheta-=2*PI:1===sweep&&dtheta<0&&(dtheta+=2*PI);for(var segments=Math.ceil(Math.abs(dtheta/PI*2)),result=[],mDelta=dtheta/segments,mT=8/3*Math.sin(mDelta/4)*Math.sin(mDelta/4)/Math.sin(mDelta/2),th3=mTheta+mDelta,i=0;i<segments;i++)result[i]=segmentToBezier(mTheta,th3,cosTh,sinTh,rx,ry,cx1,cy1,mT,fromX,fromY),fromX=result[i][4],fromY=result[i][5],mTheta=th3,th3+=mDelta;return fabric.arcToSegmentsCache[argsString]=result,result}function segmentToBezier(th2,th3,cosTh,sinTh,rx,ry,cx1,cy1,mT,fromX,fromY){var costh2=fabric.util.cos(th2),sinth2=fabric.util.sin(th2),costh3=fabric.util.cos(th3),sinth3=fabric.util.sin(th3),toX=cosTh*rx*costh3-sinTh*ry*sinth3+cx1,toY=sinTh*rx*costh3+cosTh*ry*sinth3+cy1,cp1X,cp1Y,cp2X,cp2Y;return[fromX+mT*(-cosTh*rx*sinth2-sinTh*ry*costh2),fromY+mT*(-sinTh*rx*sinth2+cosTh*ry*costh2),toX+mT*(cosTh*rx*sinth3+sinTh*ry*costh3),toY+mT*(sinTh*rx*sinth3-cosTh*ry*costh3),toX,toY]}function calcVectorAngle(ux,uy,vx,vy){var ta=Math.atan2(uy,ux),tb=Math.atan2(vy,vx);return tb>=ta?tb-ta:2*Math.PI-(ta-tb)}function getBoundsOfCurve(x0,y0,x1,y1,x2,y2,x3,y3){var argsString;if(fabric.cachesBoundsOfCurve&&(argsString=_join.call(arguments),fabric.boundsOfCurveCache[argsString]))return fabric.boundsOfCurveCache[argsString];var sqrt=Math.sqrt,min=Math.min,max=Math.max,abs=Math.abs,tvalues=[],bounds=[[],[]],a,b,c,t,t1,t2,b2ac,sqrtb2ac;b=6*x0-12*x1+6*x2,a=-3*x0+9*x1-9*x2+3*x3,c=3*x1-3*x0;for(var i=0;i<2;++i)if(i>0&&(b=6*y0-12*y1+6*y2,a=-3*y0+9*y1-9*y2+3*y3,c=3*y1-3*y0),abs(a)<1e-12){if(abs(b)<1e-12)continue;0<(t=-c/b)&&t<1&&tvalues.push(t)}else(b2ac=b*b-4*c*a)<0||(0<(t1=(-b+(sqrtb2ac=sqrt(b2ac)))/(2*a))&&t1<1&&tvalues.push(t1),0<(t2=(-b-sqrtb2ac)/(2*a))&&t2<1&&tvalues.push(t2));for(var x,y,j=tvalues.length,jlen=j,mt;j--;)x=(mt=1-(t=tvalues[j]))*mt*mt*x0+3*mt*mt*t*x1+3*mt*t*t*x2+t*t*t*x3,bounds[0][j]=x,y=mt*mt*mt*y0+3*mt*mt*t*y1+3*mt*t*t*y2+t*t*t*y3,bounds[1][j]=y;bounds[0][jlen]=x0,bounds[1][jlen]=y0,bounds[0][jlen+1]=x3,bounds[1][jlen+1]=y3;var result=[{x:min.apply(null,bounds[0]),y:min.apply(null,bounds[1])},{x:max.apply(null,bounds[0]),y:max.apply(null,bounds[1])}];return fabric.cachesBoundsOfCurve&&(fabric.boundsOfCurveCache[argsString]=result),result}fabric.util.drawArc=function(ctx,fx,fy,coords){for(var rx=coords[0],ry=coords[1],rot=coords[2],large=coords[3],sweep=coords[4],tx,ty,segs=[[],[],[],[]],segsNorm=arcToSegments(coords[5]-fx,coords[6]-fy,rx,ry,large,sweep,rot),i=0,len=segsNorm.length;i<len;i++)segs[i][0]=segsNorm[i][0]+fx,segs[i][1]=segsNorm[i][1]+fy,segs[i][2]=segsNorm[i][2]+fx,segs[i][3]=segsNorm[i][3]+fy,segs[i][4]=segsNorm[i][4]+fx,segs[i][5]=segsNorm[i][5]+fy,ctx.bezierCurveTo.apply(ctx,segs[i])},fabric.util.getBoundsOfArc=function(fx,fy,rx,ry,rot,large,sweep,tx,ty){for(var fromX=0,fromY=0,bound,bounds=[],segs=arcToSegments(tx-fx,ty-fy,rx,ry,large,sweep,rot),i=0,len=segs.length;i<len;i++)bound=getBoundsOfCurve(fromX,fromY,segs[i][0],segs[i][1],segs[i][2],segs[i][3],segs[i][4],segs[i][5]),bounds.push({x:bound[0].x+fx,y:bound[0].y+fy}),bounds.push({x:bound[1].x+fx,y:bound[1].y+fy}),fromX=segs[i][4],fromY=segs[i][5];return bounds},fabric.util.getBoundsOfCurve=getBoundsOfCurve}(),function(){var slice=Array.prototype.slice;function invoke(array,method){for(var args=slice.call(arguments,2),result=[],i=0,len=array.length;i<len;i++)result[i]=args.length?array[i][method].apply(array[i],args):array[i][method].call(array[i]);return result}function max(array,byProperty){return find(array,byProperty,function(value1,value2){return value1>=value2})}function min(array,byProperty){return find(array,byProperty,function(value1,value2){return value1<value2})}function fill(array,value){for(var k=array.length;k--;)array[k]=value;return array}function find(array,byProperty,condition){if(array&&0!==array.length){var i=array.length-1,result=byProperty?array[i][byProperty]:array[i];if(byProperty)for(;i--;)condition(array[i][byProperty],result)&&(result=array[i][byProperty]);else for(;i--;)condition(array[i],result)&&(result=array[i]);return result}}fabric.util.array={fill:fill,invoke:invoke,min:min,max:max}}(),function(){function extend(destination,source,deep){if(deep)if(!fabric.isLikelyNode&&source instanceof Element)destination=source;else if(source instanceof Array){destination=[];for(var i=0,len=source.length;i<len;i++)destination[i]=extend({},source[i],deep)}else if(source&&"object"==typeof source)for(var property in source)source.hasOwnProperty(property)&&(destination[property]=extend({},source[property],deep));else destination=source;else for(var property in source)destination[property]=source[property];return destination}function clone(object,deep){return extend({},object,deep)}fabric.util.object={extend:extend,clone:clone},fabric.util.object.extend(fabric.util,fabric.Observable)}(),function(){function camelize(string){return string.replace(/-+(.)?/g,function(match,character){return character?character.toUpperCase():""})}function capitalize(string,firstLetterOnly){return string.charAt(0).toUpperCase()+(firstLetterOnly?string.slice(1):string.slice(1).toLowerCase())}function escapeXml(string){return string.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function graphemeSplit(textstring){var i=0,chr,graphemes=[];for(i=0;i<textstring.length;i++)!1!==(chr=getWholeChar(textstring,i))&&graphemes.push(chr);return graphemes}function getWholeChar(str,i){var code=str.charCodeAt(i);if(isNaN(code))return"";if(code<55296||code>57343)return str.charAt(i);if(55296<=code&&code<=56319){if(str.length<=i+1)throw"High surrogate without following low surrogate";var next=str.charCodeAt(i+1);if(56320>next||next>57343)throw"High surrogate without following low surrogate";return str.charAt(i)+str.charAt(i+1)}if(0===i)throw"Low surrogate without preceding high surrogate";var prev=str.charCodeAt(i-1);if(55296>prev||prev>56319)throw"Low surrogate without preceding high surrogate";return!1}fabric.util.string={camelize:camelize,capitalize:capitalize,escapeXml:escapeXml,graphemeSplit:graphemeSplit}}(),function(){var slice=Array.prototype.slice,emptyFunction=function(){},IS_DONTENUM_BUGGY=function(){for(var p in{toString:1})if("toString"===p)return!1;return!0}(),addMethods=function(klass,source,parent){for(var property in source)property in klass.prototype&&"function"==typeof klass.prototype[property]&&(source[property]+"").indexOf("callSuper")>-1?klass.prototype[property]=function(property){return function(){var superclass=this.constructor.superclass;this.constructor.superclass=parent;var returnValue=source[property].apply(this,arguments);if(this.constructor.superclass=superclass,"initialize"!==property)return returnValue}}(property):klass.prototype[property]=source[property],IS_DONTENUM_BUGGY&&(source.toString!==Object.prototype.toString&&(klass.prototype.toString=source.toString),source.valueOf!==Object.prototype.valueOf&&(klass.prototype.valueOf=source.valueOf))};function Subclass(){}function callSuper(methodName){for(var parentMethod=null,_this=this;_this.constructor.superclass;){var superClassMethod=_this.constructor.superclass.prototype[methodName];if(_this[methodName]!==superClassMethod){parentMethod=superClassMethod;break}_this=_this.constructor.superclass.prototype}return parentMethod?arguments.length>1?parentMethod.apply(this,slice.call(arguments,1)):parentMethod.call(this):console.log("tried to callSuper "+methodName+", method not found in prototype chain",this)}function createClass(){var parent=null,properties=slice.call(arguments,0);function klass(){this.initialize.apply(this,arguments)}"function"==typeof properties[0]&&(parent=properties.shift()),klass.superclass=parent,klass.subclasses=[],parent&&(Subclass.prototype=parent.prototype,klass.prototype=new Subclass,parent.subclasses.push(klass));for(var i=0,length=properties.length;i<length;i++)addMethods(klass,properties[i],parent);return klass.prototype.initialize||(klass.prototype.initialize=emptyFunction),klass.prototype.constructor=klass,klass.prototype.callSuper=callSuper,klass}fabric.util.createClass=createClass}(),function(){var unknown="unknown";function areHostMethods(object){var methodNames=Array.prototype.slice.call(arguments,1),t,i,len=methodNames.length;for(i=0;i<len;i++)if(t=typeof object[methodNames[i]],!/^(?:function|object|unknown)$/.test(t))return!1;return!0}var getElement,setElement,getUniqueId=(uid=0,function(element){return element.__uniqueID||(element.__uniqueID="uniqueID__"+uid++)}),uid,elements;function createListener(uid,handler){return{handler:handler,wrappedHandler:createWrappedHandler(uid,handler)}}function createWrappedHandler(uid,handler){return function(e){handler.call(getElement(uid),e||fabric.window.event)}}function createDispatcher(uid,eventName){return function(e){if(handlers[uid]&&handlers[uid][eventName])for(var handlersForEvent=handlers[uid][eventName],i=0,len=handlersForEvent.length;i<len;i++)handlersForEvent[i].call(this,e||fabric.window.event)}}elements={},getElement=function(uid){return elements[uid]},setElement=function(uid,element){elements[uid]=element};var shouldUseAddListenerRemoveListener=areHostMethods(fabric.document.documentElement,"addEventListener","removeEventListener")&&areHostMethods(fabric.window,"addEventListener","removeEventListener"),shouldUseAttachEventDetachEvent=areHostMethods(fabric.document.documentElement,"attachEvent","detachEvent")&&areHostMethods(fabric.window,"attachEvent","detachEvent"),listeners={},handlers={},addListener,removeListener;function getPointer(event){event||(event=fabric.window.event);var element=event.target||(typeof event.srcElement!==unknown?event.srcElement:null),scroll=fabric.util.getScrollLeftTop(element);return{x:pointerX(event)+scroll.left,y:pointerY(event)+scroll.top}}shouldUseAddListenerRemoveListener?(addListener=function(element,eventName,handler,options){element&&element.addEventListener(eventName,handler,!shouldUseAttachEventDetachEvent&&options)},removeListener=function(element,eventName,handler,options){element&&element.removeEventListener(eventName,handler,!shouldUseAttachEventDetachEvent&&options)}):shouldUseAttachEventDetachEvent?(addListener=function(element,eventName,handler){if(element){var uid=getUniqueId(element);setElement(uid,element),listeners[uid]||(listeners[uid]={}),listeners[uid][eventName]||(listeners[uid][eventName]=[]);var listener=createListener(uid,handler);listeners[uid][eventName].push(listener),element.attachEvent("on"+eventName,listener.wrappedHandler)}},removeListener=function(element,eventName,handler){if(element){var uid=getUniqueId(element),listener;if(listeners[uid]&&listeners[uid][eventName])for(var i=0,len=listeners[uid][eventName].length;i<len;i++)(listener=listeners[uid][eventName][i])&&listener.handler===handler&&(element.detachEvent("on"+eventName,listener.wrappedHandler),listeners[uid][eventName][i]=null)}}):(addListener=function(element,eventName,handler){if(element){var uid=getUniqueId(element);if(handlers[uid]||(handlers[uid]={}),!handlers[uid][eventName]){handlers[uid][eventName]=[];var existingHandler=element["on"+eventName];existingHandler&&handlers[uid][eventName].push(existingHandler),element["on"+eventName]=createDispatcher(uid,eventName)}handlers[uid][eventName].push(handler)}},removeListener=function(element,eventName,handler){if(element){var uid=getUniqueId(element);if(handlers[uid]&&handlers[uid][eventName])for(var handlersForEvent=handlers[uid][eventName],i=0,len=handlersForEvent.length;i<len;i++)handlersForEvent[i]===handler&&handlersForEvent.splice(i,1)}}),fabric.util.addListener=addListener,fabric.util.removeListener=removeListener;var pointerX=function(event){return event.clientX},pointerY=function(event){return event.clientY};function _getPointer(event,pageProp,clientProp){var touchProp,pointer,eventTouchProp=event["touchend"===event.type?"changedTouches":"touches"];return eventTouchProp&&eventTouchProp[0]&&(pointer=eventTouchProp[0][clientProp]),void 0===pointer&&(pointer=event[clientProp]),pointer}fabric.isTouchSupported&&(pointerX=function(event){return _getPointer(event,"pageX","clientX")},pointerY=function(event){return _getPointer(event,"pageY","clientY")}),fabric.util.getPointer=getPointer}(),function(){function setStyle(element,styles){var elementStyle=element.style;if(!elementStyle)return element;if("string"==typeof styles)return element.style.cssText+=";"+styles,styles.indexOf("opacity")>-1?setOpacity(element,styles.match(/opacity:\s*(\d?\.?\d*)/)[1]):element;for(var property in styles){var normalizedProperty;if("opacity"===property)setOpacity(element,styles[property]);else elementStyle["float"===property||"cssFloat"===property?void 0===elementStyle.styleFloat?"cssFloat":"styleFloat":property]=styles[property]}return element}var parseEl=fabric.document.createElement("div"),supportsOpacity="string"==typeof parseEl.style.opacity,supportsFilters="string"==typeof parseEl.style.filter,reOpacity=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,setOpacity=function(element){return element};supportsOpacity?setOpacity=function(element,value){return element.style.opacity=value,element}:supportsFilters&&(setOpacity=function(element,value){var es=element.style;return element.currentStyle&&!element.currentStyle.hasLayout&&(es.zoom=1),reOpacity.test(es.filter)?(value=value>=.9999?"":"alpha(opacity="+100*value+")",es.filter=es.filter.replace(reOpacity,value)):es.filter+=" alpha(opacity="+100*value+")",element}),fabric.util.setStyle=setStyle}(),function(){var _slice=Array.prototype.slice;function getById(id){return"string"==typeof id?fabric.document.getElementById(id):id}var sliceCanConvertNodelists,toArray=function(arrayLike){return _slice.call(arrayLike,0)},getElementStyle;try{sliceCanConvertNodelists=toArray(fabric.document.childNodes)instanceof Array}catch(err){}function makeElement(tagName,attributes){var el=fabric.document.createElement(tagName);for(var prop in attributes)"class"===prop?el.className=attributes[prop]:"for"===prop?el.htmlFor=attributes[prop]:el.setAttribute(prop,attributes[prop]);return el}function addClass(element,className){element&&-1===(" "+element.className+" ").indexOf(" "+className+" ")&&(element.className+=(element.className?" ":"")+className)}function wrapElement(element,wrapper,attributes){return"string"==typeof wrapper&&(wrapper=makeElement(wrapper,attributes)),element.parentNode&&element.parentNode.replaceChild(wrapper,element),wrapper.appendChild(element),wrapper}function getScrollLeftTop(element){for(var left=0,top=0,docElement=fabric.document.documentElement,body=fabric.document.body||{scrollLeft:0,scrollTop:0};element&&(element.parentNode||element.host)&&((element=element.parentNode||element.host)===fabric.document?(left=body.scrollLeft||docElement.scrollLeft||0,top=body.scrollTop||docElement.scrollTop||0):(left+=element.scrollLeft||0,top+=element.scrollTop||0),1!==element.nodeType||"fixed"!==element.style.position););return{left:left,top:top}}function getElementOffset(element){var docElem,doc=element&&element.ownerDocument,box={left:0,top:0},offset={left:0,top:0},scrollLeftTop,offsetAttributes={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!doc)return offset;for(var attr in offsetAttributes)offset[offsetAttributes[attr]]+=parseInt(getElementStyle(element,attr),10)||0;return docElem=doc.documentElement,void 0!==element.getBoundingClientRect&&(box=element.getBoundingClientRect()),scrollLeftTop=getScrollLeftTop(element),{left:box.left+scrollLeftTop.left-(docElem.clientLeft||0)+offset.left,top:box.top+scrollLeftTop.top-(docElem.clientTop||0)+offset.top}}function getNodeCanvas(element){var impl=fabric.jsdomImplForWrapper(element);return impl._canvas||impl._image}function cleanUpJsdomNode(element){if(fabric.isLikelyNode){var impl=fabric.jsdomImplForWrapper(element);impl&&(impl._image=null,impl._canvas=null,impl._currentSrc=null,impl._attributes=null,impl._classList=null)}}sliceCanConvertNodelists||(toArray=function(arrayLike){for(var arr=new Array(arrayLike.length),i=arrayLike.length;i--;)arr[i]=arrayLike[i];return arr}),getElementStyle=fabric.document.defaultView&&fabric.document.defaultView.getComputedStyle?function(element,attr){var style=fabric.document.defaultView.getComputedStyle(element,null);return style?style[attr]:void 0}:function(element,attr){var value=element.style[attr];return!value&&element.currentStyle&&(value=element.currentStyle[attr]),value},function(){var style=fabric.document.documentElement.style,selectProp="userSelect"in style?"userSelect":"MozUserSelect"in style?"MozUserSelect":"WebkitUserSelect"in style?"WebkitUserSelect":"KhtmlUserSelect"in style?"KhtmlUserSelect":"";function makeElementUnselectable(element){return void 0!==element.onselectstart&&(element.onselectstart=fabric.util.falseFunction),selectProp?element.style[selectProp]="none":"string"==typeof element.unselectable&&(element.unselectable="on"),element}function makeElementSelectable(element){return void 0!==element.onselectstart&&(element.onselectstart=null),selectProp?element.style[selectProp]="":"string"==typeof element.unselectable&&(element.unselectable=""),element}fabric.util.makeElementUnselectable=makeElementUnselectable,fabric.util.makeElementSelectable=makeElementSelectable}(),function(){function getScript(url,callback){var headEl=fabric.document.getElementsByTagName("head")[0],scriptEl=fabric.document.createElement("script"),loading=!0;scriptEl.onload=scriptEl.onreadystatechange=function(e){if(loading){if("string"==typeof this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState)return;loading=!1,callback(e||fabric.window.event),scriptEl=scriptEl.onload=scriptEl.onreadystatechange=null}},scriptEl.src=url,headEl.appendChild(scriptEl)}fabric.util.getScript=getScript}(),fabric.util.getById=getById,fabric.util.toArray=toArray,fabric.util.makeElement=makeElement,fabric.util.addClass=addClass,fabric.util.wrapElement=wrapElement,fabric.util.getScrollLeftTop=getScrollLeftTop,fabric.util.getElementOffset=getElementOffset,fabric.util.getElementStyle=getElementStyle,fabric.util.getNodeCanvas=getNodeCanvas,fabric.util.cleanUpJsdomNode=cleanUpJsdomNode}(),function(){function addParamToUrl(url,param){return url+(/\?/.test(url)?"&":"?")+param}var makeXHR=function(){for(var factories=[function(){return new fabric.window.XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP.3.0")}],i=factories.length;i--;)try{var req;if(factories[i]())return factories[i]}catch(err){}}();function emptyFn(){}function request(url,options){options||(options={});var method=options.method?options.method.toUpperCase():"GET",onComplete=options.onComplete||function(){},xhr=new fabric.window.XMLHttpRequest,body=options.body||options.parameters;return xhr.onreadystatechange=function(){4===xhr.readyState&&(onComplete(xhr),xhr.onreadystatechange=emptyFn)},"GET"===method&&(body=null,"string"==typeof options.parameters&&(url=addParamToUrl(url,options.parameters))),xhr.open(method,url,!0),"POST"!==method&&"PUT"!==method||xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(body),xhr}fabric.util.request=request}(),fabric.log=function(){},fabric.warn=function(){},"undefined"!=typeof console&&["log","warn"].forEach(function(methodName){void 0!==console[methodName]&&"function"==typeof console[methodName].apply&&(fabric[methodName]=function(){return console[methodName].apply(console,arguments)})}),function(){function noop(){return!1}function animate(options){requestAnimFrame(function(timestamp){options||(options={});var start=timestamp||+new Date,duration=options.duration||500,finish=start+duration,time,onChange=options.onChange||noop,abort=options.abort||noop,onComplete=options.onComplete||noop,easing=options.easing||function(t,b,c,d){return-c*Math.cos(t/d*(Math.PI/2))+c+b},startValue="startValue"in options?options.startValue:0,endValue="endValue"in options?options.endValue:100,byValue=options.byValue||endValue-startValue;options.onStart&&options.onStart(),function tick(ticktime){if(abort())onComplete(endValue,1,1);else{var currentTime=(time=ticktime||+new Date)>finish?duration:time-start,timePerc=currentTime/duration,current=easing(currentTime,startValue,byValue,duration),valuePerc=Math.abs((current-startValue)/byValue);onChange(current,valuePerc,timePerc),time>finish?options.onComplete&&options.onComplete():requestAnimFrame(tick)}}(start)})}var _requestAnimFrame=fabric.window.requestAnimationFrame||fabric.window.webkitRequestAnimationFrame||fabric.window.mozRequestAnimationFrame||fabric.window.oRequestAnimationFrame||fabric.window.msRequestAnimationFrame||function(callback){return fabric.window.setTimeout(callback,1e3/60)},_cancelAnimFrame=fabric.window.cancelAnimationFrame||fabric.window.clearTimeout;function requestAnimFrame(){return _requestAnimFrame.apply(fabric.window,arguments)}function cancelAnimFrame(){return _cancelAnimFrame.apply(fabric.window,arguments)}fabric.util.animate=animate,fabric.util.requestAnimFrame=requestAnimFrame,fabric.util.cancelAnimFrame=cancelAnimFrame}(),function(){function calculateColor(begin,end,pos){var color="rgba("+parseInt(begin[0]+pos*(end[0]-begin[0]),10)+","+parseInt(begin[1]+pos*(end[1]-begin[1]),10)+","+parseInt(begin[2]+pos*(end[2]-begin[2]),10);return color+=","+(begin&&end?parseFloat(begin[3]+pos*(end[3]-begin[3])):1),color+=")"}function animateColor(fromColor,toColor,duration,options){var startColor=new fabric.Color(fromColor).getSource(),endColor=new fabric.Color(toColor).getSource();options=options||{},fabric.util.animate(fabric.util.object.extend(options,{duration:duration||500,startValue:startColor,endValue:endColor,byValue:endColor,easing:function(currentTime,startValue,byValue,duration){var posValue;return calculateColor(startValue,byValue,options.colorEasing?options.colorEasing(currentTime,duration):1-Math.cos(currentTime/duration*(Math.PI/2)))}}))}fabric.util.animateColor=animateColor}(),function(){function normalize(a,c,p,s){return a<Math.abs(c)?(a=c,s=p/4):s=0===c&&0===a?p/(2*Math.PI)*Math.asin(1):p/(2*Math.PI)*Math.asin(c/a),{a:a,c:c,p:p,s:s}}function elastic(opts,t,d){return opts.a*Math.pow(2,10*(t-=1))*Math.sin((t*d-opts.s)*(2*Math.PI)/opts.p)}function easeOutCubic(t,b,c,d){return c*((t=t/d-1)*t*t+1)+b}function easeInOutCubic(t,b,c,d){return(t/=d/2)<1?c/2*t*t*t+b:c/2*((t-=2)*t*t+2)+b}function easeInQuart(t,b,c,d){return c*(t/=d)*t*t*t+b}function easeOutQuart(t,b,c,d){return-c*((t=t/d-1)*t*t*t-1)+b}function easeInOutQuart(t,b,c,d){return(t/=d/2)<1?c/2*t*t*t*t+b:-c/2*((t-=2)*t*t*t-2)+b}function easeInQuint(t,b,c,d){return c*(t/=d)*t*t*t*t+b}function easeOutQuint(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b}function easeInOutQuint(t,b,c,d){return(t/=d/2)<1?c/2*t*t*t*t*t+b:c/2*((t-=2)*t*t*t*t+2)+b}function easeInSine(t,b,c,d){return-c*Math.cos(t/d*(Math.PI/2))+c+b}function easeOutSine(t,b,c,d){return c*Math.sin(t/d*(Math.PI/2))+b}function easeInOutSine(t,b,c,d){return-c/2*(Math.cos(Math.PI*t/d)-1)+b}function easeInExpo(t,b,c,d){return 0===t?b:c*Math.pow(2,10*(t/d-1))+b}function easeOutExpo(t,b,c,d){return t===d?b+c:c*(1-Math.pow(2,-10*t/d))+b}function easeInOutExpo(t,b,c,d){return 0===t?b:t===d?b+c:(t/=d/2)<1?c/2*Math.pow(2,10*(t-1))+b:c/2*(2-Math.pow(2,-10*--t))+b}function easeInCirc(t,b,c,d){return-c*(Math.sqrt(1-(t/=d)*t)-1)+b}function easeOutCirc(t,b,c,d){return c*Math.sqrt(1-(t=t/d-1)*t)+b}function easeInOutCirc(t,b,c,d){return(t/=d/2)<1?-c/2*(Math.sqrt(1-t*t)-1)+b:c/2*(Math.sqrt(1-(t-=2)*t)+1)+b}function easeInElastic(t,b,c,d){var s,p=0,a,opts;return 0===t?b:1===(t/=d)?b+c:(p||(p=.3*d),-elastic(normalize(c,c,p,1.70158),t,d)+b)}function easeOutElastic(t,b,c,d){var s,p=0,a;if(0===t)return b;if(1===(t/=d))return b+c;p||(p=.3*d);var opts=normalize(c,c,p,1.70158);return opts.a*Math.pow(2,-10*t)*Math.sin((t*d-opts.s)*(2*Math.PI)/opts.p)+opts.c+b}function easeInOutElastic(t,b,c,d){var s,p=0,a;if(0===t)return b;if(2===(t/=d/2))return b+c;p||(p=d*(.3*1.5));var opts=normalize(c,c,p,1.70158);return t<1?-.5*elastic(opts,t,d)+b:opts.a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-opts.s)*(2*Math.PI)/opts.p)*.5+opts.c+b}function easeInBack(t,b,c,d,s){return void 0===s&&(s=1.70158),c*(t/=d)*t*((s+1)*t-s)+b}function easeOutBack(t,b,c,d,s){return void 0===s&&(s=1.70158),c*((t=t/d-1)*t*((s+1)*t+s)+1)+b}function easeInOutBack(t,b,c,d,s){return void 0===s&&(s=1.70158),(t/=d/2)<1?c/2*(t*t*((1+(s*=1.525))*t-s))+b:c/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+b}function easeInBounce(t,b,c,d){return c-easeOutBounce(d-t,0,c,d)+b}function easeOutBounce(t,b,c,d){return(t/=d)<1/2.75?c*(7.5625*t*t)+b:t<2/2.75?c*(7.5625*(t-=1.5/2.75)*t+.75)+b:t<2.5/2.75?c*(7.5625*(t-=2.25/2.75)*t+.9375)+b:c*(7.5625*(t-=2.625/2.75)*t+.984375)+b}function easeInOutBounce(t,b,c,d){return t<d/2?.5*easeInBounce(2*t,0,c,d)+b:.5*easeOutBounce(2*t-d,0,c,d)+.5*c+b}fabric.util.ease={easeInQuad:function(t,b,c,d){return c*(t/=d)*t+b},easeOutQuad:function(t,b,c,d){return-c*(t/=d)*(t-2)+b},easeInOutQuad:function(t,b,c,d){return(t/=d/2)<1?c/2*t*t+b:-c/2*(--t*(t-2)-1)+b},easeInCubic:function(t,b,c,d){return c*(t/=d)*t*t+b},easeOutCubic:easeOutCubic,easeInOutCubic:easeInOutCubic,easeInQuart:easeInQuart,easeOutQuart:easeOutQuart,easeInOutQuart:easeInOutQuart,easeInQuint:easeInQuint,easeOutQuint:easeOutQuint,easeInOutQuint:easeInOutQuint,easeInSine:easeInSine,easeOutSine:easeOutSine,easeInOutSine:easeInOutSine,easeInExpo:easeInExpo,easeOutExpo:easeOutExpo,easeInOutExpo:easeInOutExpo,easeInCirc:easeInCirc,easeOutCirc:easeOutCirc,easeInOutCirc:easeInOutCirc,easeInElastic:easeInElastic,easeOutElastic:easeOutElastic,easeInOutElastic:easeInOutElastic,easeInBack:easeInBack,easeOutBack:easeOutBack,easeInOutBack:easeInOutBack,easeInBounce:easeInBounce,easeOutBounce:easeOutBounce,easeInOutBounce:easeInOutBounce}}(),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,clone=fabric.util.object.clone,toFixed=fabric.util.toFixed,parseUnit=fabric.util.parseUnit,multiplyTransformMatrices=fabric.util.multiplyTransformMatrices,svgValidTagNames=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],svgViewBoxElements=["symbol","image","marker","pattern","view","svg"],svgInvalidAncestors=["pattern","defs","symbol","metadata","clipPath","mask","desc"],svgValidParents=["symbol","g","a","svg","clipPath","defs"],attributesMap={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule"},colorAttributes={stroke:"strokeOpacity",fill:"fillOpacity"};function normalizeAttr(attr){return attr in attributesMap?attributesMap[attr]:attr}function normalizeValue(attr,value,parentAttributes,fontSize){var isArray="[object Array]"===Object.prototype.toString.call(value),parsed;if("fill"!==attr&&"stroke"!==attr||"none"!==value)if("strokeDashArray"===attr)value="none"===value?null:value.replace(/,/g," ").split(/\s+/).map(function(n){return parseFloat(n)});else if("transformMatrix"===attr)value=parentAttributes&&parentAttributes.transformMatrix?multiplyTransformMatrices(parentAttributes.transformMatrix,fabric.parseTransformAttribute(value)):fabric.parseTransformAttribute(value);else if("visible"===attr)value="none"!==value&&"hidden"!==value,parentAttributes&&!1===parentAttributes.visible&&(value=!1);else if("opacity"===attr)value=parseFloat(value),parentAttributes&&void 0!==parentAttributes.opacity&&(value*=parentAttributes.opacity);else if("textAnchor"===attr)value="start"===value?"left":"end"===value?"right":"center";else if("charSpacing"===attr)parsed=parseUnit(value,fontSize)/fontSize*1e3;else if("paintFirst"===attr){var fillIndex=value.indexOf("fill"),strokeIndex=value.indexOf("stroke"),value="fill";fillIndex>-1&&strokeIndex>-1&&strokeIndex<fillIndex?value="stroke":-1===fillIndex&&strokeIndex>-1&&(value="stroke")}else parsed=isArray?value.map(parseUnit):parseUnit(value,fontSize);else value="";return!isArray&&isNaN(parsed)?value:parsed}function getSvgRegex(arr){return new RegExp("^("+arr.join("|")+")\\b","i")}function _setStrokeFillOpacity(attributes){for(var attr in colorAttributes)if(void 0!==attributes[colorAttributes[attr]]&&""!==attributes[attr]){if(void 0===attributes[attr]){if(!fabric.Object.prototype[attr])continue;attributes[attr]=fabric.Object.prototype[attr]}if(0!==attributes[attr].indexOf("url(")){var color=new fabric.Color(attributes[attr]);attributes[attr]=color.setAlpha(toFixed(color.getAlpha()*attributes[colorAttributes[attr]],2)).toRgba()}}return attributes}function _getMultipleNodes(doc,nodeNames){var nodeName,nodeArray=[],nodeList,i,len;for(i=0,len=nodeNames.length;i<len;i++)nodeName=nodeNames[i],nodeList=doc.getElementsByTagName(nodeName),nodeArray=nodeArray.concat(Array.prototype.slice.call(nodeList));return nodeArray}function parseStyleString(style,oStyle){var attr,value;style.replace(/;\s*$/,"").split(";").forEach(function(chunk){var pair=chunk.split(":");attr=pair[0].trim().toLowerCase(),value=pair[1].trim(),oStyle[attr]=value})}function parseStyleObject(style,oStyle){var attr,value;for(var prop in style)void 0!==style[prop]&&(attr=prop.toLowerCase(),value=style[prop],oStyle[attr]=value)}function getGlobalStylesForElement(element,svgUid){var styles={};for(var rule in fabric.cssRules[svgUid])if(elementMatchesRule(element,rule.split(" ")))for(var property in fabric.cssRules[svgUid][rule])styles[property]=fabric.cssRules[svgUid][rule][property];return styles}function elementMatchesRule(element,selectors){var firstMatching,parentMatching=!0;return(firstMatching=selectorMatches(element,selectors.pop()))&&selectors.length&&(parentMatching=doesSomeParentMatch(element,selectors)),firstMatching&&parentMatching&&0===selectors.length}function doesSomeParentMatch(element,selectors){for(var selector,parentMatching=!0;element.parentNode&&1===element.parentNode.nodeType&&selectors.length;)parentMatching&&(selector=selectors.pop()),parentMatching=selectorMatches(element=element.parentNode,selector);return 0===selectors.length}function selectorMatches(element,selector){var nodeName=element.nodeName,classNames=element.getAttribute("class"),id=element.getAttribute("id"),matcher,i;if(matcher=new RegExp("^"+nodeName,"i"),selector=selector.replace(matcher,""),id&&selector.length&&(matcher=new RegExp("#"+id+"(?![a-zA-Z\\-]+)","i"),selector=selector.replace(matcher,"")),classNames&&selector.length)for(i=(classNames=classNames.split(" ")).length;i--;)matcher=new RegExp("\\."+classNames[i]+"(?![a-zA-Z\\-]+)","i"),selector=selector.replace(matcher,"");return 0===selector.length}function elementById(doc,id){var el;if(doc.getElementById&&(el=doc.getElementById(id)),el)return el;var node,i,len,nodelist=doc.getElementsByTagName("*");for(i=0,len=nodelist.length;i<len;i++)if(id===(node=nodelist[i]).getAttribute("id"))return node}function parseUseDirectives(doc){for(var nodelist=_getMultipleNodes(doc,["use","svg:use"]),i=0;nodelist.length&&i<nodelist.length;){var el=nodelist[i],xlink=(el.getAttribute("xlink:href")||el.getAttribute("href")).substr(1),x=el.getAttribute("x")||0,y=el.getAttribute("y")||0,el2=elementById(doc,xlink).cloneNode(!0),currentTrans=(el2.getAttribute("transform")||"")+" translate("+x+", "+y+")",parentNode,oldLength=nodelist.length,attr,j,attrs,len;if(applyViewboxTransform(el2),/^svg$/i.test(el2.nodeName)){var el3=el2.ownerDocument.createElement("g");for(j=0,len=(attrs=el2.attributes).length;j<len;j++)attr=attrs.item(j),el3.setAttribute(attr.nodeName,attr.nodeValue);for(;el2.firstChild;)el3.appendChild(el2.firstChild);el2=el3}for(j=0,len=(attrs=el.attributes).length;j<len;j++)"x"!==(attr=attrs.item(j)).nodeName&&"y"!==attr.nodeName&&"xlink:href"!==attr.nodeName&&"href"!==attr.nodeName&&("transform"===attr.nodeName?currentTrans=attr.nodeValue+" "+currentTrans:el2.setAttribute(attr.nodeName,attr.nodeValue));el2.setAttribute("transform",currentTrans),el2.setAttribute("instantiated_by_use","1"),el2.removeAttribute("id"),(parentNode=el.parentNode).replaceChild(el2,el),nodelist.length===oldLength&&i++}}fabric.svgValidTagNamesRegEx=getSvgRegex(svgValidTagNames),fabric.svgViewBoxElementsRegEx=getSvgRegex(svgViewBoxElements),fabric.svgInvalidAncestorsRegEx=getSvgRegex(svgInvalidAncestors),fabric.svgValidParentsRegEx=getSvgRegex(svgValidParents),fabric.cssRules={},fabric.gradientDefs={},fabric.clipPaths={},fabric.parseTransformAttribute=function(){function rotateMatrix(matrix,args){var cos=fabric.util.cos(args[0]),sin=fabric.util.sin(args[0]),x=0,y=0;3===args.length&&(x=args[1],y=args[2]),matrix[0]=cos,matrix[1]=sin,matrix[2]=-sin,matrix[3]=cos,matrix[4]=x-(cos*x-sin*y),matrix[5]=y-(sin*x+cos*y)}function scaleMatrix(matrix,args){var multiplierX=args[0],multiplierY=2===args.length?args[1]:args[0];matrix[0]=multiplierX,matrix[3]=multiplierY}function skewMatrix(matrix,args,pos){matrix[pos]=Math.tan(fabric.util.degreesToRadians(args[0]))}function translateMatrix(matrix,args){matrix[4]=args[0],2===args.length&&(matrix[5]=args[1])}var iMatrix=[1,0,0,1,0,0],number=fabric.reNum,commaWsp="(?:\\s+,?\\s*|,\\s*)",skewX,skewY,rotate,scale,translate,matrix,transform="(?:"+("(?:(matrix)\\s*\\(\\s*("+number+")"+commaWsp+"("+number+")"+commaWsp+"("+number+")"+commaWsp+"("+number+")"+commaWsp+"("+number+")"+commaWsp+"("+number+")\\s*\\))")+"|"+("(?:(translate)\\s*\\(\\s*("+number+")(?:"+commaWsp+"("+number+"))?\\s*\\))")+"|"+("(?:(scale)\\s*\\(\\s*("+number+")(?:"+commaWsp+"("+number+"))?\\s*\\))")+"|"+("(?:(rotate)\\s*\\(\\s*("+number+")(?:"+commaWsp+"("+number+")"+commaWsp+"("+number+"))?\\s*\\))")+"|"+("(?:(skewX)\\s*\\(\\s*("+number+")\\s*\\))")+"|"+("(?:(skewY)\\s*\\(\\s*("+number+")\\s*\\))")+")",transforms,transformList,reTransformList=new RegExp("^\\s*(?:"+("(?:"+transform+"(?:"+commaWsp+"*"+transform+")*)")+"?)\\s*$"),reTransform=new RegExp(transform,"g");return function(attributeValue){var matrix=iMatrix.concat(),matrices=[];if(!attributeValue||attributeValue&&!reTransformList.test(attributeValue))return matrix;attributeValue.replace(reTransform,function(match){var m=new RegExp(transform).exec(match).filter(function(match){return!!match}),operation=m[1],args=m.slice(2).map(parseFloat);switch(operation){case"translate":translateMatrix(matrix,args);break;case"rotate":args[0]=fabric.util.degreesToRadians(args[0]),rotateMatrix(matrix,args);break;case"scale":scaleMatrix(matrix,args);break;case"skewX":skewMatrix(matrix,args,2);break;case"skewY":skewMatrix(matrix,args,1);break;case"matrix":matrix=args}matrices.push(matrix.concat()),matrix=iMatrix.concat()});for(var combinedMatrix=matrices[0];matrices.length>1;)matrices.shift(),combinedMatrix=fabric.util.multiplyTransformMatrices(combinedMatrix,matrices[0]);return combinedMatrix}}();var reViewBoxAttrValue=new RegExp("^\\s*("+fabric.reNum+"+)\\s*,?\\s*("+fabric.reNum+"+)\\s*,?\\s*("+fabric.reNum+"+)\\s*,?\\s*("+fabric.reNum+"+)\\s*$");function applyViewboxTransform(element){var viewBoxAttr=element.getAttribute("viewBox"),scaleX=1,scaleY=1,minX=0,minY=0,viewBoxWidth,viewBoxHeight,matrix,el,widthAttr=element.getAttribute("width"),heightAttr=element.getAttribute("height"),x=element.getAttribute("x")||0,y=element.getAttribute("y")||0,preserveAspectRatio=element.getAttribute("preserveAspectRatio")||"",missingViewBox=!viewBoxAttr||!fabric.svgViewBoxElementsRegEx.test(element.nodeName)||!(viewBoxAttr=viewBoxAttr.match(reViewBoxAttrValue)),missingDimAttr=!widthAttr||!heightAttr||"100%"===widthAttr||"100%"===heightAttr,toBeParsed=missingViewBox&&missingDimAttr,parsedDim={},translateMatrix="",widthDiff=0,heightDiff=0;if(parsedDim.width=0,parsedDim.height=0,parsedDim.toBeParsed=toBeParsed,toBeParsed)return parsedDim;if(missingViewBox)return parsedDim.width=parseUnit(widthAttr),parsedDim.height=parseUnit(heightAttr),parsedDim;if(minX=-parseFloat(viewBoxAttr[1]),minY=-parseFloat(viewBoxAttr[2]),viewBoxWidth=parseFloat(viewBoxAttr[3]),viewBoxHeight=parseFloat(viewBoxAttr[4]),missingDimAttr?(parsedDim.width=viewBoxWidth,parsedDim.height=viewBoxHeight):(parsedDim.width=parseUnit(widthAttr),parsedDim.height=parseUnit(heightAttr),scaleX=parsedDim.width/viewBoxWidth,scaleY=parsedDim.height/viewBoxHeight),"none"!==(preserveAspectRatio=fabric.util.parsePreserveAspectRatioAttribute(preserveAspectRatio)).alignX&&("meet"===preserveAspectRatio.meetOrSlice&&(scaleY=scaleX=scaleX>scaleY?scaleY:scaleX),"slice"===preserveAspectRatio.meetOrSlice&&(scaleY=scaleX=scaleX>scaleY?scaleX:scaleY),widthDiff=parsedDim.width-viewBoxWidth*scaleX,heightDiff=parsedDim.height-viewBoxHeight*scaleX,"Mid"===preserveAspectRatio.alignX&&(widthDiff/=2),"Mid"===preserveAspectRatio.alignY&&(heightDiff/=2),"Min"===preserveAspectRatio.alignX&&(widthDiff=0),"Min"===preserveAspectRatio.alignY&&(heightDiff=0)),1===scaleX&&1===scaleY&&0===minX&&0===minY&&0===x&&0===y)return parsedDim;if((x||y)&&(translateMatrix=" translate("+parseUnit(x)+" "+parseUnit(y)+") "),matrix=translateMatrix+" matrix("+scaleX+" 0 0 "+scaleY+" "+(minX*scaleX+widthDiff)+" "+(minY*scaleY+heightDiff)+") ",parsedDim.viewboxTransform=fabric.parseTransformAttribute(matrix),"svg"===element.nodeName){for(el=element.ownerDocument.createElement("g");element.firstChild;)el.appendChild(element.firstChild);element.appendChild(el)}else matrix=(el=element).getAttribute("transform")+matrix;return el.setAttribute("transform",matrix),parsedDim}function hasAncestorWithNodeName(element,nodeName){for(;element&&(element=element.parentNode);)if(element.nodeName&&nodeName.test(element.nodeName.replace("svg:",""))&&!element.getAttribute("instantiated_by_use"))return!0;return!1}fabric.parseSVGDocument=function(doc,callback,reviver,parsingOptions){if(doc){parseUseDirectives(doc);var svgUid=fabric.Object.__uid++,i,len,options=applyViewboxTransform(doc),descendants=fabric.util.toArray(doc.getElementsByTagName("*"));if(options.crossOrigin=parsingOptions&&parsingOptions.crossOrigin,options.svgUid=svgUid,0===descendants.length&&fabric.isLikelyNode){var arr=[];for(i=0,len=(descendants=doc.selectNodes('//*[name(.)!="svg"]')).length;i<len;i++)arr[i]=descendants[i];descendants=arr}var elements=descendants.filter(function(el){return applyViewboxTransform(el),fabric.svgValidTagNamesRegEx.test(el.nodeName.replace("svg:",""))&&!hasAncestorWithNodeName(el,fabric.svgInvalidAncestorsRegEx)});if(!elements||elements&&!elements.length)callback&&callback([],{});else{var clipPaths={};descendants.filter(function(el){return"clipPath"===el.nodeName.replace("svg:","")}).forEach(function(el){clipPaths[el.id]=fabric.util.toArray(el.getElementsByTagName("*")).filter(function(el){return fabric.svgValidTagNamesRegEx.test(el.nodeName.replace("svg:",""))})}),fabric.gradientDefs[svgUid]=fabric.getGradientDefs(doc),fabric.cssRules[svgUid]=fabric.getCSSRules(doc),fabric.clipPaths[svgUid]=clipPaths,fabric.parseElements(elements,function(instances,elements){callback&&(callback(instances,options,elements,descendants),delete fabric.gradientDefs[svgUid],delete fabric.cssRules[svgUid],delete fabric.clipPaths[svgUid])},clone(options),reviver,parsingOptions)}}};var reFontDeclaration=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+fabric.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+fabric.reNum+"))?\\s+(.*)");extend(fabric,{parseFontDeclaration:function(value,oStyle){var match=value.match(reFontDeclaration);if(match){var fontStyle=match[1],fontWeight=match[3],fontSize=match[4],lineHeight=match[5],fontFamily=match[6];fontStyle&&(oStyle.fontStyle=fontStyle),fontWeight&&(oStyle.fontWeight=isNaN(parseFloat(fontWeight))?fontWeight:parseFloat(fontWeight)),fontSize&&(oStyle.fontSize=parseUnit(fontSize)),fontFamily&&(oStyle.fontFamily=fontFamily),lineHeight&&(oStyle.lineHeight="normal"===lineHeight?1:lineHeight)}},getGradientDefs:function(doc){var tagArray,elList=_getMultipleNodes(doc,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),el,j=0,id,xlink,gradientDefs={},idsToXlinkMap={};for(j=elList.length;j--;)xlink=(el=elList[j]).getAttribute("xlink:href"),id=el.getAttribute("id"),xlink&&(idsToXlinkMap[id]=xlink.substr(1)),gradientDefs[id]=el;for(id in idsToXlinkMap){var el2=gradientDefs[idsToXlinkMap[id]].cloneNode(!0);for(el=gradientDefs[id];el2.firstChild;)el.appendChild(el2.firstChild)}return gradientDefs},parseAttributes:function(element,attributes,svgUid){if(element){var value,parentAttributes={},fontSize;void 0===svgUid&&(svgUid=element.getAttribute("svgUid")),element.parentNode&&fabric.svgValidParentsRegEx.test(element.parentNode.nodeName)&&(parentAttributes=fabric.parseAttributes(element.parentNode,attributes,svgUid)),fontSize=parentAttributes&&parentAttributes.fontSize||element.getAttribute("font-size")||fabric.Text.DEFAULT_SVG_FONT_SIZE;var ownAttributes=attributes.reduce(function(memo,attr){return(value=element.getAttribute(attr))&&(memo[attr]=value),memo},{});ownAttributes=extend(ownAttributes,extend(getGlobalStylesForElement(element,svgUid),fabric.parseStyleAttribute(element)));var normalizedAttr,normalizedValue,normalizedStyle={};for(var attr in ownAttributes)normalizedValue=normalizeValue(normalizedAttr=normalizeAttr(attr),ownAttributes[attr],parentAttributes,fontSize),normalizedStyle[normalizedAttr]=normalizedValue;normalizedStyle&&normalizedStyle.font&&fabric.parseFontDeclaration(normalizedStyle.font,normalizedStyle);var mergedAttrs=extend(parentAttributes,normalizedStyle);return fabric.svgValidParentsRegEx.test(element.nodeName)?mergedAttrs:_setStrokeFillOpacity(mergedAttrs)}},parseElements:function(elements,callback,options,reviver,parsingOptions){new fabric.ElementsParser(elements,callback,options,reviver,parsingOptions).parse()},parseStyleAttribute:function(element){var oStyle={},style=element.getAttribute("style");return style?("string"==typeof style?parseStyleString(style,oStyle):parseStyleObject(style,oStyle),oStyle):oStyle},parsePointsAttribute:function(points){if(!points)return null;var parsedPoints=[],i,len;for(i=0,len=(points=(points=points.replace(/,/g," ").trim()).split(/\s+/)).length;i<len;i+=2)parsedPoints.push({x:parseFloat(points[i]),y:parseFloat(points[i+1])});return parsedPoints},getCSSRules:function(doc){var styles=doc.getElementsByTagName("style"),i,len,allRules={},rules;for(i=0,len=styles.length;i<len;i++){var styleContents=styles[i].textContent||styles[i].text;""!==(styleContents=styleContents.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&(rules=(rules=styleContents.match(/[^{]*\{[\s\S]*?\}/g)).map(function(rule){return rule.trim()})).forEach(function(rule){var match=rule.match(/([\s\S]*?)\s*\{([^}]*)\}/),ruleObj={},declaration,propertyValuePairs=match[2].trim().replace(/;$/,"").split(/\s*;\s*/);for(i=0,len=propertyValuePairs.length;i<len;i++){var pair=propertyValuePairs[i].split(/\s*:\s*/),property=pair[0],value=pair[1];ruleObj[property]=value}(rule=match[1]).split(",").forEach(function(_rule){""!==(_rule=_rule.replace(/^svg/i,"").trim())&&(allRules[_rule]?fabric.util.object.extend(allRules[_rule],ruleObj):allRules[_rule]=fabric.util.object.clone(ruleObj))})})}return allRules},loadSVGFromURL:function(url,callback,reviver,options){function onComplete(r){var xml=r.responseXML;xml&&!xml.documentElement&&fabric.window.ActiveXObject&&r.responseText&&((xml=new ActiveXObject("Microsoft.XMLDOM")).async="false",xml.loadXML(r.responseText.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,""))),xml&&xml.documentElement||callback&&callback(null),fabric.parseSVGDocument(xml.documentElement,function(results,_options,elements,allElements){callback&&callback(results,_options,elements,allElements)},reviver,options)}url=url.replace(/^\n\s*/,"").trim(),new fabric.util.request(url,{method:"get",onComplete:onComplete})},loadSVGFromString:function(string,callback,reviver,options){var doc;if(string=string.trim(),"undefined"!=typeof DOMParser){var parser=new DOMParser;parser&&parser.parseFromString&&(doc=parser.parseFromString(string,"text/xml"))}else fabric.window.ActiveXObject&&((doc=new ActiveXObject("Microsoft.XMLDOM")).async="false",doc.loadXML(string.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,"")));fabric.parseSVGDocument(doc.documentElement,function(results,_options,elements,allElements){callback(results,_options,elements,allElements)},reviver,options)}})}("undefined"!=typeof exports?exports:this),fabric.ElementsParser=function(elements,callback,options,reviver,parsingOptions){this.elements=elements,this.callback=callback,this.options=options,this.reviver=reviver,this.svgUid=options&&options.svgUid||0,this.parsingOptions=parsingOptions,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g},function(proto){proto.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},proto.createObjects=function(){var _this=this;this.elements.forEach(function(element,i){element.setAttribute("svgUid",_this.svgUid),_this.createObject(element,i)})},proto.findTag=function(el){return fabric[fabric.util.string.capitalize(el.tagName.replace("svg:",""))]},proto.createObject=function(el,index){var klass=this.findTag(el);if(klass&&klass.fromElement)try{klass.fromElement(el,this.createCallback(index,el),this.options)}catch(err){fabric.log(err)}else this.checkIfDone()},proto.createCallback=function(index,el){var _this=this;return function(obj){var _options;_this.resolveGradient(obj,"fill"),_this.resolveGradient(obj,"stroke"),obj instanceof fabric.Image&&(_options=obj.parsePreserveAspectRatioAttribute(el)),obj._removeTransformMatrix(_options),_this.resolveClipPath(obj),_this.reviver&&_this.reviver(el,obj),_this.instances[index]=obj,_this.checkIfDone()}},proto.extractPropertyDefinition=function(obj,property,storage){var value=obj[property];if(/^url\(/.test(value)){var id=this.regexUrl.exec(value)[1];return this.regexUrl.lastIndex=0,fabric[storage][this.svgUid][id]}},proto.resolveGradient=function(obj,property){var gradientDef=this.extractPropertyDefinition(obj,property,"gradientDefs");gradientDef&&obj.set(property,fabric.Gradient.fromElement(gradientDef,obj))},proto.createClipPathCallback=function(obj,container){return function(_newObj){_newObj._removeTransformMatrix(),_newObj.fillRule=_newObj.clipRule,container.push(_newObj)}},proto.resolveClipPath=function(obj){var clipPath=this.extractPropertyDefinition(obj,"clipPath","clipPaths"),element,klass,objTransformInv,container,gTransform,options;if(clipPath){container=[],objTransformInv=fabric.util.invertTransform(obj.calcTransformMatrix());for(var i=0;i<clipPath.length;i++)element=clipPath[i],(klass=this.findTag(element)).fromElement(element,this.createClipPathCallback(obj,container),this.options);clipPath=1===container.length?container[0]:new fabric.Group(container),gTransform=fabric.util.multiplyTransformMatrices(objTransformInv,clipPath.calcTransformMatrix());var options=fabric.util.qrDecompose(gTransform);clipPath.flipX=!1,clipPath.flipY=!1,clipPath.set("scaleX",options.scaleX),clipPath.set("scaleY",options.scaleY),clipPath.angle=options.angle,clipPath.skewX=options.skewX,clipPath.skewY=0,clipPath.setPositionByOrigin({x:options.translateX,y:options.translateY},"center","center"),obj.clipPath=clipPath}},proto.checkIfDone=function(){0==--this.numElements&&(this.instances=this.instances.filter(function(el){return null!=el}),this.callback(this.instances,this.elements))}}(fabric.ElementsParser.prototype),function(global){"use strict";var fabric=global.fabric||(global.fabric={});function Point(x,y){this.x=x,this.y=y}fabric.Point?fabric.warn("fabric.Point is already defined"):(fabric.Point=Point,Point.prototype={type:"point",constructor:Point,add:function(that){return new Point(this.x+that.x,this.y+that.y)},addEquals:function(that){return this.x+=that.x,this.y+=that.y,this},scalarAdd:function(scalar){return new Point(this.x+scalar,this.y+scalar)},scalarAddEquals:function(scalar){return this.x+=scalar,this.y+=scalar,this},subtract:function(that){return new Point(this.x-that.x,this.y-that.y)},subtractEquals:function(that){return this.x-=that.x,this.y-=that.y,this},scalarSubtract:function(scalar){return new Point(this.x-scalar,this.y-scalar)},scalarSubtractEquals:function(scalar){return this.x-=scalar,this.y-=scalar,this},multiply:function(scalar){return new Point(this.x*scalar,this.y*scalar)},multiplyEquals:function(scalar){return this.x*=scalar,this.y*=scalar,this},divide:function(scalar){return new Point(this.x/scalar,this.y/scalar)},divideEquals:function(scalar){return this.x/=scalar,this.y/=scalar,this},eq:function(that){return this.x===that.x&&this.y===that.y},lt:function(that){return this.x<that.x&&this.y<that.y},lte:function(that){return this.x<=that.x&&this.y<=that.y},gt:function(that){return this.x>that.x&&this.y>that.y},gte:function(that){return this.x>=that.x&&this.y>=that.y},lerp:function(that,t){return void 0===t&&(t=.5),t=Math.max(Math.min(1,t),0),new Point(this.x+(that.x-this.x)*t,this.y+(that.y-this.y)*t)},distanceFrom:function(that){var dx=this.x-that.x,dy=this.y-that.y;return Math.sqrt(dx*dx+dy*dy)},midPointFrom:function(that){return this.lerp(that)},min:function(that){return new Point(Math.min(this.x,that.x),Math.min(this.y,that.y))},max:function(that){return new Point(Math.max(this.x,that.x),Math.max(this.y,that.y))},toString:function(){return this.x+","+this.y},setXY:function(x,y){return this.x=x,this.y=y,this},setX:function(x){return this.x=x,this},setY:function(y){return this.y=y,this},setFromPoint:function(that){return this.x=that.x,this.y=that.y,this},swap:function(that){var x=this.x,y=this.y;this.x=that.x,this.y=that.y,that.x=x,that.y=y},clone:function(){return new Point(this.x,this.y)}})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={});function Intersection(status){this.status=status,this.points=[]}fabric.Intersection?fabric.warn("fabric.Intersection is already defined"):(fabric.Intersection=Intersection,fabric.Intersection.prototype={constructor:Intersection,appendPoint:function(point){return this.points.push(point),this},appendPoints:function(points){return this.points=this.points.concat(points),this}},fabric.Intersection.intersectLineLine=function(a1,a2,b1,b2){var result,uaT=(b2.x-b1.x)*(a1.y-b1.y)-(b2.y-b1.y)*(a1.x-b1.x),ubT=(a2.x-a1.x)*(a1.y-b1.y)-(a2.y-a1.y)*(a1.x-b1.x),uB=(b2.y-b1.y)*(a2.x-a1.x)-(b2.x-b1.x)*(a2.y-a1.y);if(0!==uB){var ua=uaT/uB,ub=ubT/uB;0<=ua&&ua<=1&&0<=ub&&ub<=1?(result=new Intersection("Intersection")).appendPoint(new fabric.Point(a1.x+ua*(a2.x-a1.x),a1.y+ua*(a2.y-a1.y))):result=new Intersection}else result=new Intersection(0===uaT||0===ubT?"Coincident":"Parallel");return result},fabric.Intersection.intersectLinePolygon=function(a1,a2,points){var result=new Intersection,length=points.length,b1,b2,inter,i;for(i=0;i<length;i++)b1=points[i],b2=points[(i+1)%length],inter=Intersection.intersectLineLine(a1,a2,b1,b2),result.appendPoints(inter.points);return result.points.length>0&&(result.status="Intersection"),result},fabric.Intersection.intersectPolygonPolygon=function(points1,points2){var result=new Intersection,length=points1.length,i;for(i=0;i<length;i++){var a1=points1[i],a2=points1[(i+1)%length],inter=Intersection.intersectLinePolygon(a1,a2,points2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},fabric.Intersection.intersectPolygonRectangle=function(points,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new fabric.Point(max.x,min.y),bottomLeft=new fabric.Point(min.x,max.y),inter1=Intersection.intersectLinePolygon(min,topRight,points),inter2=Intersection.intersectLinePolygon(topRight,max,points),inter3=Intersection.intersectLinePolygon(max,bottomLeft,points),inter4=Intersection.intersectLinePolygon(bottomLeft,min,points),result=new Intersection;return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={});function Color(color){color?this._tryParsingColor(color):this.setSource([0,0,0,1])}function hue2rgb(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p}fabric.Color?fabric.warn("fabric.Color is already defined."):(fabric.Color=Color,fabric.Color.prototype={_tryParsingColor:function(color){var source;color in Color.colorNameMap&&(color=Color.colorNameMap[color]),"transparent"===color&&(source=[255,255,255,0]),source||(source=Color.sourceFromHex(color)),source||(source=Color.sourceFromRgb(color)),source||(source=Color.sourceFromHsl(color)),source||(source=[0,0,0,1]),source&&this.setSource(source)},_rgbToHsl:function(r,g,b){r/=255,g/=255,b/=255;var h,s,l,max=fabric.util.array.max([r,g,b]),min=fabric.util.array.min([r,g,b]);if(l=(max+min)/2,max===min)h=s=0;else{var d=max-min;switch(s=l>.5?d/(2-max-min):d/(max+min),max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4}h/=6}return[Math.round(360*h),Math.round(100*s),Math.round(100*l)]},getSource:function(){return this._source},setSource:function(source){this._source=source},toRgb:function(){var source=this.getSource();return"rgb("+source[0]+","+source[1]+","+source[2]+")"},toRgba:function(){var source=this.getSource();return"rgba("+source[0]+","+source[1]+","+source[2]+","+source[3]+")"},toHsl:function(){var source=this.getSource(),hsl=this._rgbToHsl(source[0],source[1],source[2]);return"hsl("+hsl[0]+","+hsl[1]+"%,"+hsl[2]+"%)"},toHsla:function(){var source=this.getSource(),hsl=this._rgbToHsl(source[0],source[1],source[2]);return"hsla("+hsl[0]+","+hsl[1]+"%,"+hsl[2]+"%,"+source[3]+")"},toHex:function(){var source=this.getSource(),r,g,b;return r=1===(r=source[0].toString(16)).length?"0"+r:r,g=1===(g=source[1].toString(16)).length?"0"+g:g,b=1===(b=source[2].toString(16)).length?"0"+b:b,r.toUpperCase()+g.toUpperCase()+b.toUpperCase()},toHexa:function(){var source=this.getSource(),a;return a=1===(a=(a=Math.round(255*source[3])).toString(16)).length?"0"+a:a,this.toHex()+a.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(alpha){var source=this.getSource();return source[3]=alpha,this.setSource(source),this},toGrayscale:function(){var source=this.getSource(),average=parseInt((.3*source[0]+.59*source[1]+.11*source[2]).toFixed(0),10),currentAlpha=source[3];return this.setSource([average,average,average,currentAlpha]),this},toBlackWhite:function(threshold){var source=this.getSource(),average=(.3*source[0]+.59*source[1]+.11*source[2]).toFixed(0),currentAlpha=source[3];return threshold=threshold||127,average=Number(average)<Number(threshold)?0:255,this.setSource([average,average,average,currentAlpha]),this},overlayWith:function(otherColor){otherColor instanceof Color||(otherColor=new Color(otherColor));var result=[],alpha=this.getAlpha(),otherAlpha=.5,source=this.getSource(),otherSource=otherColor.getSource(),i;for(i=0;i<3;i++)result.push(Math.round(.5*source[i]+.5*otherSource[i]));return result[3]=alpha,this.setSource(result),this}},fabric.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,fabric.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,fabric.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,fabric.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},fabric.Color.fromRgb=function(color){return Color.fromSource(Color.sourceFromRgb(color))},fabric.Color.sourceFromRgb=function(color){var match=color.match(Color.reRGBa);if(match){var r=parseInt(match[1],10)/(/%$/.test(match[1])?100:1)*(/%$/.test(match[1])?255:1),g=parseInt(match[2],10)/(/%$/.test(match[2])?100:1)*(/%$/.test(match[2])?255:1),b=parseInt(match[3],10)/(/%$/.test(match[3])?100:1)*(/%$/.test(match[3])?255:1);return[parseInt(r,10),parseInt(g,10),parseInt(b,10),match[4]?parseFloat(match[4]):1]}},fabric.Color.fromRgba=Color.fromRgb,fabric.Color.fromHsl=function(color){return Color.fromSource(Color.sourceFromHsl(color))},fabric.Color.sourceFromHsl=function(color){var match=color.match(Color.reHSLa);if(match){var h=(parseFloat(match[1])%360+360)%360/360,s=parseFloat(match[2])/(/%$/.test(match[2])?100:1),l=parseFloat(match[3])/(/%$/.test(match[3])?100:1),r,g,b;if(0===s)r=g=b=l;else{var q=l<=.5?l*(s+1):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3),g=hue2rgb(p,q,h),b=hue2rgb(p,q,h-1/3)}return[Math.round(255*r),Math.round(255*g),Math.round(255*b),match[4]?parseFloat(match[4]):1]}},fabric.Color.fromHsla=Color.fromHsl,fabric.Color.fromHex=function(color){return Color.fromSource(Color.sourceFromHex(color))},fabric.Color.sourceFromHex=function(color){if(color.match(Color.reHex)){var value=color.slice(color.indexOf("#")+1),isShortNotation=3===value.length||4===value.length,isRGBa=8===value.length||4===value.length,r=isShortNotation?value.charAt(0)+value.charAt(0):value.substring(0,2),g=isShortNotation?value.charAt(1)+value.charAt(1):value.substring(2,4),b=isShortNotation?value.charAt(2)+value.charAt(2):value.substring(4,6),a=isRGBa?isShortNotation?value.charAt(3)+value.charAt(3):value.substring(6,8):"FF";return[parseInt(r,16),parseInt(g,16),parseInt(b,16),parseFloat((parseInt(a,16)/255).toFixed(2))]}},fabric.Color.fromSource=function(source){var oColor=new Color;return oColor.setSource(source),oColor})}("undefined"!=typeof exports?exports:this),function(){function getColorStop(el){var style=el.getAttribute("style"),offset=el.getAttribute("offset")||0,color,colorAlpha,opacity,i;if(offset=(offset=parseFloat(offset)/(/%$/.test(offset)?100:1))<0?0:offset>1?1:offset,style){var keyValuePairs=style.split(/\s*;\s*/);for(""===keyValuePairs[keyValuePairs.length-1]&&keyValuePairs.pop(),i=keyValuePairs.length;i--;){var split=keyValuePairs[i].split(/\s*:\s*/),key=split[0].trim(),value=split[1].trim();"stop-color"===key?color=value:"stop-opacity"===key&&(opacity=value)}}return color||(color=el.getAttribute("stop-color")||"rgb(0,0,0)"),opacity||(opacity=el.getAttribute("stop-opacity")),colorAlpha=(color=new fabric.Color(color)).getAlpha(),opacity=isNaN(parseFloat(opacity))?1:parseFloat(opacity),opacity*=colorAlpha,{offset:offset,color:color.toRgb(),opacity:opacity}}function getLinearCoords(el){return{x1:el.getAttribute("x1")||0,y1:el.getAttribute("y1")||0,x2:el.getAttribute("x2")||"100%",y2:el.getAttribute("y2")||0}}function getRadialCoords(el){return{x1:el.getAttribute("fx")||el.getAttribute("cx")||"50%",y1:el.getAttribute("fy")||el.getAttribute("cy")||"50%",r1:0,x2:el.getAttribute("cx")||"50%",y2:el.getAttribute("cy")||"50%",r2:el.getAttribute("r")||"50%"}}var clone=fabric.util.object.clone;function _convertPercentUnitsToValues(object,options,gradientUnits){var propValue,addFactor=0,multFactor=1,ellipseMatrix="";for(var prop in options)"Infinity"===options[prop]?options[prop]=1:"-Infinity"===options[prop]&&(options[prop]=0),propValue=parseFloat(options[prop],10),multFactor="string"==typeof options[prop]&&/^(\d+\.\d+)%|(\d+)%$/.test(options[prop])?.01:1,"x1"===prop||"x2"===prop||"r2"===prop?(multFactor*="objectBoundingBox"===gradientUnits?object.width:1,addFactor="objectBoundingBox"===gradientUnits&&object.left||0):"y1"!==prop&&"y2"!==prop||(multFactor*="objectBoundingBox"===gradientUnits?object.height:1,addFactor="objectBoundingBox"===gradientUnits&&object.top||0),options[prop]=propValue*multFactor+addFactor;if("ellipse"===object.type&&null!==options.r2&&"objectBoundingBox"===gradientUnits&&object.rx!==object.ry){var scaleFactor=object.ry/object.rx;ellipseMatrix=" scale(1, "+scaleFactor+")",options.y1&&(options.y1/=scaleFactor),options.y2&&(options.y2/=scaleFactor)}return ellipseMatrix}fabric.Gradient=fabric.util.createClass({offsetX:0,offsetY:0,initialize:function(options){options||(options={});var coords={};this.id=fabric.Object.__uid++,this.type=options.type||"linear",coords={x1:options.coords.x1||0,y1:options.coords.y1||0,x2:options.coords.x2||0,y2:options.coords.y2||0},"radial"===this.type&&(coords.r1=options.coords.r1||0,coords.r2=options.coords.r2||0),this.coords=coords,this.colorStops=options.colorStops.slice(),options.gradientTransform&&(this.gradientTransform=options.gradientTransform),this.offsetX=options.offsetX||this.offsetX,this.offsetY=options.offsetY||this.offsetY},addColorStop:function(colorStops){for(var position in colorStops){var color=new fabric.Color(colorStops[position]);this.colorStops.push({offset:parseFloat(position),color:color.toRgb(),opacity:color.getAlpha()})}return this},toObject:function(propertiesToInclude){var object={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return fabric.util.populateWithProperties(this,object,propertiesToInclude),object},toSVG:function(object){var coords=clone(this.coords,!0),i,len,markup,commonAttributes,colorStops=clone(this.colorStops,!0),needsSwap=coords.r1>coords.r2,offsetX=object.width/2,offsetY=object.height/2;for(var prop in colorStops.sort(function(a,b){return a.offset-b.offset}),"path"===object.type&&(offsetX-=object.pathOffset.x,offsetY-=object.pathOffset.y),coords)"x1"===prop||"x2"===prop?coords[prop]+=this.offsetX-offsetX:"y1"!==prop&&"y2"!==prop||(coords[prop]+=this.offsetY-offsetY);if(commonAttributes='id="SVGID_'+this.id+'" gradientUnits="userSpaceOnUse"',this.gradientTransform&&(commonAttributes+=' gradientTransform="matrix('+this.gradientTransform.join(" ")+')" '),"linear"===this.type?markup=["<linearGradient ",commonAttributes,' x1="',coords.x1,'" y1="',coords.y1,'" x2="',coords.x2,'" y2="',coords.y2,'">\n']:"radial"===this.type&&(markup=["<radialGradient ",commonAttributes,' cx="',needsSwap?coords.x1:coords.x2,'" cy="',needsSwap?coords.y1:coords.y2,'" r="',needsSwap?coords.r1:coords.r2,'" fx="',needsSwap?coords.x2:coords.x1,'" fy="',needsSwap?coords.y2:coords.y1,'">\n']),"radial"===this.type){if(needsSwap)for((colorStops=colorStops.concat()).reverse(),i=0,len=colorStops.length;i<len;i++)colorStops[i].offset=1-colorStops[i].offset;var minRadius=Math.min(coords.r1,coords.r2);if(minRadius>0){var maxRadius,percentageShift=minRadius/Math.max(coords.r1,coords.r2);for(i=0,len=colorStops.length;i<len;i++)colorStops[i].offset+=percentageShift*(1-colorStops[i].offset)}}for(i=0,len=colorStops.length;i<len;i++){var colorStop=colorStops[i];markup.push("<stop ",'offset="',100*colorStop.offset+"%",'" style="stop-color:',colorStop.color,void 0!==colorStop.opacity?";stop-opacity: "+colorStop.opacity:";",'"/>\n')}return markup.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),markup.join("")},toLive:function(ctx){var gradient,coords=fabric.util.object.clone(this.coords),i,len;if(this.type){for("linear"===this.type?gradient=ctx.createLinearGradient(coords.x1,coords.y1,coords.x2,coords.y2):"radial"===this.type&&(gradient=ctx.createRadialGradient(coords.x1,coords.y1,coords.r1,coords.x2,coords.y2,coords.r2)),i=0,len=this.colorStops.length;i<len;i++){var color=this.colorStops[i].color,opacity=this.colorStops[i].opacity,offset=this.colorStops[i].offset;void 0!==opacity&&(color=new fabric.Color(color).setAlpha(opacity).toRgba()),gradient.addColorStop(offset,color)}return gradient}}}),fabric.util.object.extend(fabric.Gradient,{fromElement:function(el,instance){var colorStopEls=el.getElementsByTagName("stop"),type,gradientUnits=el.getAttribute("gradientUnits")||"objectBoundingBox",gradientTransform=el.getAttribute("gradientTransform"),colorStops=[],coords,ellipseMatrix,i;for("linear"===(type="linearGradient"===el.nodeName||"LINEARGRADIENT"===el.nodeName?"linear":"radial")?coords=getLinearCoords(el):"radial"===type&&(coords=getRadialCoords(el)),i=colorStopEls.length;i--;)colorStops.push(getColorStop(colorStopEls[i]));ellipseMatrix=_convertPercentUnitsToValues(instance,coords,gradientUnits);var gradient=new fabric.Gradient({type:type,coords:coords,colorStops:colorStops,offsetX:-instance.left,offsetY:-instance.top});return(gradientTransform||""!==ellipseMatrix)&&(gradient.gradientTransform=fabric.parseTransformAttribute((gradientTransform||"")+ellipseMatrix)),gradient},forObject:function(obj,options){return options||(options={}),_convertPercentUnitsToValues(obj,options.coords,"userSpaceOnUse"),new fabric.Gradient(options)}})}(),function(){"use strict";var toFixed=fabric.util.toFixed;fabric.Pattern=fabric.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(options,callback){if(options||(options={}),this.id=fabric.Object.__uid++,this.setOptions(options),!options.source||options.source&&"string"!=typeof options.source)callback&&callback(this);else if(void 0!==fabric.util.getFunctionBody(options.source))this.source=new Function(fabric.util.getFunctionBody(options.source)),callback&&callback(this);else{var _this=this;this.source=fabric.util.createImage(),fabric.util.loadImage(options.source,function(img){_this.source=img,callback&&callback(_this)},null,this.crossOrigin)}},toObject:function(propertiesToInclude){var NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS,source,object;return"function"==typeof this.source?source=String(this.source):"string"==typeof this.source.src?source=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(source=this.source.toDataURL()),object={type:"pattern",source:source,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:toFixed(this.offsetX,NUM_FRACTION_DIGITS),offsetY:toFixed(this.offsetY,NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?this.patternTransform.concat():null},fabric.util.populateWithProperties(this,object,propertiesToInclude),object},toSVG:function(object){var patternSource="function"==typeof this.source?this.source():this.source,patternWidth=patternSource.width/object.width,patternHeight=patternSource.height/object.height,patternOffsetX=this.offsetX/object.width,patternOffsetY=this.offsetY/object.height,patternImgSrc="";return"repeat-x"!==this.repeat&&"no-repeat"!==this.repeat||(patternHeight=1,patternOffsetY&&(patternHeight+=Math.abs(patternOffsetY))),"repeat-y"!==this.repeat&&"no-repeat"!==this.repeat||(patternWidth=1,patternOffsetX&&(patternWidth+=Math.abs(patternOffsetX))),patternSource.src?patternImgSrc=patternSource.src:patternSource.toDataURL&&(patternImgSrc=patternSource.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+patternOffsetX+'" y="'+patternOffsetY+'" width="'+patternWidth+'" height="'+patternHeight+'">\n<image x="0" y="0" width="'+patternSource.width+'" height="'+patternSource.height+'" xlink:href="'+patternImgSrc+'"></image>\n</pattern>\n'},setOptions:function(options){for(var prop in options)this[prop]=options[prop]},toLive:function(ctx){var source="function"==typeof this.source?this.source():this.source;if(!source)return"";if(void 0!==source.src){if(!source.complete)return"";if(0===source.naturalWidth||0===source.naturalHeight)return""}return ctx.createPattern(source,this.repeat)}})}(),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),toFixed=fabric.util.toFixed;fabric.Shadow?fabric.warn("fabric.Shadow is already defined."):(fabric.Shadow=fabric.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,initialize:function(options){for(var prop in"string"==typeof options&&(options=this._parseShadow(options)),options)this[prop]=options[prop];this.id=fabric.Object.__uid++},_parseShadow:function(shadow){var shadowStr=shadow.trim(),offsetsAndBlur=fabric.Shadow.reOffsetsAndBlur.exec(shadowStr)||[],color;return{color:(shadowStr.replace(fabric.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseInt(offsetsAndBlur[1],10)||0,offsetY:parseInt(offsetsAndBlur[2],10)||0,blur:parseInt(offsetsAndBlur[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(object){var fBoxX=40,fBoxY=40,NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS,offset=fabric.util.rotateVector({x:this.offsetX,y:this.offsetY},fabric.util.degreesToRadians(-object.angle)),BLUR_BOX=20,color=new fabric.Color(this.color);return object.width&&object.height&&(fBoxX=100*toFixed((Math.abs(offset.x)+this.blur)/object.width,NUM_FRACTION_DIGITS)+20,fBoxY=100*toFixed((Math.abs(offset.y)+this.blur)/object.height,NUM_FRACTION_DIGITS)+20),object.flipX&&(offset.x*=-1),object.flipY&&(offset.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+fBoxY+'%" height="'+(100+2*fBoxY)+'%" x="-'+fBoxX+'%" width="'+(100+2*fBoxX)+'%" >\n\t<feGaussianBlur in="SourceAlpha" stdDeviation="'+toFixed(this.blur?this.blur/2:0,NUM_FRACTION_DIGITS)+'"></feGaussianBlur>\n\t<feOffset dx="'+toFixed(offset.x,NUM_FRACTION_DIGITS)+'" dy="'+toFixed(offset.y,NUM_FRACTION_DIGITS)+'" result="oBlur" ></feOffset>\n\t<feFlood flood-color="'+color.toRgb()+'" flood-opacity="'+color.getAlpha()+'"/>\n\t<feComposite in2="oBlur" operator="in" />\n\t<feMerge>\n\t\t<feMergeNode></feMergeNode>\n\t\t<feMergeNode in="SourceGraphic"></feMergeNode>\n\t</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke};var obj={},proto=fabric.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke"].forEach(function(prop){this[prop]!==proto[prop]&&(obj[prop]=this[prop])},this),obj}}),fabric.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:px)?(?:\s?|$))?(-?\d+(?:px)?(?:\s?|$))?(\d+(?:px)?)?(?:\s?|$)(?:$|\s)/)}("undefined"!=typeof exports?exports:this),function(){"use strict";if(fabric.StaticCanvas)fabric.warn("fabric.StaticCanvas is already defined.");else{var extend=fabric.util.object.extend,getElementOffset=fabric.util.getElementOffset,removeFromArray=fabric.util.removeFromArray,toFixed=fabric.util.toFixed,transformPoint=fabric.util.transformPoint,invertTransform=fabric.util.invertTransform,CANVAS_INIT_ERROR=new Error("Could not initialize `canvas` element");fabric.StaticCanvas=fabric.util.createClass(fabric.CommonMethods,{initialize:function(el,options){options||(options={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(el,options)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,clipTo:null,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:fabric.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,onBeforeScaleRotate:function(){},enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(el,options){var cb=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(el),this._initOptions(options),this._setImageSmoothing(),this.interactive||this._initRetinaScaling(),options.overlayImage&&this.setOverlayImage(options.overlayImage,cb),options.backgroundImage&&this.setBackgroundImage(options.backgroundImage,cb),options.backgroundColor&&this.setBackgroundColor(options.backgroundColor,cb),options.overlayColor&&this.setOverlayColor(options.overlayColor,cb),this.calcOffset()},_isRetinaScaling:function(){return 1!==fabric.devicePixelRatio&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?fabric.devicePixelRatio:1},_initRetinaScaling:function(){this._isRetinaScaling()&&(this.lowerCanvasEl.setAttribute("width",this.width*fabric.devicePixelRatio),this.lowerCanvasEl.setAttribute("height",this.height*fabric.devicePixelRatio),this.contextContainer.scale(fabric.devicePixelRatio,fabric.devicePixelRatio))},calcOffset:function(){return this._offset=getElementOffset(this.lowerCanvasEl),this},setOverlayImage:function(image,callback,options){return this.__setBgOverlayImage("overlayImage",image,callback,options)},setBackgroundImage:function(image,callback,options){return this.__setBgOverlayImage("backgroundImage",image,callback,options)},setOverlayColor:function(overlayColor,callback){return this.__setBgOverlayColor("overlayColor",overlayColor,callback)},setBackgroundColor:function(backgroundColor,callback){return this.__setBgOverlayColor("backgroundColor",backgroundColor,callback)},_setImageSmoothing:function(){var ctx=this.getContext();ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled||ctx.webkitImageSmoothingEnabled||ctx.mozImageSmoothingEnabled||ctx.msImageSmoothingEnabled||ctx.oImageSmoothingEnabled,ctx.imageSmoothingEnabled=this.imageSmoothingEnabled},__setBgOverlayImage:function(property,image,callback,options){return"string"==typeof image?fabric.util.loadImage(image,function(img){img&&(this[property]=new fabric.Image(img,options)),callback&&callback(img)},this,options&&options.crossOrigin):(options&&image.setOptions(options),this[property]=image,callback&&callback(image)),this},__setBgOverlayColor:function(property,color,callback){return this[property]=color,this._initGradient(color,property),this._initPattern(color,property,callback),this},_createCanvasElement:function(){var element=fabric.util.createCanvasElement();if(!element)throw CANVAS_INIT_ERROR;if(element.style||(element.style={}),void 0===element.getContext)throw CANVAS_INIT_ERROR;return element},_initOptions:function(options){this._setOptions(options),this.width=this.width||parseInt(this.lowerCanvasEl.width,10)||0,this.height=this.height||parseInt(this.lowerCanvasEl.height,10)||0,this.lowerCanvasEl.style&&(this.lowerCanvasEl.width=this.width,this.lowerCanvasEl.height=this.height,this.lowerCanvasEl.style.width=this.width+"px",this.lowerCanvasEl.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(canvasEl){canvasEl&&canvasEl.getContext?this.lowerCanvasEl=canvasEl:this.lowerCanvasEl=fabric.util.getById(canvasEl)||this._createCanvasElement(),fabric.util.addClass(this.lowerCanvasEl,"lower-canvas"),this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(value,options){return this.setDimensions({width:value},options)},setHeight:function(value,options){return this.setDimensions({height:value},options)},setDimensions:function(dimensions,options){var cssValue;for(var prop in options=options||{},dimensions)cssValue=dimensions[prop],options.cssOnly||(this._setBackstoreDimension(prop,dimensions[prop]),cssValue+="px",this.hasLostContext=!0),options.backstoreOnly||this._setCssDimension(prop,cssValue);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(),this._initRetinaScaling(),this._setImageSmoothing(),this.calcOffset(),options.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(prop,value){return this.lowerCanvasEl[prop]=value,this.upperCanvasEl&&(this.upperCanvasEl[prop]=value),this.cacheCanvasEl&&(this.cacheCanvasEl[prop]=value),this[prop]=value,this},_setCssDimension:function(prop,value){return this.lowerCanvasEl.style[prop]=value,this.upperCanvasEl&&(this.upperCanvasEl.style[prop]=value),this.wrapperEl&&(this.wrapperEl.style[prop]=value),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(vpt){var activeObject=this._activeObject,object,ignoreVpt=!1,skipAbsolute=!0,i,len;for(this.viewportTransform=vpt,i=0,len=this._objects.length;i<len;i++)(object=this._objects[i]).group||object.setCoords(!1,!0);return activeObject&&"activeSelection"===activeObject.type&&activeObject.setCoords(!1,!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(point,value){var before=point,vpt=this.viewportTransform.slice(0);point=transformPoint(point,invertTransform(this.viewportTransform)),vpt[0]=value,vpt[3]=value;var after=transformPoint(point,vpt);return vpt[4]+=before.x-after.x,vpt[5]+=before.y-after.y,this.setViewportTransform(vpt)},setZoom:function(value){return this.zoomToPoint(new fabric.Point(0,0),value),this},absolutePan:function(point){var vpt=this.viewportTransform.slice(0);return vpt[4]=-point.x,vpt[5]=-point.y,this.setViewportTransform(vpt)},relativePan:function(point){return this.absolutePan(new fabric.Point(-point.x-this.viewportTransform[4],-point.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(obj){this.stateful&&obj.setupState(),obj._set("canvas",this),obj.setCoords(),this.fire("object:added",{target:obj}),obj.fire("added")},_onObjectRemoved:function(obj){this.fire("object:removed",{target:obj}),obj.fire("removed"),delete obj.canvas},clearContext:function(ctx){return ctx.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this._objects.length=0,this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var canvasToDrawOn=this.contextContainer;return this.renderCanvas(canvasToDrawOn,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=fabric.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var points={},width=this.width,height=this.height,iVpt=invertTransform(this.viewportTransform);return points.tl=transformPoint({x:0,y:0},iVpt),points.br=transformPoint({x:width,y:height},iVpt),points.tr=new fabric.Point(points.br.x,points.tl.y),points.bl=new fabric.Point(points.tl.x,points.br.y),this.vptCoords=points,points},cancelRequestedRender:function(){this.isRendering&&(fabric.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(ctx,objects){var v=this.viewportTransform,path=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(ctx),this.fire("before:render",{ctx:ctx}),this.clipTo&&fabric.util.clipContext(this,ctx),this._renderBackground(ctx),ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this._renderObjects(ctx,objects),ctx.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(ctx),this.clipTo&&ctx.restore(),path&&(path.isCacheDirty()&&(path.shouldCache(),path.canvas=this,path._transformDone=!0,path.renderCache({forClipping:!0})),this.drawClipPathOnCanvas(ctx)),this._renderOverlay(ctx),this.controlsAboveOverlay&&this.interactive&&this.drawControls(ctx),this.fire("after:render",{ctx:ctx})},drawClipPathOnCanvas:function(ctx){var v=this.viewportTransform,path=this.clipPath;ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5]),ctx.globalCompositeOperation="destination-in",path.transform(ctx),ctx.scale(1/path.zoomX,1/path.zoomY),ctx.drawImage(path._cacheCanvas,-path.cacheTranslationX,-path.cacheTranslationY),ctx.restore()},_renderObjects:function(ctx,objects){var i,len;for(i=0,len=objects.length;i<len;++i)objects[i]&&objects[i].render(ctx)},_renderBackgroundOrOverlay:function(ctx,property){var object=this[property+"Color"],v;object&&(ctx.fillStyle=object.toLive?object.toLive(ctx,this):object,ctx.fillRect(object.offsetX||0,object.offsetY||0,this.width,this.height)),(object=this[property+"Image"])&&(this[property+"Vpt"]&&(v=this.viewportTransform,ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5])),object.render(ctx),this[property+"Vpt"]&&ctx.restore())},_renderBackground:function(ctx){this._renderBackgroundOrOverlay(ctx,"background")},_renderOverlay:function(ctx){this._renderBackgroundOrOverlay(ctx,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},centerObjectH:function(object){return this._centerObject(object,new fabric.Point(this.getCenter().left,object.getCenterPoint().y))},centerObjectV:function(object){return this._centerObject(object,new fabric.Point(object.getCenterPoint().x,this.getCenter().top))},centerObject:function(object){var center=this.getCenter();return this._centerObject(object,new fabric.Point(center.left,center.top))},viewportCenterObject:function(object){var vpCenter=this.getVpCenter();return this._centerObject(object,vpCenter)},viewportCenterObjectH:function(object){var vpCenter=this.getVpCenter();return this._centerObject(object,new fabric.Point(vpCenter.x,object.getCenterPoint().y)),this},viewportCenterObjectV:function(object){var vpCenter=this.getVpCenter();return this._centerObject(object,new fabric.Point(object.getCenterPoint().x,vpCenter.y))},getVpCenter:function(){var center=this.getCenter(),iVpt=invertTransform(this.viewportTransform);return transformPoint({x:center.left,y:center.top},iVpt)},_centerObject:function(object,center){return object.setPositionByOrigin(center,"center","center"),object.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(propertiesToInclude){return this.toDatalessObject(propertiesToInclude)},toObject:function(propertiesToInclude){return this._toObjectMethod("toObject",propertiesToInclude)},toDatalessObject:function(propertiesToInclude){return this._toObjectMethod("toDatalessObject",propertiesToInclude)},_toObjectMethod:function(methodName,propertiesToInclude){var clipPath=this.clipPath,data={version:fabric.version,objects:this._toObjects(methodName,propertiesToInclude)};return clipPath&&(clipPath=clipPath.toObject(propertiesToInclude)),extend(data,this.__serializeBgOverlay(methodName,propertiesToInclude)),fabric.util.populateWithProperties(this,data,propertiesToInclude),data},_toObjects:function(methodName,propertiesToInclude){return this._objects.filter(function(object){return!object.excludeFromExport}).map(function(instance){return this._toObject(instance,methodName,propertiesToInclude)},this)},_toObject:function(instance,methodName,propertiesToInclude){var originalValue;this.includeDefaultValues||(originalValue=instance.includeDefaultValues,instance.includeDefaultValues=!1);var object=instance[methodName](propertiesToInclude);return this.includeDefaultValues||(instance.includeDefaultValues=originalValue),object},__serializeBgOverlay:function(methodName,propertiesToInclude){var data={},bgImage=this.backgroundImage,overlay=this.overlayImage;return this.backgroundColor&&(data.background=this.backgroundColor.toObject?this.backgroundColor.toObject(propertiesToInclude):this.backgroundColor),this.overlayColor&&(data.overlay=this.overlayColor.toObject?this.overlayColor.toObject(propertiesToInclude):this.overlayColor),bgImage&&!bgImage.excludeFromExport&&(data.backgroundImage=this._toObject(bgImage,methodName,propertiesToInclude)),overlay&&!overlay.excludeFromExport&&(data.overlayImage=this._toObject(overlay,methodName,propertiesToInclude)),data},svgViewportTransformation:!0,toSVG:function(options,reviver){options||(options={});var markup=[];return this._setSVGPreamble(markup,options),this._setSVGHeader(markup,options),this._setSVGBgOverlayColor(markup,"backgroundColor"),this._setSVGBgOverlayImage(markup,"backgroundImage",reviver),this._setSVGObjects(markup,reviver),this._setSVGBgOverlayColor(markup,"overlayColor"),this._setSVGBgOverlayImage(markup,"overlayImage",reviver),markup.push("</svg>"),markup.join("")},_setSVGPreamble:function(markup,options){options.suppressPreamble||markup.push('<?xml version="1.0" encoding="',options.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(markup,options){var width=options.width||this.width,height=options.height||this.height,vpt,viewBox='viewBox="0 0 '+this.width+" "+this.height+'" ',NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS;options.viewBox?viewBox='viewBox="'+options.viewBox.x+" "+options.viewBox.y+" "+options.viewBox.width+" "+options.viewBox.height+'" ':this.svgViewportTransformation&&(vpt=this.viewportTransform,viewBox='viewBox="'+toFixed(-vpt[4]/vpt[0],NUM_FRACTION_DIGITS)+" "+toFixed(-vpt[5]/vpt[3],NUM_FRACTION_DIGITS)+" "+toFixed(this.width/vpt[0],NUM_FRACTION_DIGITS)+" "+toFixed(this.height/vpt[3],NUM_FRACTION_DIGITS)+'" '),markup.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',width,'" ','height="',height,'" ',viewBox,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",fabric.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),"</defs>\n")},createSVGRefElementsMarkup:function(){var _this=this,markup;return["backgroundColor","overlayColor"].map(function(prop){var fill=_this[prop];if(fill&&fill.toLive)return fill.toSVG(_this,!1)}).join("")},createSVGFontFacesMarkup:function(){var markup="",fontList={},obj,fontFamily,style,row,rowIndex,_char,charIndex,i,len,fontPaths=fabric.fontPaths,objects=this._objects;for(i=0,len=objects.length;i<len;i++)if(fontFamily=(obj=objects[i]).fontFamily,-1!==obj.type.indexOf("text")&&!fontList[fontFamily]&&fontPaths[fontFamily]&&(fontList[fontFamily]=!0,obj.styles))for(rowIndex in style=obj.styles)for(charIndex in row=style[rowIndex])!fontList[fontFamily=(_char=row[charIndex]).fontFamily]&&fontPaths[fontFamily]&&(fontList[fontFamily]=!0);for(var j in fontList)markup+=["\t\t@font-face {\n","\t\t\tfont-family: '",j,"';\n","\t\t\tsrc: url('",fontPaths[j],"');\n","\t\t}\n"].join("");return markup&&(markup=['\t<style type="text/css">',"<![CDATA[\n",markup,"]]>","</style>\n"].join("")),markup},_setSVGObjects:function(markup,reviver){var instance,i,len,objects=this._objects;for(i=0,len=objects.length;i<len;i++)(instance=objects[i]).excludeFromExport||this._setSVGObject(markup,instance,reviver)},_setSVGObject:function(markup,instance,reviver){markup.push(instance.toSVG(reviver))},_setSVGBgOverlayImage:function(markup,property,reviver){this[property]&&!this[property].excludeFromExport&&this[property].toSVG&&markup.push(this[property].toSVG(reviver))},_setSVGBgOverlayColor:function(markup,property){var filler=this[property],vpt=this.viewportTransform,finalWidth=this.width/vpt[0],finalHeight=this.height/vpt[3];if(filler)if(filler.toLive){var repeat=filler.repeat;markup.push('<rect transform="translate(',finalWidth/2,",",finalHeight/2,')"',' x="',filler.offsetX-finalWidth/2,'" y="',filler.offsetY-finalHeight/2,'" ','width="',"repeat-y"===repeat||"no-repeat"===repeat?filler.source.width:finalWidth,'" height="',"repeat-x"===repeat||"no-repeat"===repeat?filler.source.height:finalHeight,'" fill="url(#SVGID_'+filler.id+')"',"></rect>\n")}else markup.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',this[property],'"',"></rect>\n")},sendToBack:function(object){if(!object)return this;var activeSelection=this._activeObject,i,obj,objs;if(object===activeSelection&&"activeSelection"===object.type)for(i=(objs=activeSelection._objects).length;i--;)obj=objs[i],removeFromArray(this._objects,obj),this._objects.unshift(obj);else removeFromArray(this._objects,object),this._objects.unshift(object);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(object){if(!object)return this;var activeSelection=this._activeObject,i,obj,objs;if(object===activeSelection&&"activeSelection"===object.type)for(objs=activeSelection._objects,i=0;i<objs.length;i++)obj=objs[i],removeFromArray(this._objects,obj),this._objects.push(obj);else removeFromArray(this._objects,object),this._objects.push(object);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(object,intersecting){if(!object)return this;var activeSelection=this._activeObject,i,obj,idx,newIdx,objs,objsMoved=0;if(object===activeSelection&&"activeSelection"===object.type)for(objs=activeSelection._objects,i=0;i<objs.length;i++)obj=objs[i],(idx=this._objects.indexOf(obj))>0+objsMoved&&(newIdx=idx-1,removeFromArray(this._objects,obj),this._objects.splice(newIdx,0,obj)),objsMoved++;else 0!==(idx=this._objects.indexOf(object))&&(newIdx=this._findNewLowerIndex(object,idx,intersecting),removeFromArray(this._objects,object),this._objects.splice(newIdx,0,object));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(object,idx,intersecting){var newIdx,i;if(intersecting)for(newIdx=idx,i=idx-1;i>=0;--i){var isIntersecting;if(object.intersectsWithObject(this._objects[i])||object.isContainedWithinObject(this._objects[i])||this._objects[i].isContainedWithinObject(object)){newIdx=i;break}}else newIdx=idx-1;return newIdx},bringForward:function(object,intersecting){if(!object)return this;var activeSelection=this._activeObject,i,obj,idx,newIdx,objs,objsMoved=0;if(object===activeSelection&&"activeSelection"===object.type)for(i=(objs=activeSelection._objects).length;i--;)obj=objs[i],(idx=this._objects.indexOf(obj))<this._objects.length-1-objsMoved&&(newIdx=idx+1,removeFromArray(this._objects,obj),this._objects.splice(newIdx,0,obj)),objsMoved++;else(idx=this._objects.indexOf(object))!==this._objects.length-1&&(newIdx=this._findNewUpperIndex(object,idx,intersecting),removeFromArray(this._objects,object),this._objects.splice(newIdx,0,object));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(object,idx,intersecting){var newIdx,i,len;if(intersecting)for(newIdx=idx,i=idx+1,len=this._objects.length;i<len;++i){var isIntersecting;if(object.intersectsWithObject(this._objects[i])||object.isContainedWithinObject(this._objects[i])||this._objects[i].isContainedWithinObject(object)){newIdx=i;break}}else newIdx=idx+1;return newIdx},moveTo:function(object,index){return removeFromArray(this._objects,object),this._objects.splice(index,0,object),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(fabric.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(object){object.dispose&&object.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,fabric.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),extend(fabric.StaticCanvas.prototype,fabric.Observable),extend(fabric.StaticCanvas.prototype,fabric.Collection),extend(fabric.StaticCanvas.prototype,fabric.DataURLExporter),extend(fabric.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(methodName){var el=fabric.util.createCanvasElement();if(!el||!el.getContext)return null;var ctx=el.getContext("2d");if(!ctx)return null;switch(methodName){case"getImageData":return void 0!==ctx.getImageData;case"setLineDash":return void 0!==ctx.setLineDash;case"toDataURL":return void 0!==el.toDataURL;case"toDataURLWithQuality":try{return el.toDataURL("image/jpeg",0),!0}catch(e){}return!1;default:return null}}}),fabric.StaticCanvas.prototype.toJSON=fabric.StaticCanvas.prototype.toObject,fabric.isLikelyNode&&(fabric.StaticCanvas.prototype.createPNGStream=function(){var impl=fabric.util.getNodeCanvas(this.lowerCanvasEl);return impl&&impl.createPNGStream()},fabric.StaticCanvas.prototype.createJPEGStream=function(opts){var impl=fabric.util.getNodeCanvas(this.lowerCanvasEl);return impl&&impl.createJPEGStream(opts)})}}(),fabric.BaseBrush=fabric.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,setShadow:function(options){return this.shadow=new fabric.Shadow(options),this},_setBrushStyles:function(){var ctx=this.canvas.contextTop;ctx.strokeStyle=this.color,ctx.lineWidth=this.width,ctx.lineCap=this.strokeLineCap,ctx.miterLimit=this.strokeMiterLimit,ctx.lineJoin=this.strokeLineJoin,fabric.StaticCanvas.supports("setLineDash")&&ctx.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(ctx){var v=this.canvas.viewportTransform;ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5])},_setShadow:function(){if(this.shadow){var ctx=this.canvas.contextTop,zoom=this.canvas.getZoom();ctx.shadowColor=this.shadow.color,ctx.shadowBlur=this.shadow.blur*zoom,ctx.shadowOffsetX=this.shadow.offsetX*zoom,ctx.shadowOffsetY=this.shadow.offsetY*zoom}},_resetShadow:function(){var ctx=this.canvas.contextTop;ctx.shadowColor="",ctx.shadowBlur=ctx.shadowOffsetX=ctx.shadowOffsetY=0}}),fabric.PencilBrush=fabric.util.createClass(fabric.BaseBrush,{initialize:function(canvas){this.canvas=canvas,this._points=[]},_drawSegment:function(ctx,p1,p2){var midPoint=p1.midPointFrom(p2);return ctx.quadraticCurveTo(p1.x,p1.y,midPoint.x,midPoint.y),midPoint},onMouseDown:function(pointer){this._prepareForDrawing(pointer),this._captureDrawingPath(pointer),this._render()},onMouseMove:function(pointer){if(this._captureDrawingPath(pointer)&&this._points.length>1)if(this.needsFullRender)this.canvas.clearContext(this.canvas.contextTop),this._render();else{var points=this._points,length=points.length,ctx=this.canvas.contextTop;this._saveAndTransform(ctx),this.oldEnd&&(ctx.beginPath(),ctx.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(ctx,points[length-2],points[length-1],!0),ctx.stroke(),ctx.restore()}},onMouseUp:function(){this.oldEnd=void 0,this._finalizeAndAddPath()},_prepareForDrawing:function(pointer){var p=new fabric.Point(pointer.x,pointer.y);this._reset(),this._addPoint(p),this.canvas.contextTop.moveTo(p.x,p.y)},_addPoint:function(point){return!(this._points.length>1&&point.eq(this._points[this._points.length-1])||(this._points.push(point),0))},_reset:function(){this._points.length=0,this._setBrushStyles();var color=new fabric.Color(this.color);this.needsFullRender=color.getAlpha()<1,this._setShadow()},_captureDrawingPath:function(pointer){var pointerPoint=new fabric.Point(pointer.x,pointer.y);return this._addPoint(pointerPoint)},_render:function(){var ctx=this.canvas.contextTop,i,len,p1=this._points[0],p2=this._points[1];if(this._saveAndTransform(ctx),ctx.beginPath(),2===this._points.length&&p1.x===p2.x&&p1.y===p2.y){var width=this.width/1e3;p1=new fabric.Point(p1.x,p1.y),p2=new fabric.Point(p2.x,p2.y),p1.x-=width,p2.x+=width}for(ctx.moveTo(p1.x,p1.y),i=1,len=this._points.length;i<len;i++)this._drawSegment(ctx,p1,p2),p1=this._points[i],p2=this._points[i+1];ctx.lineTo(p1.x,p1.y),ctx.stroke(),ctx.restore()},convertPointsToSVGPath:function(points){var path=[],i,width=this.width/1e3,p1=new fabric.Point(points[0].x,points[0].y),p2=new fabric.Point(points[1].x,points[1].y),len=points.length,multSignX=1,multSignY=1,manyPoints=len>2;for(manyPoints&&(multSignX=points[2].x<p2.x?-1:points[2].x===p2.x?0:1,multSignY=points[2].y<p2.y?-1:points[2].y===p2.y?0:1),path.push("M ",p1.x-multSignX*width," ",p1.y-multSignY*width," "),i=1;i<len;i++){if(!p1.eq(p2)){var midPoint=p1.midPointFrom(p2);path.push("Q ",p1.x," ",p1.y," ",midPoint.x," ",midPoint.y," ")}p1=points[i],i+1<points.length&&(p2=points[i+1])}return manyPoints&&(multSignX=p1.x>points[i-2].x?1:p1.x===points[i-2].x?0:-1,multSignY=p1.y>points[i-2].y?1:p1.y===points[i-2].y?0:-1),path.push("L ",p1.x+multSignX*width," ",p1.y+multSignY*width),path},createPath:function(pathData){var path=new fabric.Path(pathData,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray}),position=new fabric.Point(path.left+path.width/2,path.top+path.height/2);return position=path.translateToGivenOrigin(position,"center","center",path.originX,path.originY),path.top=position.y,path.left=position.x,this.shadow&&(this.shadow.affectStroke=!0,path.setShadow(this.shadow)),path},_finalizeAndAddPath:function(){var ctx;this.canvas.contextTop.closePath();var pathData=this.convertPointsToSVGPath(this._points).join("");if("M 0 0 Q 0 0 0 0 L 0 0"!==pathData){var path=this.createPath(pathData);this.canvas.clearContext(this.canvas.contextTop),this.canvas.add(path),this.canvas.renderAll(),path.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:path})}else this.canvas.requestRenderAll()}}),fabric.CircleBrush=fabric.util.createClass(fabric.BaseBrush,{width:10,initialize:function(canvas){this.canvas=canvas,this.points=[]},drawDot:function(pointer){var point=this.addPoint(pointer),ctx=this.canvas.contextTop;this._saveAndTransform(ctx),ctx.fillStyle=point.fill,ctx.beginPath(),ctx.arc(point.x,point.y,point.radius,0,2*Math.PI,!1),ctx.closePath(),ctx.fill(),ctx.restore()},onMouseDown:function(pointer){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(pointer)},_render:function(){var ctx=this.canvas.contextTop,i,len,points=this.points,point;for(this._saveAndTransform(ctx),i=0,len=points.length;i<len;i++)point=points[i],ctx.fillStyle=point.fill,ctx.beginPath(),ctx.arc(point.x,point.y,point.radius,0,2*Math.PI,!1),ctx.closePath(),ctx.fill();ctx.restore()},onMouseMove:function(pointer){this.drawDot(pointer)},onMouseUp:function(){var originalRenderOnAddRemove=this.canvas.renderOnAddRemove,i,len;this.canvas.renderOnAddRemove=!1;var circles=[];for(i=0,len=this.points.length;i<len;i++){var point=this.points[i],circle=new fabric.Circle({radius:point.radius,left:point.x,top:point.y,originX:"center",originY:"center",fill:point.fill});this.shadow&&circle.setShadow(this.shadow),circles.push(circle)}var group=new fabric.Group(circles);group.canvas=this.canvas,this.canvas.add(group),this.canvas.fire("path:created",{path:group}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=originalRenderOnAddRemove,this.canvas.requestRenderAll()},addPoint:function(pointer){var pointerPoint=new fabric.Point(pointer.x,pointer.y),circleRadius=fabric.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,circleColor=new fabric.Color(this.color).setAlpha(fabric.util.getRandomInt(0,100)/100).toRgba();return pointerPoint.radius=circleRadius,pointerPoint.fill=circleColor,this.points.push(pointerPoint),pointerPoint}}),fabric.SprayBrush=fabric.util.createClass(fabric.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(canvas){this.canvas=canvas,this.sprayChunks=[]},onMouseDown:function(pointer){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(pointer),this.render(this.sprayChunkPoints)},onMouseMove:function(pointer){this.addSprayChunk(pointer),this.render(this.sprayChunkPoints)},onMouseUp:function(){var originalRenderOnAddRemove=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var rects=[],i=0,ilen=this.sprayChunks.length;i<ilen;i++)for(var sprayChunk=this.sprayChunks[i],j=0,jlen=sprayChunk.length;j<jlen;j++){var rect=new fabric.Rect({width:sprayChunk[j].width,height:sprayChunk[j].width,left:sprayChunk[j].x+1,top:sprayChunk[j].y+1,originX:"center",originY:"center",fill:this.color});rects.push(rect)}this.optimizeOverlapping&&(rects=this._getOptimizedRects(rects));var group=new fabric.Group(rects);this.shadow&&group.setShadow(this.shadow),this.canvas.add(group),this.canvas.fire("path:created",{path:group}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=originalRenderOnAddRemove,this.canvas.requestRenderAll()},_getOptimizedRects:function(rects){var uniqueRects={},key,i,len;for(i=0,len=rects.length;i<len;i++)uniqueRects[key=rects[i].left+""+rects[i].top]||(uniqueRects[key]=rects[i]);var uniqueRectsArray=[];for(key in uniqueRects)uniqueRectsArray.push(uniqueRects[key]);return uniqueRectsArray},render:function(sprayChunk){var ctx=this.canvas.contextTop,i,len;for(ctx.fillStyle=this.color,this._saveAndTransform(ctx),i=0,len=sprayChunk.length;i<len;i++){var point=sprayChunk[i];void 0!==point.opacity&&(ctx.globalAlpha=point.opacity),ctx.fillRect(point.x,point.y,point.width,point.width)}ctx.restore()},_render:function(){var ctx=this.canvas.contextTop,i,ilen;for(ctx.fillStyle=this.color,this._saveAndTransform(ctx),i=0,ilen=this.sprayChunks.length;i<ilen;i++)this.render(this.sprayChunks[i]);ctx.restore()},addSprayChunk:function(pointer){this.sprayChunkPoints=[];var x,y,width,radius=this.width/2,i;for(i=0;i<this.density;i++){x=fabric.util.getRandomInt(pointer.x-radius,pointer.x+radius),y=fabric.util.getRandomInt(pointer.y-radius,pointer.y+radius),width=this.dotWidthVariance?fabric.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var point=new fabric.Point(x,y);point.width=width,this.randomOpacity&&(point.opacity=fabric.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(point)}this.sprayChunks.push(this.sprayChunkPoints)}}),fabric.PatternBrush=fabric.util.createClass(fabric.PencilBrush,{getPatternSrc:function(){var dotWidth=20,dotDistance=5,patternCanvas=fabric.util.createCanvasElement(),patternCtx=patternCanvas.getContext("2d");return patternCanvas.width=patternCanvas.height=25,patternCtx.fillStyle=this.color,patternCtx.beginPath(),patternCtx.arc(10,10,10,0,2*Math.PI,!1),patternCtx.closePath(),patternCtx.fill(),patternCanvas},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(){return this.canvas.contextTop.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(){this.callSuper("_setBrushStyles"),this.canvas.contextTop.strokeStyle=this.getPattern()},createPath:function(pathData){var path=this.callSuper("createPath",pathData),topLeft=path._getLeftTopCoords().scalarAdd(path.strokeWidth/2);return path.stroke=new fabric.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-topLeft.x,offsetY:-topLeft.y}),path}}),function(){var getPointer=fabric.util.getPointer,degreesToRadians=fabric.util.degreesToRadians,radiansToDegrees=fabric.util.radiansToDegrees,atan2=Math.atan2,abs=Math.abs,supportLineDash=fabric.StaticCanvas.supports("setLineDash"),STROKE_OFFSET=.5;for(var prop in fabric.Canvas=fabric.util.createClass(fabric.StaticCanvas,{initialize:function(el,options){options||(options={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(el,options),this._initInteractive(),this._createCacheCanvas()},uniScaleTransform:!1,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=fabric.PencilBrush&&new fabric.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var activeObjects=this.getActiveObjects(),object,objsToRender,activeGroupObjects;if(activeObjects.length>0&&!this.preserveObjectStacking){objsToRender=[],activeGroupObjects=[];for(var i=0,length=this._objects.length;i<length;i++)object=this._objects[i],-1===activeObjects.indexOf(object)?objsToRender.push(object):activeGroupObjects.push(object);activeObjects.length>1&&(this._activeObject._objects=activeGroupObjects),objsToRender.push.apply(objsToRender,activeGroupObjects)}else objsToRender=this._objects;return objsToRender},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&this.renderTopLayer(this.contextTop);var canvasToDrawOn=this.contextContainer;return this.renderCanvas(canvasToDrawOn,this._chooseObjectsToRender()),this},renderTopLayer:function(ctx){this.isDrawingMode&&this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.selection&&this._groupSelector&&this._drawSelection(ctx)},renderTop:function(){var ctx=this.contextTop;return this.clearContext(ctx),this.renderTopLayer(ctx),this.fire("after:render"),this.contextTopDirty=!0,this},_resetCurrentTransform:function(){var t=this._currentTransform;t.target.set({scaleX:t.original.scaleX,scaleY:t.original.scaleY,skewX:t.original.skewX,skewY:t.original.skewY,left:t.original.left,top:t.original.top}),this._shouldCenterTransform(t.target)?("center"!==t.originX&&("right"===t.originX?t.mouseXSign=-1:t.mouseXSign=1),"center"!==t.originY&&("bottom"===t.originY?t.mouseYSign=-1:t.mouseYSign=1),t.originX="center",t.originY="center"):(t.originX=t.original.originX,t.originY=t.original.originY)},containsPoint:function(e,target,point){var ignoreZoom=!0,pointer=point||this.getPointer(e,!0),xy;return xy=target.group&&target.group===this._activeObject&&"activeSelection"===target.group.type?this._normalizePointer(target.group,pointer):{x:pointer.x,y:pointer.y},target.containsPoint(xy)||target._findTargetCorner(pointer)},_normalizePointer:function(object,pointer){var m=object.calcTransformMatrix(),invertedM=fabric.util.invertTransform(m),vptPointer=this.restorePointerVpt(pointer);return fabric.util.transformPoint(vptPointer,invertedM)},isTargetTransparent:function(target,x,y){if(target.shouldCache()&&target._cacheCanvas){var normalizedPointer=this._normalizePointer(target,{x:x,y:y}),targetRelativeX=target.cacheTranslationX+normalizedPointer.x*target.zoomX,targetRelativeY=target.cacheTranslationY+normalizedPointer.y*target.zoomY,isTransparent;return isTransparent=fabric.util.isTransparent(target._cacheContext,targetRelativeX,targetRelativeY,this.targetFindTolerance)}var ctx=this.contextCache,originalColor=target.selectionBackgroundColor,v=this.viewportTransform,isTransparent;return target.selectionBackgroundColor="",this.clearContext(ctx),ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5]),target.render(ctx),ctx.restore(),target===this._activeObject&&target._renderControls(ctx,{hasBorders:!1,transparentCorners:!1},{hasBorders:!1}),target.selectionBackgroundColor=originalColor,isTransparent=fabric.util.isTransparent(ctx,x,y,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){var selectionKeyPressed=!1;return selectionKeyPressed="[object Array]"===Object.prototype.toString.call(this.selectionKey)?!!this.selectionKey.find(function(key){return!0===e[key]}):e[this.selectionKey]},_shouldClearSelection:function(e,target){var activeObjects=this.getActiveObjects(),activeObject=this._activeObject;return!target||target&&activeObject&&activeObjects.length>1&&-1===activeObjects.indexOf(target)&&activeObject!==target&&!this._isSelectionKeyPressed(e)||target&&!target.evented||target&&!target.selectable&&activeObject&&activeObject!==target},_shouldCenterTransform:function(target){if(target){var t=this._currentTransform,centerTransform;return"scale"===t.action||"scaleX"===t.action||"scaleY"===t.action?centerTransform=this.centeredScaling||target.centeredScaling:"rotate"===t.action&&(centerTransform=this.centeredRotation||target.centeredRotation),centerTransform?!t.altKey:t.altKey}},_getOriginFromCorner:function(target,corner){var origin={x:target.originX,y:target.originY};return"ml"===corner||"tl"===corner||"bl"===corner?origin.x="right":"mr"!==corner&&"tr"!==corner&&"br"!==corner||(origin.x="left"),"tl"===corner||"mt"===corner||"tr"===corner?origin.y="bottom":"bl"!==corner&&"mb"!==corner&&"br"!==corner||(origin.y="top"),origin},_getActionFromCorner:function(target,corner,e){if(!corner)return"drag";switch(corner){case"mtr":return"rotate";case"ml":case"mr":return e[this.altActionKey]?"skewY":"scaleX";case"mt":case"mb":return e[this.altActionKey]?"skewX":"scaleY";default:return"scale"}},_setupCurrentTransform:function(e,target){if(target){var pointer=this.getPointer(e),corner=target._findTargetCorner(this.getPointer(e,!0)),action=this._getActionFromCorner(target,corner,e),origin=this._getOriginFromCorner(target,corner);this._currentTransform={target:target,action:action,corner:corner,scaleX:target.scaleX,scaleY:target.scaleY,skewX:target.skewX,skewY:target.skewY,offsetX:pointer.x-target.left,offsetY:pointer.y-target.top,originX:origin.x,originY:origin.y,ex:pointer.x,ey:pointer.y,lastX:pointer.x,lastY:pointer.y,theta:degreesToRadians(target.angle),width:target.width*target.scaleX,mouseXSign:1,mouseYSign:1,shiftKey:e.shiftKey,altKey:e[this.centeredKey],original:fabric.util.saveObjectTransform(target)},this._currentTransform.original.originX=origin.x,this._currentTransform.original.originY=origin.y,this._resetCurrentTransform(),this._beforeTransform(e)}},_translateObject:function(x,y){var transform=this._currentTransform,target=transform.target,newLeft=x-transform.offsetX,newTop=y-transform.offsetY,moveX=!target.get("lockMovementX")&&target.left!==newLeft,moveY=!target.get("lockMovementY")&&target.top!==newTop;return moveX&&target.set("left",newLeft),moveY&&target.set("top",newTop),moveX||moveY},_changeSkewTransformOrigin:function(mouseMove,t,by){var property="originX",origins={0:"center"},skew=t.target.skewX,originA="left",originB="right",corner="mt"===t.corner||"ml"===t.corner?1:-1,flipSign=1;mouseMove=mouseMove>0?1:-1,"y"===by&&(skew=t.target.skewY,originA="top",originB="bottom",property="originY"),origins[-1]=originA,origins[1]=originB,t.target.flipX&&(flipSign*=-1),t.target.flipY&&(flipSign*=-1),0===skew?(t.skewSign=-corner*mouseMove*flipSign,t[property]=origins[-mouseMove]):(skew=skew>0?1:-1,t.skewSign=skew,t[property]=origins[skew*corner*flipSign])},_skewObject:function(x,y,by){var t=this._currentTransform,target=t.target,skewed=!1,lockSkewingX=target.get("lockSkewingX"),lockSkewingY=target.get("lockSkewingY");if(lockSkewingX&&"x"===by||lockSkewingY&&"y"===by)return!1;var center=target.getCenterPoint(),actualMouseByCenter=target.toLocalPoint(new fabric.Point(x,y),"center","center")[by],lastMouseByCenter=target.toLocalPoint(new fabric.Point(t.lastX,t.lastY),"center","center")[by],actualMouseByOrigin,constraintPosition,dim=target._getTransformedDimensions();return this._changeSkewTransformOrigin(actualMouseByCenter-lastMouseByCenter,t,by),actualMouseByOrigin=target.toLocalPoint(new fabric.Point(x,y),t.originX,t.originY)[by],constraintPosition=target.translateToOriginPoint(center,t.originX,t.originY),skewed=this._setObjectSkew(actualMouseByOrigin,t,by,dim),t.lastX=x,t.lastY=y,target.setPositionByOrigin(constraintPosition,t.originX,t.originY),skewed},_setObjectSkew:function(localMouse,transform,by,_dim){var target=transform.target,newValue,skewed=!1,skewSign=transform.skewSign,newDim,dimNoSkew,otherBy,_otherBy,_by,newDimMouse,skewX,skewY;return"x"===by?(otherBy="y",_otherBy="Y",_by="X",skewX=0,skewY=target.skewY):(otherBy="x",_otherBy="X",_by="Y",skewX=target.skewX,skewY=0),dimNoSkew=target._getTransformedDimensions(skewX,skewY),(newDimMouse=2*Math.abs(localMouse)-dimNoSkew[by])<=2?newValue=0:(newValue=skewSign*Math.atan(newDimMouse/target["scale"+_by]/(dimNoSkew[otherBy]/target["scale"+_otherBy])),newValue=fabric.util.radiansToDegrees(newValue)),skewed=target["skew"+_by]!==newValue,target.set("skew"+_by,newValue),0!==target["skew"+_otherBy]&&(newDim=target._getTransformedDimensions(),newValue=_dim[otherBy]/newDim[otherBy]*target["scale"+_otherBy],target.set("scale"+_otherBy,newValue)),skewed},_scaleObject:function(x,y,by){var t=this._currentTransform,target=t.target,lockScalingX=target.lockScalingX,lockScalingY=target.lockScalingY,lockScalingFlip=target.lockScalingFlip;if(lockScalingX&&lockScalingY)return!1;var constraintPosition=target.translateToOriginPoint(target.getCenterPoint(),t.originX,t.originY),localMouse=target.toLocalPoint(new fabric.Point(x,y),t.originX,t.originY),dim=target._getTransformedDimensions(),scaled=!1;return this._setLocalMouse(localMouse,t),scaled=this._setObjectScale(localMouse,t,lockScalingX,lockScalingY,by,lockScalingFlip,dim),target.setPositionByOrigin(constraintPosition,t.originX,t.originY),scaled},_setObjectScale:function(localMouse,transform,lockScalingX,lockScalingY,by,lockScalingFlip,_dim){var target=transform.target,forbidScalingX=!1,forbidScalingY=!1,scaled=!1,changeX,changeY,scaleX,scaleY;return scaleX=localMouse.x*target.scaleX/_dim.x,scaleY=localMouse.y*target.scaleY/_dim.y,changeX=target.scaleX!==scaleX,changeY=target.scaleY!==scaleY,lockScalingFlip&&scaleX<=0&&scaleX<target.scaleX&&(forbidScalingX=!0,localMouse.x=0),lockScalingFlip&&scaleY<=0&&scaleY<target.scaleY&&(forbidScalingY=!0,localMouse.y=0),"equally"!==by||lockScalingX||lockScalingY?by?"x"!==by||target.get("lockUniScaling")?"y"!==by||target.get("lockUniScaling")||forbidScalingY||lockScalingY||target.set("scaleY",scaleY)&&(scaled=scaled||changeY):forbidScalingX||lockScalingX||target.set("scaleX",scaleX)&&(scaled=scaled||changeX):(forbidScalingX||lockScalingX||target.set("scaleX",scaleX)&&(scaled=scaled||changeX),forbidScalingY||lockScalingY||target.set("scaleY",scaleY)&&(scaled=scaled||changeY)):scaled=this._scaleObjectEqually(localMouse,target,transform,_dim),transform.newScaleX=scaleX,transform.newScaleY=scaleY,forbidScalingX||forbidScalingY||this._flipObject(transform,by),scaled},_scaleObjectEqually:function(localMouse,target,transform,_dim){var dist=localMouse.y+localMouse.x,lastDist=_dim.y*transform.original.scaleY/target.scaleY+_dim.x*transform.original.scaleX/target.scaleX,scaled,signX=localMouse.x<0?-1:1,signY=localMouse.y<0?-1:1;return transform.newScaleX=signX*Math.abs(transform.original.scaleX*dist/lastDist),transform.newScaleY=signY*Math.abs(transform.original.scaleY*dist/lastDist),scaled=transform.newScaleX!==target.scaleX||transform.newScaleY!==target.scaleY,target.set("scaleX",transform.newScaleX),target.set("scaleY",transform.newScaleY),scaled},_flipObject:function(transform,by){transform.newScaleX<0&&"y"!==by&&("left"===transform.originX?transform.originX="right":"right"===transform.originX&&(transform.originX="left")),transform.newScaleY<0&&"x"!==by&&("top"===transform.originY?transform.originY="bottom":"bottom"===transform.originY&&(transform.originY="top"))},_setLocalMouse:function(localMouse,t){var target=t.target,zoom=this.getZoom(),padding=target.padding/zoom;"right"===t.originX?localMouse.x*=-1:"center"===t.originX&&(localMouse.x*=2*t.mouseXSign,localMouse.x<0&&(t.mouseXSign=-t.mouseXSign)),"bottom"===t.originY?localMouse.y*=-1:"center"===t.originY&&(localMouse.y*=2*t.mouseYSign,localMouse.y<0&&(t.mouseYSign=-t.mouseYSign)),abs(localMouse.x)>padding?localMouse.x<0?localMouse.x+=padding:localMouse.x-=padding:localMouse.x=0,abs(localMouse.y)>padding?localMouse.y<0?localMouse.y+=padding:localMouse.y-=padding:localMouse.y=0},_rotateObject:function(x,y){var t=this._currentTransform,target=t.target,constraintPosition,constraintPosition=target.translateToOriginPoint(target.getCenterPoint(),t.originX,t.originY);if(target.lockRotation)return!1;var lastAngle=atan2(t.ey-constraintPosition.y,t.ex-constraintPosition.x),curAngle=atan2(y-constraintPosition.y,x-constraintPosition.x),angle=radiansToDegrees(curAngle-lastAngle+t.theta),hasRotated=!0;if(target.snapAngle>0){var snapAngle=target.snapAngle,snapThreshold=target.snapThreshold||snapAngle,rightAngleLocked=Math.ceil(angle/snapAngle)*snapAngle,leftAngleLocked=Math.floor(angle/snapAngle)*snapAngle;Math.abs(angle-leftAngleLocked)<snapThreshold?angle=leftAngleLocked:Math.abs(angle-rightAngleLocked)<snapThreshold&&(angle=rightAngleLocked)}return angle<0&&(angle=360+angle),angle%=360,target.angle===angle?hasRotated=!1:(target.angle=angle,target.setPositionByOrigin(constraintPosition,t.originX,t.originY)),hasRotated},setCursor:function(value){this.upperCanvasEl.style.cursor=value},_drawSelection:function(ctx){var groupSelector=this._groupSelector,left=groupSelector.left,top=groupSelector.top,aleft=abs(left),atop=abs(top);if(this.selectionColor&&(ctx.fillStyle=this.selectionColor,ctx.fillRect(groupSelector.ex-(left>0?0:-left),groupSelector.ey-(top>0?0:-top),aleft,atop)),this.selectionLineWidth&&this.selectionBorderColor)if(ctx.lineWidth=this.selectionLineWidth,ctx.strokeStyle=this.selectionBorderColor,this.selectionDashArray.length>1&&!supportLineDash){var px=groupSelector.ex+.5-(left>0?0:aleft),py=groupSelector.ey+.5-(top>0?0:atop);ctx.beginPath(),fabric.util.drawDashedLine(ctx,px,py,px+aleft,py,this.selectionDashArray),fabric.util.drawDashedLine(ctx,px,py+atop-1,px+aleft,py+atop-1,this.selectionDashArray),fabric.util.drawDashedLine(ctx,px,py,px,py+atop,this.selectionDashArray),fabric.util.drawDashedLine(ctx,px+aleft-1,py,px+aleft-1,py+atop,this.selectionDashArray),ctx.closePath(),ctx.stroke()}else fabric.Object.prototype._setLineDash.call(this,ctx,this.selectionDashArray),ctx.strokeRect(groupSelector.ex+.5-(left>0?0:aleft),groupSelector.ey+.5-(top>0?0:atop),aleft,atop)},findTarget:function(e,skipGroup){if(!this.skipTargetFind){var ignoreZoom=!0,pointer=this.getPointer(e,!0),activeObject=this._activeObject,aObjects=this.getActiveObjects(),activeTarget,activeTargetSubs;if(this.targets=[],aObjects.length>1&&!skipGroup&&activeObject===this._searchPossibleTargets([activeObject],pointer))return activeObject;if(1===aObjects.length&&activeObject._findTargetCorner(pointer))return activeObject;if(1===aObjects.length&&activeObject===this._searchPossibleTargets([activeObject],pointer)){if(!this.preserveObjectStacking)return activeObject;activeTarget=activeObject,activeTargetSubs=this.targets,this.targets=[]}var target=this._searchPossibleTargets(this._objects,pointer);return e[this.altSelectionKey]&&target&&activeTarget&&target!==activeTarget&&(target=activeTarget,this.targets=activeTargetSubs),target}},_checkTarget:function(pointer,obj){if(obj&&obj.visible&&obj.evented&&this.containsPoint(null,obj,pointer)){if(!this.perPixelTargetFind&&!obj.perPixelTargetFind||obj.isEditing)return!0;var isTransparent;if(!this.isTargetTransparent(obj,pointer.x,pointer.y))return!0}},_searchPossibleTargets:function(objects,pointer){for(var target,i=objects.length,normalizedPointer,subTarget;i--;)if(this._checkTarget(pointer,objects[i])){(target=objects[i]).subTargetCheck&&target instanceof fabric.Group&&(normalizedPointer=this._normalizePointer(target,pointer),(subTarget=this._searchPossibleTargets(target._objects,normalizedPointer))&&this.targets.push(subTarget));break}return target},restorePointerVpt:function(pointer){return fabric.util.transformPoint(pointer,fabric.util.invertTransform(this.viewportTransform))},getPointer:function(e,ignoreZoom){if(this._absolutePointer&&!ignoreZoom)return this._absolutePointer;if(this._pointer&&ignoreZoom)return this._pointer;var pointer=getPointer(e),upperCanvasEl=this.upperCanvasEl,bounds=upperCanvasEl.getBoundingClientRect(),boundsWidth=bounds.width||0,boundsHeight=bounds.height||0,cssScale;return boundsWidth&&boundsHeight||("top"in bounds&&"bottom"in bounds&&(boundsHeight=Math.abs(bounds.top-bounds.bottom)),"right"in bounds&&"left"in bounds&&(boundsWidth=Math.abs(bounds.right-bounds.left))),this.calcOffset(),pointer.x=pointer.x-this._offset.left,pointer.y=pointer.y-this._offset.top,ignoreZoom||(pointer=this.restorePointerVpt(pointer)),cssScale=0===boundsWidth||0===boundsHeight?{width:1,height:1}:{width:upperCanvasEl.width/boundsWidth,height:upperCanvasEl.height/boundsHeight},{x:pointer.x*cssScale.width,y:pointer.y*cssScale.height}},_createUpperCanvas:function(){var lowerCanvasClass=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,"");this.upperCanvasEl?this.upperCanvasEl.className="":this.upperCanvasEl=this._createCanvasElement(),fabric.util.addClass(this.upperCanvasEl,"upper-canvas "+lowerCanvasClass),this.wrapperEl.appendChild(this.upperCanvasEl),this._copyCanvasStyle(this.lowerCanvasEl,this.upperCanvasEl),this._applyCanvasStyle(this.upperCanvasEl),this.contextTop=this.upperCanvasEl.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=fabric.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),fabric.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),fabric.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(element){var width=this.width||element.width,height=this.height||element.height;fabric.util.setStyle(element,{position:"absolute",width:width+"px",height:height+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none"}),element.width=width,element.height=height,fabric.util.makeElementUnselectable(element)},_copyCanvasStyle:function(fromEl,toEl){toEl.style.cssText=fromEl.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var active=this._activeObject;return active?"activeSelection"===active.type&&active._objects?active._objects.slice(0):[active]:[]},_onObjectRemoved:function(obj){obj===this._activeObject&&(this.fire("before:selection:cleared",{target:obj}),this._discardActiveObject(),this.fire("selection:cleared",{target:obj}),obj.fire("deselected")),this._hoveredTarget===obj&&(this._hoveredTarget=null),this.callSuper("_onObjectRemoved",obj)},_fireSelectionEvents:function(oldObjects,e){var somethingChanged=!1,objects=this.getActiveObjects(),added=[],removed=[],opt={e:e};oldObjects.forEach(function(oldObject){-1===objects.indexOf(oldObject)&&(somethingChanged=!0,oldObject.fire("deselected",opt),removed.push(oldObject))}),objects.forEach(function(object){-1===oldObjects.indexOf(object)&&(somethingChanged=!0,object.fire("selected",opt),added.push(object))}),oldObjects.length>0&&objects.length>0?(opt.selected=added,opt.deselected=removed,opt.updated=added[0]||removed[0],opt.target=this._activeObject,somethingChanged&&this.fire("selection:updated",opt)):objects.length>0?(1===objects.length&&(opt.target=added[0],this.fire("object:selected",opt)),opt.selected=added,opt.target=this._activeObject,this.fire("selection:created",opt)):oldObjects.length>0&&(opt.deselected=removed,this.fire("selection:cleared",opt))},setActiveObject:function(object,e){var currentActives=this.getActiveObjects();return this._setActiveObject(object,e),this._fireSelectionEvents(currentActives,e),this},_setActiveObject:function(object,e){return this._activeObject!==object&&(!!this._discardActiveObject(e,object)&&(!object.onSelect({e:e})&&(this._activeObject=object,!0)))},_discardActiveObject:function(e,object){var obj=this._activeObject;if(obj){if(obj.onDeselect({e:e,object:object}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var currentActives=this.getActiveObjects();return currentActives.length&&this.fire("before:selection:cleared",{target:currentActives[0],e:e}),this._discardActiveObject(e),this._fireSelectionEvents(currentActives,e),this},dispose:function(){var wrapper=this.wrapperEl;return this.removeListeners(),wrapper.removeChild(this.upperCanvasEl),wrapper.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(element){fabric.util.cleanUpJsdomNode(this[element]),this[element]=void 0}.bind(this)),wrapper.parentNode&&wrapper.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,fabric.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(ctx){var activeObject=this._activeObject;activeObject&&activeObject._renderControls(ctx)},_toObject:function(instance,methodName,propertiesToInclude){var originalProperties=this._realizeGroupTransformOnObject(instance),object=this.callSuper("_toObject",instance,methodName,propertiesToInclude);return this._unwindGroupTransformOnObject(instance,originalProperties),object},_realizeGroupTransformOnObject:function(instance){if(instance.group&&"activeSelection"===instance.group.type&&this._activeObject===instance.group){var layoutProps,originalValues={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(prop){originalValues[prop]=instance[prop]}),this._activeObject.realizeTransform(instance),originalValues}return null},_unwindGroupTransformOnObject:function(instance,originalValues){originalValues&&instance.set(originalValues)},_setSVGObject:function(markup,instance,reviver){var originalProperties=this._realizeGroupTransformOnObject(instance);this.callSuper("_setSVGObject",markup,instance,reviver),this._unwindGroupTransformOnObject(instance,originalProperties)},setViewportTransform:function(vpt){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),fabric.StaticCanvas.prototype.setViewportTransform.call(this,vpt)}}),fabric.StaticCanvas)"prototype"!==prop&&(fabric.Canvas[prop]=fabric.StaticCanvas[prop]);fabric.isTouchSupported&&(fabric.Canvas.prototype._setCursorFromEvent=function(){})}(),function(){var cursorOffset={mt:0,tr:1,mr:2,br:3,mb:4,bl:5,ml:6,tl:7},addListener=fabric.util.addListener,removeListener=fabric.util.removeListener,RIGHT_CLICK=3,MIDDLE_CLICK=2,LEFT_CLICK=1,addEventOptions={passive:!1};function checkClick(e,value){return"which"in e?e.which===value:e.button===value-1}fabric.util.object.extend(fabric.Canvas.prototype,{cursorMap:["n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize","nw-resize"],_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(addListener,"add")},addOrRemove:function(functor,eventjsFunctor){functor(fabric.window,"resize",this._onResize),functor(this.upperCanvasEl,"mousedown",this._onMouseDown),functor(this.upperCanvasEl,"mousemove",this._onMouseMove,addEventOptions),functor(this.upperCanvasEl,"mouseout",this._onMouseOut),functor(this.upperCanvasEl,"mouseenter",this._onMouseEnter),functor(this.upperCanvasEl,"wheel",this._onMouseWheel),functor(this.upperCanvasEl,"contextmenu",this._onContextMenu),functor(this.upperCanvasEl,"dblclick",this._onDoubleClick),functor(this.upperCanvasEl,"touchstart",this._onMouseDown,addEventOptions),functor(this.upperCanvasEl,"touchmove",this._onMouseMove,addEventOptions),functor(this.upperCanvasEl,"dragover",this._onDragOver),functor(this.upperCanvasEl,"dragenter",this._onDragEnter),functor(this.upperCanvasEl,"dragleave",this._onDragLeave),functor(this.upperCanvasEl,"drop",this._onDrop),"undefined"!=typeof eventjs&&eventjsFunctor in eventjs&&(eventjs[eventjsFunctor](this.upperCanvasEl,"gesture",this._onGesture),eventjs[eventjsFunctor](this.upperCanvasEl,"drag",this._onDrag),eventjs[eventjsFunctor](this.upperCanvasEl,"orientation",this._onOrientationChange),eventjs[eventjsFunctor](this.upperCanvasEl,"shake",this._onShake),eventjs[eventjsFunctor](this.upperCanvasEl,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(removeListener,"remove"),removeListener(fabric.document,"mouseup",this._onMouseUp),removeListener(fabric.document,"touchend",this._onMouseUp,addEventOptions),removeListener(fabric.document,"mousemove",this._onMouseMove,addEventOptions),removeListener(fabric.document,"touchmove",this._onMouseMove,addEventOptions)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._simpleEventHandler.bind(this,"drop"),this.eventsBound=!0)},_onGesture:function(e,self){this.__onTransformGesture&&this.__onTransformGesture(e,self)},_onDrag:function(e,self){this.__onDrag&&this.__onDrag(e,self)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(e){var target=this._hoveredTarget;this.fire("mouse:out",{target:target,e:e}),this._hoveredTarget=null,target&&target.fire("mouseout",{e:e}),this._iTextInstances&&this._iTextInstances.forEach(function(obj){obj.isEditing&&obj.hiddenTextarea.focus()})},_onMouseEnter:function(e){this.findTarget(e)||(this.fire("mouse:over",{target:null,e:e}),this._hoveredTarget=null)},_onOrientationChange:function(e,self){this.__onOrientationChange&&this.__onOrientationChange(e,self)},_onShake:function(e,self){this.__onShake&&this.__onShake(e,self)},_onLongPress:function(e,self){this.__onLongPress&&this.__onLongPress(e,self)},_onDragOver:function(e){e.preventDefault();var target=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(target,e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData(),addListener(fabric.document,"touchend",this._onMouseUp,addEventOptions),addListener(fabric.document,"touchmove",this._onMouseMove,addEventOptions),removeListener(this.upperCanvasEl,"mousemove",this._onMouseMove,addEventOptions),removeListener(this.upperCanvasEl,"touchmove",this._onMouseMove,addEventOptions),"touchstart"===e.type?removeListener(this.upperCanvasEl,"mousedown",this._onMouseDown):(addListener(fabric.document,"mouseup",this._onMouseUp),addListener(fabric.document,"mousemove",this._onMouseMove,addEventOptions))},_onMouseUp:function(e){if(this.__onMouseUp(e),this._resetTransformEventData(),removeListener(fabric.document,"mouseup",this._onMouseUp),removeListener(fabric.document,"touchend",this._onMouseUp,addEventOptions),removeListener(fabric.document,"mousemove",this._onMouseMove,addEventOptions),removeListener(fabric.document,"touchmove",this._onMouseMove,addEventOptions),addListener(this.upperCanvasEl,"mousemove",this._onMouseMove,addEventOptions),addListener(this.upperCanvasEl,"touchmove",this._onMouseMove,addEventOptions),"touchend"===e.type){var _this=this;setTimeout(function(){addListener(_this.upperCanvasEl,"mousedown",_this._onMouseDown)},400)}},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(target,pointer){var activeObject=this._activeObject;return(!activeObject||!activeObject.isEditing||target!==activeObject)&&!!(target&&(target.isMoving||target!==activeObject)||!target&&activeObject||!target&&!activeObject&&!this._groupSelector||pointer&&this._previousPointer&&this.selection&&(pointer.x!==this._previousPointer.x||pointer.y!==this._previousPointer.y))},__onMouseUp:function(e){var target,transform=this._currentTransform,groupSelector=this._groupSelector,isClick=!groupSelector||0===groupSelector.left&&0===groupSelector.top;if(this._cacheTransformEventData(e),target=this._target,this._handleEvent(e,"up:before"),checkClick(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,isClick);else{if(checkClick(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,isClick),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else{transform&&this._finalizeCurrentTransform(e);var shouldRender=this._shouldRender(target,this._absolutePointer);!target&&isClick||this._maybeGroupObjects(e),target&&(target.isMoving=!1),this._setCursorFromEvent(e,target),this._handleEvent(e,"up",1,isClick),this._groupSelector=null,this._currentTransform=null,target&&(target.__corner=0),shouldRender&&this.requestRenderAll()}}},_simpleEventHandler:function(eventType,e){var target=this.findTarget(e),targets=this.targets,options={e:e,target:target,subTargets:targets};if(this.fire(eventType,options),target&&target.fire(eventType,options),!targets)return target;for(var i=0;i<targets.length;i++)targets[i].fire(eventType,options);return target},_handleEvent:function(e,eventType,button,isClick){var target=this._target,targets=this.targets||[],options={e:e,target:target,subTargets:targets,button:button||1,isClick:isClick||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};this.fire("mouse:"+eventType,options),target&&target.fire("mouse"+eventType,options);for(var i=0;i<targets.length;i++)targets[i].fire("mouse"+eventType,options)},_finalizeCurrentTransform:function(e){var transform=this._currentTransform,target=transform.target,eventName,options={e:e,target:target,transform:transform};target._scaling&&(target._scaling=!1),target.setCoords(),(transform.actionPerformed||this.stateful&&target.hasStateChanged())&&(transform.actionPerformed&&(eventName=this._addEventOptions(options,transform),this._fire(eventName,options)),this._fire("modified",options))},_addEventOptions:function(options,transform){var eventName,by;switch(transform.action){case"scaleX":eventName="scaled",by="x";break;case"scaleY":eventName="scaled",by="y";break;case"skewX":eventName="skewed",by="x";break;case"skewY":eventName="skewed",by="y";break;case"scale":eventName="scaled",by="equally";break;case"rotate":eventName="rotated";break;case"drag":eventName="moved"}return options.by=by,eventName},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll(),this.clipTo&&fabric.util.clipContext(this,this.contextTop);var pointer=this.getPointer(e);this.freeDrawingBrush.onMouseDown(pointer),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){if(this._isCurrentlyDrawing){var pointer=this.getPointer(e);this.freeDrawingBrush.onMouseMove(pointer)}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){this._isCurrentlyDrawing=!1,this.clipTo&&this.contextTop.restore(),this.freeDrawingBrush.onMouseUp(),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var target=this._target;if(checkClick(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(checkClick(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(!this._currentTransform){var pointer=this._pointer;this._previousPointer=pointer;var shouldRender=this._shouldRender(target,pointer),shouldGroup=this._shouldGroup(e,target);this._shouldClearSelection(e,target)?this.discardActiveObject(e):shouldGroup&&(this._handleGrouping(e,target),target=this._activeObject),!this.selection||target&&(target.selectable||target.isEditing||target===this._activeObject)||(this._groupSelector={ex:pointer.x,ey:pointer.y,top:0,left:0}),target&&(target.selectable&&this.setActiveObject(target,e),target!==this._activeObject||!target.__corner&&shouldGroup||this._setupCurrentTransform(e,target)),this._handleEvent(e,"down"),shouldRender&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e:e,transform:t}),t.corner&&this.onBeforeScaleRotate(t.target)},__onMouseMove:function(e){var target,pointer;if(this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode)this._onMouseMoveInDrawingMode(e);else if(!(void 0!==e.touches&&e.touches.length>1)){var groupSelector=this._groupSelector;groupSelector?(pointer=this._pointer,groupSelector.left=pointer.x-groupSelector.ex,groupSelector.top=pointer.y-groupSelector.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(target=this.findTarget(e)||null,this._setCursorFromEvent(e,target),this._fireOverOutEvents(target,e)),this._handleEvent(e,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(target,e){this.fireSynteticInOutEvents(target,e,{targetName:"_hoveredTarget",canvasEvtOut:"mouse:out",evtOut:"mouseout",canvasEvtIn:"mouse:over",evtIn:"mouseover"})},_fireEnterLeaveEvents:function(target,e){this.fireSynteticInOutEvents(target,e,{targetName:"_draggedoverTarget",evtOut:"dragleave",evtIn:"dragenter"})},fireSynteticInOutEvents:function(target,e,config){var inOpt,outOpt,oldTarget=this[config.targetName],outFires,inFires,targetChanged=oldTarget!==target,canvasEvtIn=config.canvasEvtIn,canvasEvtOut=config.canvasEvtOut;targetChanged&&(inOpt={e:e,target:target,previousTarget:oldTarget},outOpt={e:e,target:oldTarget,nextTarget:target},this[config.targetName]=target),inFires=target&&targetChanged,(outFires=oldTarget&&targetChanged)&&(canvasEvtOut&&this.fire(canvasEvtOut,outOpt),oldTarget.fire(config.evtOut,outOpt)),inFires&&(canvasEvtIn&&this.fire(canvasEvtIn,inOpt),target.fire(config.evtIn,inOpt))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var pointer=this.getPointer(e),transform=this._currentTransform;transform.reset=!1,transform.target.isMoving=!0,transform.shiftKey=e.shiftKey,transform.altKey=e[this.centeredKey],this._beforeScaleTransform(e,transform),this._performTransformAction(e,transform,pointer),transform.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,transform,pointer){var x=pointer.x,y=pointer.y,action=transform.action,actionPerformed=!1,options={target:transform.target,e:e,transform:transform,pointer:pointer};"rotate"===action?((actionPerformed=this._rotateObject(x,y))&&this._fire("rotating",options),(actionPerformed=this._onScale(e,transform,x,y))&&this._fire("scaling",options)):"scale"===action?((actionPerformed=this._onScale(e,transform,x,y))&&this._fire("scaling",options),(actionPerformed=this._rotateObject(x,y))&&this._fire("rotating",options)):"scaleX"===action?(actionPerformed=this._scaleObject(x,y,"x"))&&this._fire("scaling",options):"scaleY"===action?(actionPerformed=this._scaleObject(x,y,"y"))&&this._fire("scaling",options):"skewX"===action?(actionPerformed=this._skewObject(x,y,"x"))&&this._fire("skewing",options):"skewY"===action?(actionPerformed=this._skewObject(x,y,"y"))&&this._fire("skewing",options):(actionPerformed=this._translateObject(x,y))&&(this._fire("moving",options),this.setCursor(options.target.moveCursor||this.moveCursor)),transform.actionPerformed=transform.actionPerformed||actionPerformed},_fire:function(eventName,options){this.fire("object:"+eventName,options),options.target.fire(eventName,options)},_beforeScaleTransform:function(e,transform){if("scale"===transform.action||"scaleX"===transform.action||"scaleY"===transform.action){var centerTransform=this._shouldCenterTransform(transform.target);(centerTransform&&("center"!==transform.originX||"center"!==transform.originY)||!centerTransform&&"center"===transform.originX&&"center"===transform.originY)&&(this._resetCurrentTransform(),transform.reset=!0)}},_onScale:function(e,transform,x,y){return this._isUniscalePossible(e,transform.target)?(transform.currentAction="scale",this._scaleObject(x,y)):(transform.reset||"scale"!==transform.currentAction||this._resetCurrentTransform(),transform.currentAction="scaleEqually",this._scaleObject(x,y,"equally"))},_isUniscalePossible:function(e,target){return(e[this.uniScaleKey]||this.uniScaleTransform)&&!target.get("lockUniScaling")},_setCursorFromEvent:function(e,target){if(!target)return this.setCursor(this.defaultCursor),!1;var hoverCursor=target.hoverCursor||this.hoverCursor,activeSelection=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,corner=(!activeSelection||!activeSelection.contains(target))&&target._findTargetCorner(this.getPointer(e,!0));corner?this.setCursor(this.getCornerCursor(corner,target,e)):this.setCursor(hoverCursor)},getCornerCursor:function(corner,target,e){return this.actionIsDisabled(corner,target,e)?this.notAllowedCursor:corner in cursorOffset?this._getRotatedCornerCursor(corner,target,e):"mtr"===corner&&target.hasRotatingPoint?this.rotationCursor:this.defaultCursor},actionIsDisabled:function(corner,target,e){return"mt"===corner||"mb"===corner?e[this.altActionKey]?target.lockSkewingX:target.lockScalingY:"ml"===corner||"mr"===corner?e[this.altActionKey]?target.lockSkewingY:target.lockScalingX:"mtr"===corner?target.lockRotation:this._isUniscalePossible(e,target)?target.lockScalingX&&target.lockScalingY:target.lockScalingX||target.lockScalingY},_getRotatedCornerCursor:function(corner,target,e){var n=Math.round(target.angle%360/45);return n<0&&(n+=8),n+=cursorOffset[corner],e[this.altActionKey]&&cursorOffset[corner]%2==0&&(n+=2),n%=8,this.cursorMap[n]}})}(),function(){var min=Math.min,max=Math.max;fabric.util.object.extend(fabric.Canvas.prototype,{_shouldGroup:function(e,target){var activeObject=this._activeObject;return activeObject&&this._isSelectionKeyPressed(e)&&target&&target.selectable&&this.selection&&(activeObject!==target||"activeSelection"===activeObject.type)},_handleGrouping:function(e,target){var activeObject=this._activeObject;activeObject.__corner||(target!==activeObject||(target=this.findTarget(e,!0)))&&(activeObject&&"activeSelection"===activeObject.type?this._updateActiveSelection(target,e):this._createActiveSelection(target,e))},_updateActiveSelection:function(target,e){var activeSelection=this._activeObject,currentActiveObjects=activeSelection._objects.slice(0);activeSelection.contains(target)?(activeSelection.removeWithUpdate(target),this._hoveredTarget=target,1===activeSelection.size()&&this._setActiveObject(activeSelection.item(0),e)):(activeSelection.addWithUpdate(target),this._hoveredTarget=activeSelection),this._fireSelectionEvents(currentActiveObjects,e)},_createActiveSelection:function(target,e){var currentActives=this.getActiveObjects(),group=this._createGroup(target);this._hoveredTarget=group,this._setActiveObject(group,e),this._fireSelectionEvents(currentActives,e)},_createGroup:function(target){var objects=this._objects,isActiveLower,groupObjects=objects.indexOf(this._activeObject)<objects.indexOf(target)?[this._activeObject,target]:[target,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new fabric.ActiveSelection(groupObjects,{canvas:this})},_groupSelectedObjects:function(e){var group=this._collectObjects(),aGroup;1===group.length?this.setActiveObject(group[0],e):group.length>1&&(aGroup=new fabric.ActiveSelection(group.reverse(),{canvas:this}),this.setActiveObject(aGroup,e))},_collectObjects:function(){for(var group=[],currentObject,x1=this._groupSelector.ex,y1=this._groupSelector.ey,x2=x1+this._groupSelector.left,y2=y1+this._groupSelector.top,selectionX1Y1=new fabric.Point(min(x1,x2),min(y1,y2)),selectionX2Y2=new fabric.Point(max(x1,x2),max(y1,y2)),allowIntersect=!this.selectionFullyContained,isClick=x1===x2&&y1===y2,i=this._objects.length;i--&&!((currentObject=this._objects[i])&&currentObject.selectable&&currentObject.visible&&(allowIntersect&&currentObject.intersectsWithRect(selectionX1Y1,selectionX2Y2)||currentObject.isContainedWithinRect(selectionX1Y1,selectionX2Y2)||allowIntersect&&currentObject.containsPoint(selectionX1Y1)||allowIntersect&&currentObject.containsPoint(selectionX2Y2))&&(group.push(currentObject),isClick)););return group},_maybeGroupObjects:function(e){this.selection&&this._groupSelector&&this._groupSelectedObjects(e),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){var supportQuality=fabric.StaticCanvas.supports("toDataURLWithQuality");fabric.util.object.extend(fabric.StaticCanvas.prototype,{toDataURL:function(options){options||(options={});var format=options.format||"png",quality=options.quality||1,multiplier=(options.multiplier||1)*(options.enableRetinaScaling?1:1/this.getRetinaScaling()),cropping={left:options.left||0,top:options.top||0,width:options.width||0,height:options.height||0};return this.__toDataURLWithMultiplier(format,quality,cropping,multiplier)},__toDataURLWithMultiplier:function(format,quality,cropping,multiplier){var origWidth=this.width,origHeight=this.height,scaledWidth=(cropping.width||this.width)*multiplier,scaledHeight=(cropping.height||this.height)*multiplier,zoom,newZoom=this.getZoom()*multiplier,vp=this.viewportTransform,translateX,translateY,newVp=[newZoom,0,0,newZoom,(vp[4]-cropping.left)*multiplier,(vp[5]-cropping.top)*multiplier],originalInteractive=this.interactive,originalSkipOffScreen=this.skipOffscreen,needsResize=origWidth!==scaledWidth||origHeight!==scaledHeight;this.viewportTransform=newVp,this.skipOffscreen=!1,this.interactive=!1,needsResize&&this.setDimensions({width:scaledWidth,height:scaledHeight},{backstoreOnly:!0}),this.renderAll();var data=this.__toDataURL(format,quality,cropping);return this.interactive=originalInteractive,this.skipOffscreen=originalSkipOffScreen,this.viewportTransform=vp,needsResize&&this.setDimensions({width:origWidth,height:origHeight},{backstoreOnly:!0}),this.renderAll(),data},__toDataURL:function(format,quality){var canvasEl=this.contextContainer.canvas,data;return"jpg"===format&&(format="jpeg"),supportQuality?canvasEl.toDataURL("image/"+format,quality):canvasEl.toDataURL("image/"+format)}})}(),fabric.util.object.extend(fabric.StaticCanvas.prototype,{loadFromDatalessJSON:function(json,callback,reviver){return this.loadFromJSON(json,callback,reviver)},loadFromJSON:function(json,callback,reviver){if(json){var serialized="string"==typeof json?JSON.parse(json):fabric.util.object.clone(json),_this=this,renderOnAddRemove=this.renderOnAddRemove;return this.renderOnAddRemove=!1,this._enlivenObjects(serialized.objects,function(enlivenedObjects){_this.clear(),_this._setBgOverlay(serialized,function(){enlivenedObjects.forEach(function(obj,index){_this.insertAt(obj,index)}),_this.renderOnAddRemove=renderOnAddRemove,delete serialized.objects,delete serialized.backgroundImage,delete serialized.overlayImage,delete serialized.background,delete serialized.overlay,_this._setOptions(serialized),_this.renderAll(),callback&&callback()})},reviver),this}},_setBgOverlay:function(serialized,callback){var loaded={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(serialized.backgroundImage||serialized.overlayImage||serialized.background||serialized.overlay){var cbIfLoaded=function(){loaded.backgroundImage&&loaded.overlayImage&&loaded.backgroundColor&&loaded.overlayColor&&callback&&callback()};this.__setBgOverlay("backgroundImage",serialized.backgroundImage,loaded,cbIfLoaded),this.__setBgOverlay("overlayImage",serialized.overlayImage,loaded,cbIfLoaded),this.__setBgOverlay("backgroundColor",serialized.background,loaded,cbIfLoaded),this.__setBgOverlay("overlayColor",serialized.overlay,loaded,cbIfLoaded)}else callback&&callback()},__setBgOverlay:function(property,value,loaded,callback){var _this=this;if(!value)return loaded[property]=!0,void(callback&&callback());"backgroundImage"===property||"overlayImage"===property?fabric.util.enlivenObjects([value],function(enlivedObject){_this[property]=enlivedObject[0],loaded[property]=!0,callback&&callback()}):this["set"+fabric.util.string.capitalize(property,!0)](value,function(){loaded[property]=!0,callback&&callback()})},_enlivenObjects:function(objects,callback,reviver){objects&&0!==objects.length?fabric.util.enlivenObjects(objects,function(enlivenedObjects){callback&&callback(enlivenedObjects)},null,reviver):callback&&callback([])},_toDataURL:function(format,callback){this.clone(function(clone){callback(clone.toDataURL(format))})},_toDataURLWithMultiplier:function(format,multiplier,callback){this.clone(function(clone){callback(clone.toDataURLWithMultiplier(format,multiplier))})},clone:function(callback,properties){var data=JSON.stringify(this.toJSON(properties));this.cloneWithoutData(function(clone){clone.loadFromJSON(data,function(){callback&&callback(clone)})})},cloneWithoutData:function(callback){var el=fabric.util.createCanvasElement();el.width=this.width,el.height=this.height;var clone=new fabric.Canvas(el);clone.clipTo=this.clipTo,this.backgroundImage?(clone.setBackgroundImage(this.backgroundImage.src,function(){clone.renderAll(),callback&&callback(clone)}),clone.backgroundImageOpacity=this.backgroundImageOpacity,clone.backgroundImageStretch=this.backgroundImageStretch):callback&&callback(clone)}}),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,clone=fabric.util.object.clone,toFixed=fabric.util.toFixed,capitalize=fabric.util.string.capitalize,degreesToRadians=fabric.util.degreesToRadians,supportsLineDash=fabric.StaticCanvas.supports("setLineDash"),objectCaching=!fabric.isLikelyNode,ALIASING_LIMIT=2;fabric.Object||(fabric.Object=fabric.util.createClass(fabric.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgba(102,153,255,0.75)",borderDashArray:null,cornerColor:"rgba(102,153,255,0.5)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,transformMatrix:null,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,hasRotatingPoint:!0,rotatingPointOffset:40,perPixelTargetFind:!1,includeDefaultValues:!0,clipTo:null,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockUniScaling:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:objectCaching,statefullCache:!1,noScaleCache:!0,dirty:!0,__corner:0,paintFirst:"fill",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow clipTo visible backgroundColor skewX skewY fillRule paintFirst".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeLineCap strokeLineJoin strokeMiterLimit backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(options){options&&this.setOptions(options)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=fabric.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(dims){var perfLimitSizeTotal=fabric.perfLimitSizeTotal,width=dims.width,height=dims.height,max=fabric.maxCacheSideLimit,min=fabric.minCacheSideLimit;if(width<=max&&height<=max&&width*height<=perfLimitSizeTotal)return width<min&&(dims.width=min),height<min&&(dims.height=min),dims;var ar=width/height,limitedDims=fabric.util.limitDimsByArea(ar,perfLimitSizeTotal),capValue=fabric.util.capValue,x=capValue(min,limitedDims.x,max),y=capValue(min,limitedDims.y,max);return width>x&&(dims.zoomX/=width/x,dims.width=x,dims.capped=!0),height>y&&(dims.zoomY/=height/y,dims.height=y,dims.capped=!0),dims},_getCacheCanvasDimensions:function(){var objectScale=this.getTotalObjectScaling(),dim=this._getNonTransformedDimensions(),zoomX=objectScale.scaleX,zoomY=objectScale.scaleY,width,height;return{width:dim.x*zoomX+2,height:dim.y*zoomY+2,zoomX:zoomX,zoomY:zoomY,x:dim.x,y:dim.y}},_updateCacheCanvas:function(){var targetCanvas=this.canvas;if(this.noScaleCache&&targetCanvas&&targetCanvas._currentTransform){var target=targetCanvas._currentTransform.target,action=targetCanvas._currentTransform.action;if(this===target&&action.slice&&"scale"===action.slice(0,5))return!1}var canvas=this._cacheCanvas,dims=this._limitCacheSize(this._getCacheCanvasDimensions()),minCacheSize=fabric.minCacheSideLimit,width=dims.width,height=dims.height,drawingWidth,drawingHeight,zoomX=dims.zoomX,zoomY=dims.zoomY,dimensionsChanged=width!==this.cacheWidth||height!==this.cacheHeight,zoomChanged=this.zoomX!==zoomX||this.zoomY!==zoomY,shouldRedraw=dimensionsChanged||zoomChanged,additionalWidth=0,additionalHeight=0,shouldResizeCanvas=!1;if(dimensionsChanged){var canvasWidth=this._cacheCanvas.width,canvasHeight=this._cacheCanvas.height,sizeGrowing=width>canvasWidth||height>canvasHeight,sizeShrinking;shouldResizeCanvas=sizeGrowing||(width<.9*canvasWidth||height<.9*canvasHeight)&&canvasWidth>minCacheSize&&canvasHeight>minCacheSize,sizeGrowing&&!dims.capped&&(width>minCacheSize||height>minCacheSize)&&(additionalWidth=.1*width,additionalHeight=.1*height)}return!!shouldRedraw&&(shouldResizeCanvas?(canvas.width=Math.ceil(width+additionalWidth),canvas.height=Math.ceil(height+additionalHeight)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,canvas.width,canvas.height)),drawingWidth=dims.x*zoomX/2,drawingHeight=dims.y*zoomY/2,this.cacheTranslationX=Math.round(canvas.width/2-drawingWidth)+drawingWidth,this.cacheTranslationY=Math.round(canvas.height/2-drawingHeight)+drawingHeight,this.cacheWidth=width,this.cacheHeight=height,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(zoomX,zoomY),this.zoomX=zoomX,this.zoomY=zoomY,!0)},setOptions:function(options){this._setOptions(options),this._initGradient(options.fill,"fill"),this._initGradient(options.stroke,"stroke"),this._initClipping(options),this._initPattern(options.fill,"fill"),this._initPattern(options.stroke,"stroke")},transform:function(ctx){var m;m=this.group&&!this.group._transformDone?this.calcTransformMatrix():this.calcOwnMatrix(),ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])},toObject:function(propertiesToInclude){var NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS,object={type:this.type,version:fabric.version,originX:this.originX,originY:this.originY,left:toFixed(this.left,NUM_FRACTION_DIGITS),top:toFixed(this.top,NUM_FRACTION_DIGITS),width:toFixed(this.width,NUM_FRACTION_DIGITS),height:toFixed(this.height,NUM_FRACTION_DIGITS),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:toFixed(this.strokeWidth,NUM_FRACTION_DIGITS),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:toFixed(this.strokeMiterLimit,NUM_FRACTION_DIGITS),scaleX:toFixed(this.scaleX,NUM_FRACTION_DIGITS),scaleY:toFixed(this.scaleY,NUM_FRACTION_DIGITS),angle:toFixed(this.angle,NUM_FRACTION_DIGITS),flipX:this.flipX,flipY:this.flipY,opacity:toFixed(this.opacity,NUM_FRACTION_DIGITS),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,clipTo:this.clipTo&&String(this.clipTo),backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,transformMatrix:this.transformMatrix?this.transformMatrix.concat():null,skewX:toFixed(this.skewX,NUM_FRACTION_DIGITS),skewY:toFixed(this.skewY,NUM_FRACTION_DIGITS)};return this.clipPath&&(object.clipPath=this.clipPath.toObject(propertiesToInclude),object.clipPath.inverted=this.clipPath.inverted,object.clipPath.absolutePositioned=this.clipPath.absolutePositioned),fabric.util.populateWithProperties(this,object,propertiesToInclude),this.includeDefaultValues||(object=this._removeDefaultValues(object)),object},toDatalessObject:function(propertiesToInclude){return this.toObject(propertiesToInclude)},_removeDefaultValues:function(object){var prototype=fabric.util.getKlass(object.type).prototype,stateProperties;return prototype.stateProperties.forEach(function(prop){var isArray;object[prop]===prototype[prop]&&delete object[prop],"[object Array]"===Object.prototype.toString.call(object[prop])&&"[object Array]"===Object.prototype.toString.call(prototype[prop])&&0===object[prop].length&&0===prototype[prop].length&&delete object[prop]}),object},toString:function(){return"#<fabric."+capitalize(this.type)+">"},getObjectScaling:function(){var scaleX=this.scaleX,scaleY=this.scaleY;if(this.group){var scaling=this.group.getObjectScaling();scaleX*=scaling.scaleX,scaleY*=scaling.scaleY}return{scaleX:scaleX,scaleY:scaleY}},getTotalObjectScaling:function(){var scale=this.getObjectScaling(),scaleX=scale.scaleX,scaleY=scale.scaleY;if(this.canvas){var zoom=this.canvas.getZoom(),retina=this.canvas.getRetinaScaling();scaleX*=zoom*retina,scaleY*=zoom*retina}return{scaleX:scaleX,scaleY:scaleY}},getObjectOpacity:function(){var opacity=this.opacity;return this.group&&(opacity*=this.group.getObjectOpacity()),opacity},_set:function(key,value){var shouldConstrainValue="scaleX"===key||"scaleY"===key,isChanged=this[key]!==value,groupNeedsUpdate=!1;return shouldConstrainValue&&(value=this._constrainScale(value)),"scaleX"===key&&value<0?(this.flipX=!this.flipX,value*=-1):"scaleY"===key&&value<0?(this.flipY=!this.flipY,value*=-1):"shadow"!==key||!value||value instanceof fabric.Shadow?"dirty"===key&&this.group&&this.group.set("dirty",value):value=new fabric.Shadow(value),this[key]=value,isChanged&&(groupNeedsUpdate=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(key)>-1?(this.dirty=!0,groupNeedsUpdate&&this.group.set("dirty",!0)):groupNeedsUpdate&&this.stateProperties.indexOf(key)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:fabric.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||0===this.width&&0===this.height||!this.visible},render:function(ctx){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(ctx.save(),this._setupCompositeOperation(ctx),this.drawSelectionBackground(ctx),this.transform(ctx),this._setOpacity(ctx),this._setShadow(ctx,this),this.transformMatrix&&ctx.transform.apply(ctx,this.transformMatrix),this.clipTo&&fabric.util.clipContext(this,ctx),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(ctx)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(ctx),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),this.clipTo&&ctx.restore(),ctx.restore())},renderCache:function(options){options=options||{},this._cacheCanvas||this._createCacheCanvas(),this.isCacheDirty(!1)&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,options.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this.cacheWidth=0,this.cacheHeight=0},needsItsOwnCache:function(){return"stroke"===this.paintFirst&&"object"==typeof this.shadow||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.objectCaching&&(!this.group||this.needsItsOwnCache()||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(ctx){var path=this.clipPath;if(ctx.save(),path.inverted?ctx.globalCompositeOperation="destination-out":ctx.globalCompositeOperation="destination-in",path.absolutePositioned){var m=fabric.util.invertTransform(this.calcTransformMatrix());ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])}path.transform(ctx),ctx.scale(1/path.zoomX,1/path.zoomY),ctx.drawImage(path._cacheCanvas,-path.cacheTranslationX,-path.cacheTranslationY),ctx.restore()},drawObject:function(ctx,forClipping){forClipping?this._setClippingProperties(ctx):(this._renderBackground(ctx),this._setStrokeStyles(ctx,this),this._setFillStyles(ctx,this)),this._render(ctx),this._drawClipPath(ctx)},_drawClipPath:function(ctx){var path=this.clipPath;path&&(path.canvas=this.canvas,path.shouldCache(),path._transformDone=!0,path.renderCache({forClipping:!0}),this.drawClipPathOnCache(ctx))},drawCacheOnCanvas:function(ctx){ctx.scale(1/this.zoomX,1/this.zoomY),ctx.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(skipCanvas){if(this.isNotVisible())return!1;if(this._cacheCanvas&&!skipCanvas&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&!skipCanvas){var width=this.cacheWidth/this.zoomX,height=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-width/2,-height/2,width,height)}return!0}return!1},_renderBackground:function(ctx){if(this.backgroundColor){var dim=this._getNonTransformedDimensions();ctx.fillStyle=this.backgroundColor,ctx.fillRect(-dim.x/2,-dim.y/2,dim.x,dim.y),this._removeShadow(ctx)}},_setOpacity:function(ctx){this.group&&!this.group._transformDone?ctx.globalAlpha=this.getObjectOpacity():ctx.globalAlpha*=this.opacity},_setStrokeStyles:function(ctx,decl){decl.stroke&&(ctx.lineWidth=decl.strokeWidth,ctx.lineCap=decl.strokeLineCap,ctx.lineJoin=decl.strokeLineJoin,ctx.miterLimit=decl.strokeMiterLimit,ctx.strokeStyle=decl.stroke.toLive?decl.stroke.toLive(ctx,this):decl.stroke)},_setFillStyles:function(ctx,decl){decl.fill&&(ctx.fillStyle=decl.fill.toLive?decl.fill.toLive(ctx,this):decl.fill)},_setClippingProperties:function(ctx){ctx.globalAlpha=1,ctx.strokeStyle="transparent",ctx.fillStyle="#000000"},_setLineDash:function(ctx,dashArray,alternative){dashArray&&(1&dashArray.length&&dashArray.push.apply(dashArray,dashArray),supportsLineDash?ctx.setLineDash(dashArray):alternative&&alternative(ctx))},_renderControls:function(ctx,styleOverride){var vpt=this.getViewportTransform(),matrix=this.calcTransformMatrix(),options,drawBorders,drawControls;drawBorders=void 0!==(styleOverride=styleOverride||{}).hasBorders?styleOverride.hasBorders:this.hasBorders,drawControls=void 0!==styleOverride.hasControls?styleOverride.hasControls:this.hasControls,matrix=fabric.util.multiplyTransformMatrices(vpt,matrix),options=fabric.util.qrDecompose(matrix),ctx.save(),ctx.translate(options.translateX,options.translateY),ctx.lineWidth=1*this.borderScaleFactor,this.group||(ctx.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),styleOverride.forActiveSelection?(ctx.rotate(degreesToRadians(options.angle)),drawBorders&&this.drawBordersInGroup(ctx,options,styleOverride)):(ctx.rotate(degreesToRadians(this.angle)),drawBorders&&this.drawBorders(ctx,styleOverride)),drawControls&&this.drawControls(ctx,styleOverride),ctx.restore()},_setShadow:function(ctx){if(this.shadow){var multX=this.canvas&&this.canvas.viewportTransform[0]||1,multY=this.canvas&&this.canvas.viewportTransform[3]||1,scaling=this.getObjectScaling();this.canvas&&this.canvas._isRetinaScaling()&&(multX*=fabric.devicePixelRatio,multY*=fabric.devicePixelRatio),ctx.shadowColor=this.shadow.color,ctx.shadowBlur=this.shadow.blur*fabric.browserShadowBlurConstant*(multX+multY)*(scaling.scaleX+scaling.scaleY)/4,ctx.shadowOffsetX=this.shadow.offsetX*multX*scaling.scaleX,ctx.shadowOffsetY=this.shadow.offsetY*multY*scaling.scaleY}},_removeShadow:function(ctx){this.shadow&&(ctx.shadowColor="",ctx.shadowBlur=ctx.shadowOffsetX=ctx.shadowOffsetY=0)},_applyPatternGradientTransform:function(ctx,filler){if(!filler||!filler.toLive)return{offsetX:0,offsetY:0};var t=filler.gradientTransform||filler.patternTransform,offsetX=-this.width/2+filler.offsetX||0,offsetY=-this.height/2+filler.offsetY||0;return ctx.translate(offsetX,offsetY),t&&ctx.transform(t[0],t[1],t[2],t[3],t[4],t[5]),{offsetX:offsetX,offsetY:offsetY}},_renderPaintInOrder:function(ctx){"stroke"===this.paintFirst?(this._renderStroke(ctx),this._renderFill(ctx)):(this._renderFill(ctx),this._renderStroke(ctx))},_renderFill:function(ctx){this.fill&&(ctx.save(),this._applyPatternGradientTransform(ctx,this.fill),"evenodd"===this.fillRule?ctx.fill("evenodd"):ctx.fill(),ctx.restore())},_renderStroke:function(ctx){this.stroke&&0!==this.strokeWidth&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(ctx),ctx.save(),this._setLineDash(ctx,this.strokeDashArray,this._renderDashedStroke),this._applyPatternGradientTransform(ctx,this.stroke),ctx.stroke(),ctx.restore())},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var options=fabric.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",options.scaleX),this.set("scaleY",options.scaleY),this.angle=options.angle,this.skewX=options.skewX,this.skewY=0}},_removeTransformMatrix:function(preserveAspectRatioOptions){var center=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),center=fabric.util.transformPoint(center,this.transformMatrix)),this.transformMatrix=null,preserveAspectRatioOptions&&(this.scaleX*=preserveAspectRatioOptions.scaleX,this.scaleY*=preserveAspectRatioOptions.scaleY,this.cropX=preserveAspectRatioOptions.cropX,this.cropY=preserveAspectRatioOptions.cropY,center.x+=preserveAspectRatioOptions.offsetLeft,center.y+=preserveAspectRatioOptions.offsetTop,this.width=preserveAspectRatioOptions.width,this.height=preserveAspectRatioOptions.height),this.setPositionByOrigin(center,"center","center")},clone:function(callback,propertiesToInclude){var objectForm=this.toObject(propertiesToInclude);this.constructor.fromObject?this.constructor.fromObject(objectForm,callback):fabric.Object._fromObject("Object",objectForm,callback)},cloneAsImage:function(callback,options){var dataUrl=this.toDataURL(options);return fabric.util.loadImage(dataUrl,function(img){callback&&callback(new fabric.Image(img))}),this},toDataURL:function(options){options||(options={});var origParams=fabric.util.saveObjectTransform(this);options.withoutTransform&&fabric.util.resetObjectTransform(this);var el=fabric.util.createCanvasElement(),boundingRect=this.getBoundingRect(!0,!0);el.width=boundingRect.width,el.height=boundingRect.height;var canvas=new fabric.StaticCanvas(el,{enableRetinaScaling:options.enableRetinaScaling,renderOnAddRemove:!1,skipOffscreen:!1});"jpg"===options.format&&(options.format="jpeg"),"jpeg"===options.format&&(canvas.backgroundColor="#fff"),this.setPositionByOrigin(new fabric.Point(canvas.width/2,canvas.height/2),"center","center");var originalCanvas=this.canvas;canvas.add(this);var data=canvas.toDataURL(options);return this.set(origParams).setCoords(),this.canvas=originalCanvas,canvas._objects=[],canvas.dispose(),canvas=null,data},isType:function(type){return this.type===type},complexity:function(){return 1},toJSON:function(propertiesToInclude){return this.toObject(propertiesToInclude)},setGradient:function(property,options){options||(options={});var gradient={colorStops:[]};return gradient.type=options.type||(options.r1||options.r2?"radial":"linear"),gradient.coords={x1:options.x1,y1:options.y1,x2:options.x2,y2:options.y2},(options.r1||options.r2)&&(gradient.coords.r1=options.r1,gradient.coords.r2=options.r2),gradient.gradientTransform=options.gradientTransform,fabric.Gradient.prototype.addColorStop.call(gradient,options.colorStops),this.set(property,fabric.Gradient.forObject(this,gradient))},setPatternFill:function(options,callback){return this.set("fill",new fabric.Pattern(options,callback))},setShadow:function(options){return this.set("shadow",options?new fabric.Shadow(options):null)},setColor:function(color){return this.set("fill",color),this},rotate:function(angle){var shouldCenterOrigin=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return shouldCenterOrigin&&this._setOriginToCenter(),this.set("angle",angle),shouldCenterOrigin&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(e,pointer){pointer=pointer||this.canvas.getPointer(e);var pClicked=new fabric.Point(pointer.x,pointer.y),objectLeftTop=this._getLeftTopCoords();return this.angle&&(pClicked=fabric.util.rotatePoint(pClicked,objectLeftTop,degreesToRadians(-this.angle))),{x:pClicked.x-objectLeftTop.x,y:pClicked.y-objectLeftTop.y}},_setupCompositeOperation:function(ctx){this.globalCompositeOperation&&(ctx.globalCompositeOperation=this.globalCompositeOperation)}}),fabric.util.createAccessors&&fabric.util.createAccessors(fabric.Object),extend(fabric.Object.prototype,fabric.Observable),fabric.Object.NUM_FRACTION_DIGITS=2,fabric.Object._fromObject=function(className,object,callback,extraParam){var klass=fabric[className];object=clone(object,!0),fabric.util.enlivenPatterns([object.fill,object.stroke],function(patterns){void 0!==patterns[0]&&(object.fill=patterns[0]),void 0!==patterns[1]&&(object.stroke=patterns[1]),fabric.util.enlivenObjects([object.clipPath],function(enlivedProps){object.clipPath=enlivedProps[0];var instance=extraParam?new klass(object[extraParam],object):new klass(object);callback&&callback(instance)})})},fabric.Object.__uid=0)}("undefined"!=typeof exports?exports:this),function(){var degreesToRadians=fabric.util.degreesToRadians,originXOffset={left:-.5,center:0,right:.5},originYOffset={top:-.5,center:0,bottom:.5};fabric.util.object.extend(fabric.Object.prototype,{translateToGivenOrigin:function(point,fromOriginX,fromOriginY,toOriginX,toOriginY){var x=point.x,y=point.y,offsetX,offsetY,dim;return"string"==typeof fromOriginX?fromOriginX=originXOffset[fromOriginX]:fromOriginX-=.5,"string"==typeof toOriginX?toOriginX=originXOffset[toOriginX]:toOriginX-=.5,"string"==typeof fromOriginY?fromOriginY=originYOffset[fromOriginY]:fromOriginY-=.5,"string"==typeof toOriginY?toOriginY=originYOffset[toOriginY]:toOriginY-=.5,offsetY=toOriginY-fromOriginY,((offsetX=toOriginX-fromOriginX)||offsetY)&&(dim=this._getTransformedDimensions(),x=point.x+offsetX*dim.x,y=point.y+offsetY*dim.y),new fabric.Point(x,y)},translateToCenterPoint:function(point,originX,originY){var p=this.translateToGivenOrigin(point,originX,originY,"center","center");return this.angle?fabric.util.rotatePoint(p,point,degreesToRadians(this.angle)):p},translateToOriginPoint:function(center,originX,originY){var p=this.translateToGivenOrigin(center,"center","center",originX,originY);return this.angle?fabric.util.rotatePoint(p,center,degreesToRadians(this.angle)):p},getCenterPoint:function(){var leftTop=new fabric.Point(this.left,this.top);return this.translateToCenterPoint(leftTop,this.originX,this.originY)},getPointByOrigin:function(originX,originY){var center=this.getCenterPoint();return this.translateToOriginPoint(center,originX,originY)},toLocalPoint:function(point,originX,originY){var center=this.getCenterPoint(),p,p2;return p=void 0!==originX&&void 0!==originY?this.translateToGivenOrigin(center,"center","center",originX,originY):new fabric.Point(this.left,this.top),p2=new fabric.Point(point.x,point.y),this.angle&&(p2=fabric.util.rotatePoint(p2,center,-degreesToRadians(this.angle))),p2.subtractEquals(p)},setPositionByOrigin:function(pos,originX,originY){var center=this.translateToCenterPoint(pos,originX,originY),position=this.translateToOriginPoint(center,this.originX,this.originY);this.set("left",position.x),this.set("top",position.y)},adjustPosition:function(to){var angle=degreesToRadians(this.angle),hypotFull=this.getScaledWidth(),xFull=fabric.util.cos(angle)*hypotFull,yFull=fabric.util.sin(angle)*hypotFull,offsetFrom,offsetTo;offsetFrom="string"==typeof this.originX?originXOffset[this.originX]:this.originX-.5,offsetTo="string"==typeof to?originXOffset[to]:to-.5,this.left+=xFull*(offsetTo-offsetFrom),this.top+=yFull*(offsetTo-offsetFrom),this.setCoords(),this.originX=to},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var center=this.getCenterPoint();this.originX="center",this.originY="center",this.left=center.x,this.top=center.y},_resetOrigin:function(){var originPoint=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=originPoint.x,this.top=originPoint.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function getCoords(coords){return[new fabric.Point(coords.tl.x,coords.tl.y),new fabric.Point(coords.tr.x,coords.tr.y),new fabric.Point(coords.br.x,coords.br.y),new fabric.Point(coords.bl.x,coords.bl.y)]}var degreesToRadians=fabric.util.degreesToRadians,multiplyMatrices=fabric.util.multiplyTransformMatrices,transformPoint=fabric.util.transformPoint;fabric.util.object.extend(fabric.Object.prototype,{oCoords:null,aCoords:null,ownMatrixCache:null,matrixCache:null,getCoords:function(absolute,calculate){this.oCoords||this.setCoords();var coords=absolute?this.aCoords:this.oCoords;return getCoords(calculate?this.calcCoords(absolute):coords)},intersectsWithRect:function(pointTL,pointBR,absolute,calculate){var coords=this.getCoords(absolute,calculate),intersection;return"Intersection"===fabric.Intersection.intersectPolygonRectangle(coords,pointTL,pointBR).status},intersectsWithObject:function(other,absolute,calculate){var intersection;return"Intersection"===fabric.Intersection.intersectPolygonPolygon(this.getCoords(absolute,calculate),other.getCoords(absolute,calculate)).status||other.isContainedWithinObject(this,absolute,calculate)||this.isContainedWithinObject(other,absolute,calculate)},isContainedWithinObject:function(other,absolute,calculate){for(var points=this.getCoords(absolute,calculate),i=0,lines=other._getImageLines(calculate?other.calcCoords(absolute):absolute?other.aCoords:other.oCoords);i<4;i++)if(!other.containsPoint(points[i],lines))return!1;return!0},isContainedWithinRect:function(pointTL,pointBR,absolute,calculate){var boundingRect=this.getBoundingRect(absolute,calculate);return boundingRect.left>=pointTL.x&&boundingRect.left+boundingRect.width<=pointBR.x&&boundingRect.top>=pointTL.y&&boundingRect.top+boundingRect.height<=pointBR.y},containsPoint:function(point,lines,absolute,calculate){var lines=lines||this._getImageLines(calculate?this.calcCoords(absolute):absolute?this.aCoords:this.oCoords),xPoints=this._findCrossPoints(point,lines);return 0!==xPoints&&xPoints%2==1},isOnScreen:function(calculate){if(!this.canvas)return!1;for(var pointTL=this.canvas.vptCoords.tl,pointBR=this.canvas.vptCoords.br,points=this.getCoords(!0,calculate),point,i=0;i<4;i++)if((point=points[i]).x<=pointBR.x&&point.x>=pointTL.x&&point.y<=pointBR.y&&point.y>=pointTL.y)return!0;return!!this.intersectsWithRect(pointTL,pointBR,!0,calculate)||this._containsCenterOfCanvas(pointTL,pointBR,calculate)},_containsCenterOfCanvas:function(pointTL,pointBR,calculate){var centerPoint={x:(pointTL.x+pointBR.x)/2,y:(pointTL.y+pointBR.y)/2};return!!this.containsPoint(centerPoint,null,!0,calculate)},isPartiallyOnScreen:function(calculate){if(!this.canvas)return!1;var pointTL=this.canvas.vptCoords.tl,pointBR=this.canvas.vptCoords.br;return!!this.intersectsWithRect(pointTL,pointBR,!0,calculate)||this._containsCenterOfCanvas(pointTL,pointBR,calculate)},_getImageLines:function(oCoords){return{topline:{o:oCoords.tl,d:oCoords.tr},rightline:{o:oCoords.tr,d:oCoords.br},bottomline:{o:oCoords.br,d:oCoords.bl},leftline:{o:oCoords.bl,d:oCoords.tl}}},_findCrossPoints:function(point,lines){var b1,b2,a1,a2,xi,xcount=0,iLine;for(var lineKey in lines)if(!((iLine=lines[lineKey]).o.y<point.y&&iLine.d.y<point.y||iLine.o.y>=point.y&&iLine.d.y>=point.y||(iLine.o.x===iLine.d.x&&iLine.o.x>=point.x?xi=iLine.o.x:(b1=0,b2=(iLine.d.y-iLine.o.y)/(iLine.d.x-iLine.o.x),xi=-((a1=point.y-0*point.x)-(a2=iLine.o.y-b2*iLine.o.x))/(0-b2)),xi>=point.x&&(xcount+=1),2!==xcount)))break;return xcount},getBoundingRect:function(absolute,calculate){var coords=this.getCoords(absolute,calculate);return fabric.util.makeBoundingBoxFromPoints(coords)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(value){return Math.abs(value)<this.minScaleLimit?value<0?-this.minScaleLimit:this.minScaleLimit:0===value?1e-4:value},scale:function(value){return this._set("scaleX",value),this._set("scaleY",value),this.setCoords()},scaleToWidth:function(value,absolute){var boundingRectFactor=this.getBoundingRect(absolute).width/this.getScaledWidth();return this.scale(value/this.width/boundingRectFactor)},scaleToHeight:function(value,absolute){var boundingRectFactor=this.getBoundingRect(absolute).height/this.getScaledHeight();return this.scale(value/this.height/boundingRectFactor)},calcCoords:function(absolute){var rotateMatrix=this._calcRotateMatrix(),translateMatrix=this._calcTranslateMatrix(),startMatrix=multiplyMatrices(translateMatrix,rotateMatrix),vpt=this.getViewportTransform(),finalMatrix=absolute?startMatrix:multiplyMatrices(vpt,startMatrix),dim=this._getTransformedDimensions(),w=dim.x/2,h=dim.y/2,tl=transformPoint({x:-w,y:-h},finalMatrix),tr=transformPoint({x:w,y:-h},finalMatrix),bl=transformPoint({x:-w,y:h},finalMatrix),br=transformPoint({x:w,y:h},finalMatrix);if(!absolute){var padding=this.padding,angle=degreesToRadians(this.angle),cos,sin,cosP=fabric.util.cos(angle)*padding,sinP=fabric.util.sin(angle)*padding,cosPSinP=cosP+sinP,cosPMinusSinP=cosP-sinP;padding&&(tl.x-=cosPMinusSinP,tl.y-=cosPSinP,tr.x+=cosPSinP,tr.y-=cosPMinusSinP,bl.x-=cosPSinP,bl.y+=cosPMinusSinP,br.x+=cosPMinusSinP,br.y+=cosPSinP);var rd=Math.sqrt(w/2*(w/2)+w/2*(w/2)),ml=new fabric.Point((tl.x+bl.x)/2,(tl.y+bl.y)/2),mt=new fabric.Point((tr.x+tl.x)/2,(tr.y+tl.y)/2),mr=new fabric.Point((br.x+tr.x)/2,(br.y+tr.y)/2),mb=new fabric.Point((br.x+bl.x)/2,(br.y+bl.y)/2),mtr=new fabric.Point(tl.x,tl.y)}var coords={tl:tl,tr:tr,br:br,bl:bl};return absolute||(coords.ml=ml,coords.mt=mt,coords.mr=mr,coords.mb=mb,coords.mtr=mtr),coords},setCoords:function(ignoreZoom,skipAbsolute){return this.oCoords=this.calcCoords(ignoreZoom),skipAbsolute||(this.aCoords=this.calcCoords(!0)),ignoreZoom||this._setCornerCoords&&this._setCornerCoords(),this},_calcRotateMatrix:function(){if(this.angle){var theta=degreesToRadians(this.angle),cos=fabric.util.cos(theta),sin=fabric.util.sin(theta);return[cos,sin,-sin,cos,0,0]}return fabric.iMatrix.concat()},_calcTranslateMatrix:function(){var center=this.getCenterPoint();return[1,0,0,1,center.x,center.y]},transformMatrixKey:function(skipGroup){var sep="_",prefix="";return!skipGroup&&this.group&&(prefix=this.group.transformMatrixKey(skipGroup)+"_"),prefix+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(skipGroup){if(skipGroup)return this.calcOwnMatrix();var key=this.transformMatrixKey(),cache=this.matrixCache||(this.matrixCache={});if(cache.key===key)return cache.value;var matrix=this.calcOwnMatrix();return this.group&&(matrix=multiplyMatrices(this.group.calcTransformMatrix(),matrix)),cache.key=key,cache.value=matrix,matrix},calcOwnMatrix:function(){var key=this.transformMatrixKey(!0),cache=this.ownMatrixCache||(this.ownMatrixCache={});if(cache.key===key)return cache.value;var matrix=this._calcTranslateMatrix(),rotateMatrix,dimensionMatrix=this._calcDimensionsTransformMatrix(this.skewX,this.skewY,!0);return this.angle&&(rotateMatrix=this._calcRotateMatrix(),matrix=multiplyMatrices(matrix,rotateMatrix)),matrix=multiplyMatrices(matrix,dimensionMatrix),cache.key=key,cache.value=matrix,matrix},_calcDimensionsTransformMatrix:function(skewX,skewY,flipping){var skewMatrix,scaleX,scaleY,scaleMatrix=[this.scaleX*(flipping&&this.flipX?-1:1),0,0,this.scaleY*(flipping&&this.flipY?-1:1),0,0];return skewX&&(skewMatrix=[1,0,Math.tan(degreesToRadians(skewX)),1],scaleMatrix=multiplyMatrices(scaleMatrix,skewMatrix,!0)),skewY&&(skewMatrix=[1,Math.tan(degreesToRadians(skewY)),0,1],scaleMatrix=multiplyMatrices(scaleMatrix,skewMatrix,!0)),scaleMatrix},_getNonTransformedDimensions:function(){var strokeWidth=this.strokeWidth,w,h;return{x:this.width+strokeWidth,y:this.height+strokeWidth}},_getTransformedDimensions:function(skewX,skewY){void 0===skewX&&(skewX=this.skewX),void 0===skewY&&(skewY=this.skewY);var dimensions=this._getNonTransformedDimensions();if(0===skewX&&0===skewY)return{x:dimensions.x*this.scaleX,y:dimensions.y*this.scaleY};var dimX=dimensions.x/2,dimY=dimensions.y/2,points=[{x:-dimX,y:-dimY},{x:dimX,y:-dimY},{x:-dimX,y:dimY},{x:dimX,y:dimY}],i,transformMatrix=this._calcDimensionsTransformMatrix(skewX,skewY,!1),bbox;for(i=0;i<points.length;i++)points[i]=fabric.util.transformPoint(points[i],transformMatrix);return{x:(bbox=fabric.util.makeBoundingBoxFromPoints(points)).width,y:bbox.height}},_calculateCurrentDimensions:function(){var vpt=this.getViewportTransform(),dim=this._getTransformedDimensions(),p;return fabric.util.transformPoint(dim,vpt,!0).scalarAdd(2*this.padding)}})}(),fabric.util.object.extend(fabric.Object.prototype,{sendToBack:function(){return this.group?fabric.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?fabric.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas.bringToFront(this),this},sendBackwards:function(intersecting){return this.group?fabric.StaticCanvas.prototype.sendBackwards.call(this.group,this,intersecting):this.canvas.sendBackwards(this,intersecting),this},bringForward:function(intersecting){return this.group?fabric.StaticCanvas.prototype.bringForward.call(this.group,this,intersecting):this.canvas.bringForward(this,intersecting),this},moveTo:function(index){return this.group&&"activeSelection"!==this.group.type?fabric.StaticCanvas.prototype.moveTo.call(this.group,this,index):this.canvas.moveTo(this,index),this}}),function(){function getSvgColorString(prop,value){if(value){if(value.toLive)return prop+": url(#SVGID_"+value.id+"); ";var color=new fabric.Color(value),str=prop+": "+color.toRgb()+"; ",opacity=color.getAlpha();return 1!==opacity&&(str+=prop+"-opacity: "+opacity.toString()+"; "),str}return prop+": none; "}var toFixed=fabric.util.toFixed;fabric.util.object.extend(fabric.Object.prototype,{getSvgStyles:function(skipShadow){var fillRule=this.fillRule,strokeWidth=this.strokeWidth?this.strokeWidth:"0",strokeDashArray=this.strokeDashArray?this.strokeDashArray.join(" "):"none",strokeLineCap=this.strokeLineCap?this.strokeLineCap:"butt",strokeLineJoin=this.strokeLineJoin?this.strokeLineJoin:"miter",strokeMiterLimit=this.strokeMiterLimit?this.strokeMiterLimit:"4",opacity=void 0!==this.opacity?this.opacity:"1",visibility=this.visible?"":" visibility: hidden;",filter=skipShadow?"":this.getSvgFilter(),fill=getSvgColorString("fill",this.fill),stroke;return[getSvgColorString("stroke",this.stroke),"stroke-width: ",strokeWidth,"; ","stroke-dasharray: ",strokeDashArray,"; ","stroke-linecap: ",strokeLineCap,"; ","stroke-linejoin: ",strokeLineJoin,"; ","stroke-miterlimit: ",strokeMiterLimit,"; ",fill,"fill-rule: ",fillRule,"; ","opacity: ",opacity,";",filter,visibility].join("")},getSvgSpanStyles:function(style,useWhiteSpace){var term="; ",fontFamily=style.fontFamily?"font-family: "+(-1===style.fontFamily.indexOf("'")&&-1===style.fontFamily.indexOf('"')?"'"+style.fontFamily+"'":style.fontFamily)+"; ":"",strokeWidth=style.strokeWidth?"stroke-width: "+style.strokeWidth+"; ":"",fontFamily=fontFamily,fontSize=style.fontSize?"font-size: "+style.fontSize+"px; ":"",fontStyle=style.fontStyle?"font-style: "+style.fontStyle+"; ":"",fontWeight=style.fontWeight?"font-weight: "+style.fontWeight+"; ":"",fill=style.fill?getSvgColorString("fill",style.fill):"",stroke=style.stroke?getSvgColorString("stroke",style.stroke):"",textDecoration=this.getSvgTextDecoration(style),deltaY;return textDecoration&&(textDecoration="text-decoration: "+textDecoration+"; "),[stroke,strokeWidth,fontFamily,fontSize,fontStyle,fontWeight,textDecoration,fill,style.deltaY?"baseline-shift: "+-style.deltaY+"; ":"",useWhiteSpace?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(style){return"overline"in style||"underline"in style||"linethrough"in style?(style.overline?"overline ":"")+(style.underline?"underline ":"")+(style.linethrough?"line-through ":""):""},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(){var angle=this.angle,skewX=this.skewX%360,skewY=this.skewY%360,center=this.getCenterPoint(),NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS,translatePart="translate("+toFixed(center.x,NUM_FRACTION_DIGITS)+" "+toFixed(center.y,NUM_FRACTION_DIGITS)+")",anglePart=0!==angle?" rotate("+toFixed(angle,NUM_FRACTION_DIGITS)+")":"",scalePart=1===this.scaleX&&1===this.scaleY?"":" scale("+toFixed(this.scaleX,NUM_FRACTION_DIGITS)+" "+toFixed(this.scaleY,NUM_FRACTION_DIGITS)+")",skewXPart=0!==skewX?" skewX("+toFixed(skewX,NUM_FRACTION_DIGITS)+")":"",skewYPart=0!==skewY?" skewY("+toFixed(skewY,NUM_FRACTION_DIGITS)+")":"",flipXPart,flipYPart;return[translatePart,anglePart,scalePart,this.flipX?" matrix(-1 0 0 1 0 0) ":"",this.flipY?" matrix(1 0 0 -1 0 0)":"",skewXPart,skewYPart].join("")},getSvgTransformMatrix:function(){return this.transformMatrix?" matrix("+this.transformMatrix.join(" ")+") ":""},_setSVGBg:function(textBgRects){if(this.backgroundColor){var NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS;textBgRects.push("\t\t<rect ",this._getFillAttributes(this.backgroundColor),' x="',toFixed(-this.width/2,NUM_FRACTION_DIGITS),'" y="',toFixed(-this.height/2,NUM_FRACTION_DIGITS),'" width="',toFixed(this.width,NUM_FRACTION_DIGITS),'" height="',toFixed(this.height,NUM_FRACTION_DIGITS),'"></rect>\n')}},_createBaseSVGMarkup:function(){var markup=[],clipPath=this.clipPath;return this.fill&&this.fill.toLive&&markup.push(this.fill.toSVG(this,!1)),this.stroke&&this.stroke.toLive&&markup.push(this.stroke.toSVG(this,!1)),this.shadow&&markup.push(this.shadow.toSVG(this)),clipPath&&(clipPath.clipPathId="CLIPPATH_"+fabric.Object.__uid++,markup.push('<clipPath id="'+clipPath.clipPathId+'" >\n\t',this.clipPath.toSVG(),"</clipPath>\n")),markup},addPaintOrder:function(){return"fill"!==this.paintFirst?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var extend=fabric.util.object.extend,originalSet="stateProperties";function saveProps(origin,destination,props){var tmpObj={},deep=!0;props.forEach(function(prop){tmpObj[prop]=origin[prop]}),extend(origin[destination],tmpObj,!0)}function _isEqual(origValue,currentValue,firstPass){if(origValue===currentValue)return!0;if(Array.isArray(origValue)){if(!Array.isArray(currentValue)||origValue.length!==currentValue.length)return!1;for(var i=0,len=origValue.length;i<len;i++)if(!_isEqual(origValue[i],currentValue[i]))return!1;return!0}if(origValue&&"object"==typeof origValue){var keys=Object.keys(origValue),key;if(!currentValue||"object"!=typeof currentValue||!firstPass&&keys.length!==Object.keys(currentValue).length)return!1;for(var i=0,len=keys.length;i<len;i++)if(!_isEqual(origValue[key=keys[i]],currentValue[key]))return!1;return!0}}fabric.util.object.extend(fabric.Object.prototype,{hasStateChanged:function(propertySet){var dashedPropertySet="_"+(propertySet=propertySet||originalSet);return Object.keys(this[dashedPropertySet]).length<this[propertySet].length||!_isEqual(this[dashedPropertySet],this,!0)},saveState:function(options){var propertySet=options&&options.propertySet||originalSet,destination="_"+propertySet;return this[destination]?(saveProps(this,destination,this[propertySet]),options&&options.stateProperties&&saveProps(this,destination,options.stateProperties),this):this.setupState(options)},setupState:function(options){var propertySet=(options=options||{}).propertySet||originalSet;return options.propertySet=propertySet,this["_"+propertySet]={},this.saveState(options),this}})}(),function(){var degreesToRadians=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{_controlsVisibility:null,_findTargetCorner:function(pointer){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var ex=pointer.x,ey=pointer.y,xPoints,lines;for(var i in this.__corner=0,this.oCoords)if(this.isControlVisible(i)&&("mtr"!==i||this.hasRotatingPoint)&&(!this.get("lockUniScaling")||"mt"!==i&&"mr"!==i&&"mb"!==i&&"ml"!==i)&&(lines=this._getImageLines(this.oCoords[i].corner),0!==(xPoints=this._findCrossPoints({x:ex,y:ey},lines))&&xPoints%2==1))return this.__corner=i,i;return!1},_setCornerCoords:function(){var coords=this.oCoords,newTheta=degreesToRadians(45-this.angle),cornerHypotenuse=.707106*this.cornerSize,cosHalfOffset=cornerHypotenuse*fabric.util.cos(newTheta),sinHalfOffset=cornerHypotenuse*fabric.util.sin(newTheta),x,y;for(var point in coords)x=coords[point].x,y=coords[point].y,coords[point].corner={tl:{x:x-sinHalfOffset,y:y-cosHalfOffset},tr:{x:x+cosHalfOffset,y:y-sinHalfOffset},bl:{x:x-cosHalfOffset,y:y+sinHalfOffset},br:{x:x+sinHalfOffset,y:y+cosHalfOffset}}},drawSelectionBackground:function(ctx){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;ctx.save();var center=this.getCenterPoint(),wh=this._calculateCurrentDimensions(),vpt=this.canvas.viewportTransform;return ctx.translate(center.x,center.y),ctx.scale(1/vpt[0],1/vpt[3]),ctx.rotate(degreesToRadians(this.angle)),ctx.fillStyle=this.selectionBackgroundColor,ctx.fillRect(-wh.x/2,-wh.y/2,wh.x,wh.y),ctx.restore(),this},drawBorders:function(ctx,styleOverride){styleOverride=styleOverride||{};var wh=this._calculateCurrentDimensions(),strokeWidth=1/this.borderScaleFactor,width=wh.x+strokeWidth,height=wh.y+strokeWidth,drawRotatingPoint=void 0!==styleOverride.hasRotatingPoint?styleOverride.hasRotatingPoint:this.hasRotatingPoint,hasControls=void 0!==styleOverride.hasControls?styleOverride.hasControls:this.hasControls,rotatingPointOffset=void 0!==styleOverride.rotatingPointOffset?styleOverride.rotatingPointOffset:this.rotatingPointOffset;ctx.save(),ctx.strokeStyle=styleOverride.borderColor||this.borderColor,this._setLineDash(ctx,styleOverride.borderDashArray||this.borderDashArray,null),ctx.beginPath();var rd=Math.sqrt(width/2*(width/2)+height/2*(height/2));return ctx.arc(0,0,rd,0,2*Math.PI),ctx.lineWidth=2,ctx.stroke(),drawRotatingPoint&&this.isControlVisible("mtr"),ctx.restore(),this},drawBordersInGroup:function(ctx,options,styleOverride){styleOverride=styleOverride||{};var p=this._getNonTransformedDimensions(),matrix=fabric.util.customTransformMatrix(options.scaleX,options.scaleY,options.skewX),wh=fabric.util.transformPoint(p,matrix),strokeWidth=1/this.borderScaleFactor,width=wh.x+strokeWidth,height=wh.y+strokeWidth;return ctx.save(),this._setLineDash(ctx,styleOverride.borderDashArray||this.borderDashArray,null),ctx.strokeStyle=styleOverride.borderColor||this.borderColor,ctx.strokeRect(-width/2,-height/2,width,height),ctx.restore(),this},drawControls:function(ctx,styleOverride){styleOverride=styleOverride||{};var wh=this._calculateCurrentDimensions(),width=wh.x,height=wh.y,scaleOffset=styleOverride.cornerSize||this.cornerSize,left=-(width+scaleOffset)/2,top=-(height+scaleOffset)/2,transparentCorners=void 0!==styleOverride.transparentCorners?styleOverride.transparentCorners:this.transparentCorners,hasRotatingPoint=void 0!==styleOverride.hasRotatingPoint?styleOverride.hasRotatingPoint:this.hasRotatingPoint,methodName=transparentCorners?"stroke":"fill";if(ctx.save(),ctx.strokeStyle=ctx.fillStyle=styleOverride.cornerColor||this.cornerColor,this.transparentCorners||(ctx.strokeStyle=styleOverride.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(ctx,styleOverride.cornerDashArray||this.cornerDashArray,null),this._drawControl("tl",ctx,methodName,left,top,styleOverride),this._drawControl("tr",ctx,methodName,left+width,top,styleOverride),this._drawControl("bl",ctx,methodName,left,top+height,styleOverride),this._drawControl("br",ctx,methodName,left+width,top+height,styleOverride),this.get("lockUniScaling")||(this._drawControl("mt",ctx,methodName,left+width/2,top,styleOverride),this._drawControl("mb",ctx,methodName,left+width/2,top+height,styleOverride),this._drawControl("mr",ctx,methodName,left+width,top+height/2,styleOverride),this._drawControl("ml",ctx,methodName,left,top+height/2,styleOverride)),hasRotatingPoint){var rd=Math.sqrt(width/2*(width/2)+width/2*(width/2));this._drawControl("mtr",ctx,methodName,left,top,styleOverride)}return ctx.restore(),this},_drawControl:function(control,ctx,methodName,left,top,styleOverride){if(styleOverride=styleOverride||{},this.isControlVisible(control)){var size=this.cornerSize,stroke=!this.transparentCorners&&this.cornerStrokeColor;switch(styleOverride.cornerStyle||this.cornerStyle){case"circle":ctx.beginPath(),ctx.arc(left+size/2,top+size/2,size/2,0,2*Math.PI,!1),ctx[methodName](),stroke&&ctx.stroke();break;default:this.transparentCorners||ctx.clearRect(left,top,size,size),ctx[methodName+"Rect"](left,top,size,size),stroke&&ctx.strokeRect(left,top,size,size)}}},isControlVisible:function(controlName){return this._getControlsVisibility()[controlName]},setControlVisible:function(controlName,visible){return this._getControlsVisibility()[controlName]=visible,this},setControlsVisibility:function(options){for(var p in options||(options={}),options)this.setControlVisible(p,options[p]);return this},_getControlsVisibility:function(){return this._controlsVisibility||(this._controlsVisibility={tl:!0,tr:!0,br:!0,bl:!0,ml:!0,mt:!0,mr:!0,mb:!0,mtr:!0}),this._controlsVisibility},onDeselect:function(){},onSelect:function(){}})}(),fabric.util.object.extend(fabric.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(object,callbacks){var empty=function(){},onComplete=(callbacks=callbacks||{}).onComplete||empty,onChange=callbacks.onChange||empty,_this=this;return fabric.util.animate({startValue:object.left,endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(value){object.set("left",value),_this.requestRenderAll(),onChange()},onComplete:function(){object.setCoords(),onComplete()}}),this},fxCenterObjectV:function(object,callbacks){var empty=function(){},onComplete=(callbacks=callbacks||{}).onComplete||empty,onChange=callbacks.onChange||empty,_this=this;return fabric.util.animate({startValue:object.top,endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(value){object.set("top",value),_this.requestRenderAll(),onChange()},onComplete:function(){object.setCoords(),onComplete()}}),this},fxRemove:function(object,callbacks){var empty=function(){},onComplete=(callbacks=callbacks||{}).onComplete||empty,onChange=callbacks.onChange||empty,_this=this;return fabric.util.animate({startValue:object.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(value){object.set("opacity",value),_this.requestRenderAll(),onChange()},onComplete:function(){_this.remove(object),onComplete()}}),this}}),fabric.util.object.extend(fabric.Object.prototype,{animate:function(){if(arguments[0]&&"object"==typeof arguments[0]){var propsToAnimate=[],prop,skipCallbacks;for(prop in arguments[0])propsToAnimate.push(prop);for(var i=0,len=propsToAnimate.length;i<len;i++)prop=propsToAnimate[i],skipCallbacks=i!==len-1,this._animate(prop,arguments[0][prop],arguments[1],skipCallbacks)}else this._animate.apply(this,arguments);return this},_animate:function(property,to,options,skipCallbacks){var _this=this,propPair;to=to.toString(),options=options?fabric.util.object.clone(options):{},~property.indexOf(".")&&(propPair=property.split("."));var currentValue=propPair?this.get(propPair[0])[propPair[1]]:this.get(property);"from"in options||(options.from=currentValue),to=~to.indexOf("=")?currentValue+parseFloat(to.replace("=","")):parseFloat(to),fabric.util.animate({startValue:options.from,endValue:to,byValue:options.by,easing:options.easing,duration:options.duration,abort:options.abort&&function(){return options.abort.call(_this)},onChange:function(value,valueProgress,timeProgress){propPair?_this[propPair[0]][propPair[1]]=value:_this.set(property,value),skipCallbacks||options.onChange&&options.onChange(value,valueProgress,timeProgress)},onComplete:function(value,valueProgress,timeProgress){skipCallbacks||(_this.setCoords(),options.onComplete&&options.onComplete(value,valueProgress,timeProgress))}})}}),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,clone=fabric.util.object.clone,coordProps={x1:1,x2:1,y1:1,y2:1},supportsLineDash=fabric.StaticCanvas.supports("setLineDash");function makeEdgeToOriginGetter(propertyNames,originValues){var origin=propertyNames.origin,axis1=propertyNames.axis1,axis2=propertyNames.axis2,dimension=propertyNames.dimension,nearest=originValues.nearest,center=originValues.center,farthest=originValues.farthest;return function(){switch(this.get(origin)){case nearest:return Math.min(this.get(axis1),this.get(axis2));case center:return Math.min(this.get(axis1),this.get(axis2))+.5*this.get(dimension);case farthest:return Math.max(this.get(axis1),this.get(axis2))}}}fabric.Line?fabric.warn("fabric.Line is already defined"):(fabric.Line=fabric.util.createClass(fabric.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:fabric.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(points,options){points||(points=[0,0,0,0]),this.callSuper("initialize",options),this.set("x1",points[0]),this.set("y1",points[1]),this.set("x2",points[2]),this.set("y2",points[3]),this._setWidthHeight(options)},_setWidthHeight:function(options){options||(options={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in options?options.left:this._getLeftToOriginX(),this.top="top"in options?options.top:this._getTopToOriginY()},_set:function(key,value){return this.callSuper("_set",key,value),void 0!==coordProps[key]&&this._setWidthHeight(),this},_getLeftToOriginX:makeEdgeToOriginGetter({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:makeEdgeToOriginGetter({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(ctx){if(ctx.beginPath(),!this.strokeDashArray||this.strokeDashArray&&supportsLineDash){var p=this.calcLinePoints();ctx.moveTo(p.x1,p.y1),ctx.lineTo(p.x2,p.y2)}ctx.lineWidth=this.strokeWidth;var origStrokeStyle=ctx.strokeStyle;ctx.strokeStyle=this.stroke||ctx.fillStyle,this.stroke&&this._renderStroke(ctx),ctx.strokeStyle=origStrokeStyle},_renderDashedStroke:function(ctx){var p=this.calcLinePoints();ctx.beginPath(),fabric.util.drawDashedLine(ctx,p.x1,p.y1,p.x2,p.y2,this.strokeDashArray),ctx.closePath()},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(propertiesToInclude){return extend(this.callSuper("toObject",propertiesToInclude),this.calcLinePoints())},_getNonTransformedDimensions:function(){var dim=this.callSuper("_getNonTransformedDimensions");return"butt"===this.strokeLineCap&&(0===this.width&&(dim.y-=this.strokeWidth),0===this.height&&(dim.x-=this.strokeWidth)),dim},calcLinePoints:function(){var xMult=this.x1<=this.x2?-1:1,yMult=this.y1<=this.y2?-1:1,x1=xMult*this.width*.5,y1=yMult*this.height*.5,x2,y2;return{x1:x1,x2:xMult*this.width*-.5,y1:y1,y2:yMult*this.height*-.5}},toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),p=this.calcLinePoints();return markup.push("<line ",this.getSvgCommons(),'x1="',p.x1,'" y1="',p.y1,'" x2="',p.x2,'" y2="',p.y2,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'"/>\n'),reviver?reviver(markup.join("")):markup.join("")}}),fabric.Line.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),fabric.Line.fromElement=function(element,callback,options){options=options||{};var parsedAttributes=fabric.parseAttributes(element,fabric.Line.ATTRIBUTE_NAMES),points=[parsedAttributes.x1||0,parsedAttributes.y1||0,parsedAttributes.x2||0,parsedAttributes.y2||0];callback(new fabric.Line(points,extend(parsedAttributes,options)))},fabric.Line.fromObject=function(object,callback){function _callback(instance){delete instance.points,callback&&callback(instance)}var options=clone(object,!0);options.points=[object.x1,object.y1,object.x2,object.y2],fabric.Object._fromObject("Line",options,_callback,"points")})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),pi=Math.PI;function isValidRadius(attributes){return"radius"in attributes&&attributes.radius>=0}fabric.Circle?fabric.warn("fabric.Circle is already defined."):(fabric.Circle=fabric.util.createClass(fabric.Object,{type:"circle",radius:0,startAngle:0,endAngle:2*pi,cacheProperties:fabric.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(key,value){return this.callSuper("_set",key,value),"radius"===key&&this.setRadius(value),this},toObject:function(propertiesToInclude){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(propertiesToInclude))},toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),x=0,y=0,angle=(this.endAngle-this.startAngle)%(2*pi);if(0===angle)markup.push("<circle ",this.getSvgCommons(),'cx="0" cy="0" ','r="',this.radius,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform()," ",this.getSvgTransformMatrix(),'"',this.addPaintOrder(),"/>\n");else{var startX=fabric.util.cos(this.startAngle)*this.radius,startY=fabric.util.sin(this.startAngle)*this.radius,endX=fabric.util.cos(this.endAngle)*this.radius,endY=fabric.util.sin(this.endAngle)*this.radius,largeFlag=angle>pi?"1":"0";markup.push('<path d="M '+startX+" "+startY," A "+this.radius+" "+this.radius," 0 ",+largeFlag+" 1"," "+endX+" "+endY,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform()," ",this.getSvgTransformMatrix(),'"',this.addPaintOrder(),"/>\n")}return reviver?reviver(markup.join("")):markup.join("")},_render:function(ctx){ctx.beginPath(),ctx.arc(0,0,this.radius,this.startAngle,this.endAngle,!1),this._renderPaintInOrder(ctx)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(value){return this.radius=value,this.set("width",2*value).set("height",2*value)}}),fabric.Circle.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),fabric.Circle.fromElement=function(element,callback){var parsedAttributes=fabric.parseAttributes(element,fabric.Circle.ATTRIBUTE_NAMES);if(!isValidRadius(parsedAttributes))throw new Error("value of `r` attribute is required and can not be negative");parsedAttributes.left=(parsedAttributes.left||0)-parsedAttributes.radius,parsedAttributes.top=(parsedAttributes.top||0)-parsedAttributes.radius,callback(new fabric.Circle(parsedAttributes))},fabric.Circle.fromObject=function(object,callback){return fabric.Object._fromObject("Circle",object,callback)})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={});fabric.Triangle?fabric.warn("fabric.Triangle is already defined"):(fabric.Triangle=fabric.util.createClass(fabric.Object,{type:"triangle",width:100,height:100,_render:function(ctx){var widthBy2=this.width/2,heightBy2=this.height/2;ctx.beginPath(),ctx.moveTo(-widthBy2,heightBy2),ctx.lineTo(0,-heightBy2),ctx.lineTo(widthBy2,heightBy2),ctx.closePath(),this._renderPaintInOrder(ctx)},_renderDashedStroke:function(ctx){var widthBy2=this.width/2,heightBy2=this.height/2;ctx.beginPath(),fabric.util.drawDashedLine(ctx,-widthBy2,heightBy2,0,-heightBy2,this.strokeDashArray),fabric.util.drawDashedLine(ctx,0,-heightBy2,widthBy2,heightBy2,this.strokeDashArray),fabric.util.drawDashedLine(ctx,widthBy2,heightBy2,-widthBy2,heightBy2,this.strokeDashArray),ctx.closePath()},toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),widthBy2=this.width/2,heightBy2=this.height/2,points=[-widthBy2+" "+heightBy2,"0 "+-heightBy2,widthBy2+" "+heightBy2].join(",");return markup.push("<polygon ",this.getSvgCommons(),'points="',points,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'"',this.addPaintOrder(),"/>"),reviver?reviver(markup.join("")):markup.join("")}}),fabric.Triangle.fromObject=function(object,callback){return fabric.Object._fromObject("Triangle",object,callback)})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),piBy2=2*Math.PI;fabric.Ellipse?fabric.warn("fabric.Ellipse is already defined."):(fabric.Ellipse=fabric.util.createClass(fabric.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:fabric.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(options){this.callSuper("initialize",options),this.set("rx",options&&options.rx||0),this.set("ry",options&&options.ry||0)},_set:function(key,value){switch(this.callSuper("_set",key,value),key){case"rx":this.rx=value,this.set("width",2*value);break;case"ry":this.ry=value,this.set("height",2*value)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(propertiesToInclude){return this.callSuper("toObject",["rx","ry"].concat(propertiesToInclude))},toSVG:function(reviver){var markup=this._createBaseSVGMarkup();return markup.push("<ellipse ",this.getSvgCommons(),'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'"',this.addPaintOrder(),"/>\n"),reviver?reviver(markup.join("")):markup.join("")},_render:function(ctx){ctx.beginPath(),ctx.save(),ctx.transform(1,0,0,this.ry/this.rx,0,0),ctx.arc(0,0,this.rx,0,piBy2,!1),ctx.restore(),this._renderPaintInOrder(ctx)}}),fabric.Ellipse.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),fabric.Ellipse.fromElement=function(element,callback){var parsedAttributes=fabric.parseAttributes(element,fabric.Ellipse.ATTRIBUTE_NAMES);parsedAttributes.left=(parsedAttributes.left||0)-parsedAttributes.rx,parsedAttributes.top=(parsedAttributes.top||0)-parsedAttributes.ry,callback(new fabric.Ellipse(parsedAttributes))},fabric.Ellipse.fromObject=function(object,callback){return fabric.Object._fromObject("Ellipse",object,callback)})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend;fabric.Rect?fabric.warn("fabric.Rect is already defined"):(fabric.Rect=fabric.util.createClass(fabric.Object,{stateProperties:fabric.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:fabric.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(options){this.callSuper("initialize",options),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(ctx){if(1!==this.width||1!==this.height){var rx=this.rx?Math.min(this.rx,this.width/2):0,ry=this.ry?Math.min(this.ry,this.height/2):0,w=this.width,h=this.height,x=-this.width/2,y=-this.height/2,isRounded=0!==rx||0!==ry,k=.4477152502;ctx.beginPath(),ctx.moveTo(x+rx,y),ctx.lineTo(x+w-rx,y),isRounded&&ctx.bezierCurveTo(x+w-k*rx,y,x+w,y+k*ry,x+w,y+ry),ctx.lineTo(x+w,y+h-ry),isRounded&&ctx.bezierCurveTo(x+w,y+h-k*ry,x+w-k*rx,y+h,x+w-rx,y+h),ctx.lineTo(x+rx,y+h),isRounded&&ctx.bezierCurveTo(x+k*rx,y+h,x,y+h-k*ry,x,y+h-ry),ctx.lineTo(x,y+ry),isRounded&&ctx.bezierCurveTo(x,y+k*ry,x+k*rx,y,x+rx,y),ctx.closePath(),this._renderPaintInOrder(ctx)}else ctx.fillRect(-.5,-.5,1,1)},_renderDashedStroke:function(ctx){var x=-this.width/2,y=-this.height/2,w=this.width,h=this.height;ctx.beginPath(),fabric.util.drawDashedLine(ctx,x,y,x+w,y,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x+w,y,x+w,y+h,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x+w,y+h,x,y+h,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x,y+h,x,y,this.strokeDashArray),ctx.closePath()},toObject:function(propertiesToInclude){return this.callSuper("toObject",["rx","ry"].concat(propertiesToInclude))},toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),x=-this.width/2,y=-this.height/2;return markup.push("<rect ",this.getSvgCommons(),'x="',x,'" y="',y,'" rx="',this.get("rx"),'" ry="',this.get("ry"),'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'"',this.addPaintOrder(),"/>\n"),reviver?reviver(markup.join("")):markup.join("")}}),fabric.Rect.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),fabric.Rect.fromElement=function(element,callback,options){if(!element)return callback(null);options=options||{};var parsedAttributes=fabric.parseAttributes(element,fabric.Rect.ATTRIBUTE_NAMES);parsedAttributes.left=parsedAttributes.left||0,parsedAttributes.top=parsedAttributes.top||0;var rect=new fabric.Rect(extend(options?fabric.util.object.clone(options):{},parsedAttributes));rect.visible=rect.visible&&rect.width>0&&rect.height>0,callback(rect)},fabric.Rect.fromObject=function(object,callback){return fabric.Object._fromObject("Rect",object,callback)})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,min=fabric.util.array.min,max=fabric.util.array.max,toFixed=fabric.util.toFixed;fabric.Polyline?fabric.warn("fabric.Polyline is already defined"):(fabric.Polyline=fabric.util.createClass(fabric.Object,{type:"polyline",points:null,cacheProperties:fabric.Object.prototype.cacheProperties.concat("points"),initialize:function(points,options){options=options||{},this.points=points||[],this.callSuper("initialize",options);var calcDim=this._calcDimensions();void 0===options.left&&(this.left=calcDim.left),void 0===options.top&&(this.top=calcDim.top),this.width=calcDim.width,this.height=calcDim.height,this.pathOffset={x:calcDim.left+this.width/2,y:calcDim.top+this.height/2}},_calcDimensions:function(){var points=this.points,minX=min(points,"x")||0,minY=min(points,"y")||0,maxX,maxY,width,height;return{left:minX,top:minY,width:(max(points,"x")||0)-minX,height:(max(points,"y")||0)-minY}},toObject:function(propertiesToInclude){return extend(this.callSuper("toObject",propertiesToInclude),{points:this.points.concat()})},toSVG:function(reviver){for(var points=[],diffX=this.pathOffset.x,diffY=this.pathOffset.y,markup=this._createBaseSVGMarkup(),NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS,i=0,len=this.points.length;i<len;i++)points.push(toFixed(this.points[i].x-diffX,NUM_FRACTION_DIGITS),",",toFixed(this.points[i].y-diffY,NUM_FRACTION_DIGITS)," ");return markup.push("<",this.type," ",this.getSvgCommons(),'points="',points.join(""),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform()," ",this.getSvgTransformMatrix(),'"',this.addPaintOrder(),"/>\n"),reviver?reviver(markup.join("")):markup.join("")},commonRender:function(ctx){var point,len=this.points.length,x=this.pathOffset.x,y=this.pathOffset.y;if(!len||isNaN(this.points[len-1].y))return!1;ctx.beginPath(),ctx.moveTo(this.points[0].x-x,this.points[0].y-y);for(var i=0;i<len;i++)point=this.points[i],ctx.lineTo(point.x-x,point.y-y);return!0},_render:function(ctx){this.commonRender(ctx)&&this._renderPaintInOrder(ctx)},_renderDashedStroke:function(ctx){var p1,p2;ctx.beginPath();for(var i=0,len=this.points.length;i<len;i++)p1=this.points[i],p2=this.points[i+1]||p1,fabric.util.drawDashedLine(ctx,p1.x,p1.y,p2.x,p2.y,this.strokeDashArray)},complexity:function(){return this.get("points").length}}),fabric.Polyline.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat(),fabric.Polyline.fromElement=function(element,callback,options){if(!element)return callback(null);options||(options={});var points=fabric.parsePointsAttribute(element.getAttribute("points")),parsedAttributes=fabric.parseAttributes(element,fabric.Polyline.ATTRIBUTE_NAMES);callback(new fabric.Polyline(points,fabric.util.object.extend(parsedAttributes,options)))},fabric.Polyline.fromObject=function(object,callback){return fabric.Object._fromObject("Polyline",object,callback,"points")})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend;fabric.Polygon?fabric.warn("fabric.Polygon is already defined"):(fabric.Polygon=fabric.util.createClass(fabric.Polyline,{type:"polygon",_render:function(ctx){this.commonRender(ctx)&&(ctx.closePath(),this._renderPaintInOrder(ctx))},_renderDashedStroke:function(ctx){this.callSuper("_renderDashedStroke",ctx),ctx.closePath()}}),fabric.Polygon.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat(),fabric.Polygon.fromElement=function(element,callback,options){if(!element)return callback(null);options||(options={});var points=fabric.parsePointsAttribute(element.getAttribute("points")),parsedAttributes=fabric.parseAttributes(element,fabric.Polygon.ATTRIBUTE_NAMES);callback(new fabric.Polygon(points,extend(parsedAttributes,options)))},fabric.Polygon.fromObject=function(object,callback){return fabric.Object._fromObject("Polygon",object,callback,"points")})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),min=fabric.util.array.min,max=fabric.util.array.max,extend=fabric.util.object.extend,_toString=Object.prototype.toString,drawArc=fabric.util.drawArc,commandLengths={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},repeatedCommands={m:"l",M:"L"};fabric.Path?fabric.warn("fabric.Path is already defined"):(fabric.Path=fabric.util.createClass(fabric.Object,{type:"path",path:null,cacheProperties:fabric.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:fabric.Object.prototype.stateProperties.concat("path"),initialize:function(path,options){options=options||{},this.callSuper("initialize",options),path||(path=[]);var fromArray="[object Array]"===_toString.call(path);this.path=fromArray?path:path.match&&path.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi),this.path&&(fromArray||(this.path=this._parsePath()),this._setPositionDimensions(options))},_setPositionDimensions:function(options){var calcDim=this._parseDimensions();this.width=calcDim.width,this.height=calcDim.height,void 0===options.left&&(this.left=calcDim.left),void 0===options.top&&(this.top=calcDim.top),this.pathOffset=this.pathOffset||{x:calcDim.left+this.width/2,y:calcDim.top+this.height/2}},_renderPathCommands:function(ctx){var current,previous=null,subpathStartX=0,subpathStartY=0,x=0,y=0,controlX=0,controlY=0,tempX,tempY,l=-this.pathOffset.x,t=-this.pathOffset.y;ctx.beginPath();for(var i=0,len=this.path.length;i<len;++i){switch((current=this.path[i])[0]){case"l":x+=current[1],y+=current[2],ctx.lineTo(x+l,y+t);break;case"L":x=current[1],y=current[2],ctx.lineTo(x+l,y+t);break;case"h":x+=current[1],ctx.lineTo(x+l,y+t);break;case"H":x=current[1],ctx.lineTo(x+l,y+t);break;case"v":y+=current[1],ctx.lineTo(x+l,y+t);break;case"V":y=current[1],ctx.lineTo(x+l,y+t);break;case"m":subpathStartX=x+=current[1],subpathStartY=y+=current[2],ctx.moveTo(x+l,y+t);break;case"M":subpathStartX=x=current[1],subpathStartY=y=current[2],ctx.moveTo(x+l,y+t);break;case"c":tempX=x+current[5],tempY=y+current[6],controlX=x+current[3],controlY=y+current[4],ctx.bezierCurveTo(x+current[1]+l,y+current[2]+t,controlX+l,controlY+t,tempX+l,tempY+t),x=tempX,y=tempY;break;case"C":x=current[5],y=current[6],controlX=current[3],controlY=current[4],ctx.bezierCurveTo(current[1]+l,current[2]+t,controlX+l,controlY+t,x+l,y+t);break;case"s":tempX=x+current[3],tempY=y+current[4],null===previous[0].match(/[CcSs]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),ctx.bezierCurveTo(controlX+l,controlY+t,x+current[1]+l,y+current[2]+t,tempX+l,tempY+t),controlX=x+current[1],controlY=y+current[2],x=tempX,y=tempY;break;case"S":tempX=current[3],tempY=current[4],null===previous[0].match(/[CcSs]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),ctx.bezierCurveTo(controlX+l,controlY+t,current[1]+l,current[2]+t,tempX+l,tempY+t),x=tempX,y=tempY,controlX=current[1],controlY=current[2];break;case"q":tempX=x+current[3],tempY=y+current[4],controlX=x+current[1],controlY=y+current[2],ctx.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t),x=tempX,y=tempY;break;case"Q":tempX=current[3],tempY=current[4],ctx.quadraticCurveTo(current[1]+l,current[2]+t,tempX+l,tempY+t),x=tempX,y=tempY,controlX=current[1],controlY=current[2];break;case"t":tempX=x+current[1],tempY=y+current[2],null===previous[0].match(/[QqTt]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),ctx.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t),x=tempX,y=tempY;break;case"T":tempX=current[1],tempY=current[2],null===previous[0].match(/[QqTt]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),ctx.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t),x=tempX,y=tempY;break;case"a":drawArc(ctx,x+l,y+t,[current[1],current[2],current[3],current[4],current[5],current[6]+x+l,current[7]+y+t]),x+=current[6],y+=current[7];break;case"A":drawArc(ctx,x+l,y+t,[current[1],current[2],current[3],current[4],current[5],current[6]+l,current[7]+t]),x=current[6],y=current[7];break;case"z":case"Z":x=subpathStartX,y=subpathStartY,ctx.closePath()}previous=current}},_render:function(ctx){this._renderPathCommands(ctx),this._renderPaintInOrder(ctx)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(propertiesToInclude){var o;return extend(this.callSuper("toObject",propertiesToInclude),{path:this.path.map(function(item){return item.slice()}),top:this.top,left:this.left})},toDatalessObject:function(propertiesToInclude){var o=this.toObject(["sourcePath"].concat(propertiesToInclude));return o.sourcePath&&delete o.path,o},toSVG:function(reviver){for(var chunks=[],markup=this._createBaseSVGMarkup(),addTransform="",i=0,len=this.path.length;i<len;i++)chunks.push(this.path[i].join(" "));var path=chunks.join(" ");return addTransform=" translate("+-this.pathOffset.x+", "+-this.pathOffset.y+") ",markup.push("<path ",this.getSvgCommons(),'d="',path,'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),addTransform,this.getSvgTransformMatrix(),'" stroke-linecap="round" ',this.addPaintOrder(),"/>\n"),reviver?reviver(markup.join("")):markup.join("")},complexity:function(){return this.path.length},_parsePath:function(){for(var result=[],coords=[],currentPath,parsed,re=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi,match,coordsStr,i=0,coordsParsed,len=this.path.length;i<len;i++){for(coordsStr=(currentPath=this.path[i]).slice(1).trim(),coords.length=0;match=re.exec(coordsStr);)coords.push(match[0]);coordsParsed=[currentPath.charAt(0)];for(var j=0,jlen=coords.length;j<jlen;j++)parsed=parseFloat(coords[j]),isNaN(parsed)||coordsParsed.push(parsed);var command=coordsParsed[0],commandLength=commandLengths[command.toLowerCase()],repeatedCommand=repeatedCommands[command]||command;if(coordsParsed.length-1>commandLength)for(var k=1,klen=coordsParsed.length;k<klen;k+=commandLength)result.push([command].concat(coordsParsed.slice(k,k+commandLength))),command=repeatedCommand;else result.push(coordsParsed)}return result},_parseDimensions:function(){for(var aX=[],aY=[],current,previous=null,subpathStartX=0,subpathStartY=0,x=0,y=0,controlX=0,controlY=0,tempX,tempY,bounds,i=0,len=this.path.length;i<len;++i){switch((current=this.path[i])[0]){case"l":x+=current[1],y+=current[2],bounds=[];break;case"L":x=current[1],y=current[2],bounds=[];break;case"h":x+=current[1],bounds=[];break;case"H":x=current[1],bounds=[];break;case"v":y+=current[1],bounds=[];break;case"V":y=current[1],bounds=[];break;case"m":subpathStartX=x+=current[1],subpathStartY=y+=current[2],bounds=[];break;case"M":subpathStartX=x=current[1],subpathStartY=y=current[2],bounds=[];break;case"c":tempX=x+current[5],tempY=y+current[6],controlX=x+current[3],controlY=y+current[4],bounds=fabric.util.getBoundsOfCurve(x,y,x+current[1],y+current[2],controlX,controlY,tempX,tempY),x=tempX,y=tempY;break;case"C":controlX=current[3],controlY=current[4],bounds=fabric.util.getBoundsOfCurve(x,y,current[1],current[2],controlX,controlY,current[5],current[6]),x=current[5],y=current[6];break;case"s":tempX=x+current[3],tempY=y+current[4],null===previous[0].match(/[CcSs]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,x+current[1],y+current[2],tempX,tempY),controlX=x+current[1],controlY=y+current[2],x=tempX,y=tempY;break;case"S":tempX=current[3],tempY=current[4],null===previous[0].match(/[CcSs]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,current[1],current[2],tempX,tempY),x=tempX,y=tempY,controlX=current[1],controlY=current[2];break;case"q":tempX=x+current[3],tempY=y+current[4],controlX=x+current[1],controlY=y+current[2],bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,controlX,controlY,tempX,tempY),x=tempX,y=tempY;break;case"Q":controlX=current[1],controlY=current[2],bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,controlX,controlY,current[3],current[4]),x=current[3],y=current[4];break;case"t":tempX=x+current[1],tempY=y+current[2],null===previous[0].match(/[QqTt]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,controlX,controlY,tempX,tempY),x=tempX,y=tempY;break;case"T":tempX=current[1],tempY=current[2],null===previous[0].match(/[QqTt]/)?(controlX=x,controlY=y):(controlX=2*x-controlX,controlY=2*y-controlY),bounds=fabric.util.getBoundsOfCurve(x,y,controlX,controlY,controlX,controlY,tempX,tempY),x=tempX,y=tempY;break;case"a":bounds=fabric.util.getBoundsOfArc(x,y,current[1],current[2],current[3],current[4],current[5],current[6]+x,current[7]+y),x+=current[6],y+=current[7];break;case"A":bounds=fabric.util.getBoundsOfArc(x,y,current[1],current[2],current[3],current[4],current[5],current[6],current[7]),x=current[6],y=current[7];break;case"z":case"Z":x=subpathStartX,y=subpathStartY}previous=current,bounds.forEach(function(point){aX.push(point.x),aY.push(point.y)}),aX.push(x),aY.push(y)}var minX=min(aX)||0,minY=min(aY)||0,maxX,maxY,deltaX,deltaY,o;return{left:minX,top:minY,width:(max(aX)||0)-minX,height:(max(aY)||0)-minY}}}),fabric.Path.fromObject=function(object,callback){if("string"==typeof object.sourcePath){var pathUrl=object.sourcePath;fabric.loadSVGFromURL(pathUrl,function(elements){var path=elements[0];path.setOptions(object),callback&&callback(path)})}else fabric.Object._fromObject("Path",object,callback,"path")},fabric.Path.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat(["d"]),fabric.Path.fromElement=function(element,callback,options){var parsedAttributes=fabric.parseAttributes(element,fabric.Path.ATTRIBUTE_NAMES);callback(new fabric.Path(parsedAttributes.d,extend(parsedAttributes,options)))})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),min=fabric.util.array.min,max=fabric.util.array.max;fabric.Group||(fabric.Group=fabric.util.createClass(fabric.Object,fabric.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(objects,options,isAlreadyGrouped){options=options||{},this._objects=[],isAlreadyGrouped&&this.callSuper("initialize",options),this._objects=objects||[];for(var i=this._objects.length;i--;)this._objects[i].group=this;if(isAlreadyGrouped)this._updateObjectsACoords();else{var center=options&&options.centerPoint;void 0!==options.originX&&(this.originX=options.originX),void 0!==options.originY&&(this.originY=options.originY),center||this._calcBounds(),this._updateObjectsCoords(center),delete options.centerPoint,this.callSuper("initialize",options)}this.setCoords()},_updateObjectsACoords:function(){for(var ignoreZoom=!0,skipAbsolute=!0,i=this._objects.length;i--;)this._objects[i].setCoords(!0,!0)},_updateObjectsCoords:function(center){for(var center=center||this.getCenterPoint(),i=this._objects.length;i--;)this._updateObjectCoords(this._objects[i],center)},_updateObjectCoords:function(object,center){var objectLeft=object.left,objectTop=object.top,ignoreZoom=!0,skipAbsolute=!0;object.set({left:objectLeft-center.x,top:objectTop-center.y}),object.group=this,object.setCoords(!0,!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(object){return this._restoreObjectsState(),fabric.util.resetObjectTransform(this),object&&(this._objects.push(object),object.group=this,object._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},removeWithUpdate:function(object){return this._restoreObjectsState(),fabric.util.resetObjectTransform(this),this.remove(object),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(object){this.dirty=!0,object.group=this,object._set("canvas",this.canvas)},_onObjectRemoved:function(object){this.dirty=!0,delete object.group},_set:function(key,value){var i=this._objects.length;if(this.useSetOnGroup)for(;i--;)this._objects[i].setOnGroup(key,value);if("canvas"===key)for(;i--;)this._objects[i]._set(key,value);fabric.Object.prototype._set.call(this,key,value)},toObject:function(propertiesToInclude){var objsToObject=this._objects.map(function(obj){var originalDefaults=obj.includeDefaultValues;obj.includeDefaultValues=obj.group.includeDefaultValues;var _obj=obj.toObject(propertiesToInclude);return obj.includeDefaultValues=originalDefaults,_obj}),obj=fabric.Object.prototype.toObject.call(this,propertiesToInclude);return obj.objects=objsToObject,obj},toDatalessObject:function(propertiesToInclude){var objsToObject,sourcePath=this.sourcePath;objsToObject=sourcePath||this._objects.map(function(obj){var originalDefaults=obj.includeDefaultValues;obj.includeDefaultValues=obj.group.includeDefaultValues;var _obj=obj.toDatalessObject(propertiesToInclude);return obj.includeDefaultValues=originalDefaults,_obj});var obj=fabric.Object.prototype.toDatalessObject.call(this,propertiesToInclude);return obj.objects=objsToObject,obj},render:function(ctx){this._transformDone=!0,this.callSuper("render",ctx),this._transformDone=!1},shouldCache:function(){var ownCache=this.objectCaching&&(!this.group||this.needsItsOwnCache()||!this.group.isOnACache());if(this.ownCaching=ownCache,ownCache)for(var i=0,len=this._objects.length;i<len;i++)if(this._objects[i].willDrawShadow())return this.ownCaching=!1,!1;return ownCache},willDrawShadow:function(){if(this.shadow)return fabric.Object.prototype.willDrawShadow.call(this);for(var i=0,len=this._objects.length;i<len;i++)if(this._objects[i].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(ctx){for(var i=0,len=this._objects.length;i<len;i++)this._objects[i].render(ctx);this._drawClipPath(ctx)},isCacheDirty:function(skipCanvas){if(this.callSuper("isCacheDirty",skipCanvas))return!0;if(!this.statefullCache)return!1;for(var i=0,len=this._objects.length;i<len;i++)if(this._objects[i].isCacheDirty(!0)){if(this._cacheCanvas){var x=this.cacheWidth/this.zoomX,y=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-x/2,-y/2,x,y)}return!0}return!1},_restoreObjectsState:function(){return this._objects.forEach(this._restoreObjectState,this),this},realizeTransform:function(object){var matrix=object.calcTransformMatrix(),options=fabric.util.qrDecompose(matrix),center=new fabric.Point(options.translateX,options.translateY);return object.flipX=!1,object.flipY=!1,object.set("scaleX",options.scaleX),object.set("scaleY",options.scaleY),object.skewX=options.skewX,object.skewY=options.skewY,object.angle=options.angle,object.setPositionByOrigin(center,"center","center"),object},_restoreObjectState:function(object){return this.realizeTransform(object),object.setCoords(),delete object.group,this},destroy:function(){return this._objects.forEach(function(object){object.set("dirty",!0)}),this._restoreObjectsState()},toActiveSelection:function(){if(this.canvas){var objects=this._objects,canvas=this.canvas;this._objects=[];var options=this.toObject();delete options.objects;var activeSelection=new fabric.ActiveSelection([]);return activeSelection.set(options),activeSelection.type="activeSelection",canvas.remove(this),objects.forEach(function(object){object.group=activeSelection,object.dirty=!0,canvas.add(object)}),activeSelection.canvas=canvas,activeSelection._objects=objects,canvas._activeObject=activeSelection,activeSelection.setCoords(),activeSelection}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var ignoreZoom=!0,skipAbsolute=!0;return this.forEachObject(function(object){object.setCoords(!0,!0)}),this},_calcBounds:function(onlyWidthHeight){for(var aX=[],aY=[],o,prop,props=["tr","br","bl","tl"],i=0,iLen=this._objects.length,j,jLen=props.length,ignoreZoom=!0;i<iLen;++i)for((o=this._objects[i]).setCoords(!0),j=0;j<jLen;j++)prop=props[j],aX.push(o.oCoords[prop].x),aY.push(o.oCoords[prop].y);this._getBounds(aX,aY,onlyWidthHeight)},_getBounds:function(aX,aY,onlyWidthHeight){var minXY=new fabric.Point(min(aX),min(aY)),maxXY=new fabric.Point(max(aX),max(aY)),top=minXY.y||0,left=minXY.x||0,width=maxXY.x-minXY.x||0,height=maxXY.y-minXY.y||0;this.width=width,this.height=height,onlyWidthHeight||this.setPositionByOrigin({x:left,y:top},"left","top")},toSVG:function(reviver){var markup=this._createBaseSVGMarkup();markup.push("<g ",this.getSvgCommons(),'transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'" style="',this.getSvgFilter(),'">\n');for(var i=0,len=this._objects.length;i<len;i++)markup.push("\t",this._objects[i].toSVG(reviver));return markup.push("</g>\n"),reviver?reviver(markup.join("")):markup.join("")}}),fabric.Group.fromObject=function(object,callback){fabric.util.enlivenObjects(object.objects,function(enlivenedObjects){var options=fabric.util.object.clone(object,!0);delete options.objects,callback&&callback(new fabric.Group(enlivenedObjects,options,!0))})})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={});fabric.ActiveSelection||(fabric.ActiveSelection=fabric.util.createClass(fabric.Group,{type:"activeSelection",initialize:function(objects,options){options=options||{},this._objects=objects||[];for(var i=this._objects.length;i--;)this._objects[i].group=this;options.originX&&(this.originX=options.originX),options.originY&&(this.originY=options.originY),this._calcBounds(),this._updateObjectsCoords(),fabric.Object.prototype.initialize.call(this,options),this.setCoords()},toGroup:function(){var objects=this._objects.concat();this._objects=[];var options=fabric.Object.prototype.toObject.call(this),newGroup=new fabric.Group([]);if(delete options.type,newGroup.set(options),objects.forEach(function(object){object.canvas.remove(object),object.group=newGroup}),newGroup._objects=objects,!this.canvas)return newGroup;var canvas=this.canvas;return canvas.add(newGroup),canvas._activeObject=newGroup,newGroup.setCoords(),newGroup},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(ctx,styleOverride,childrenOverride){ctx.save(),ctx.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",ctx,styleOverride),void 0===(childrenOverride=childrenOverride||{}).hasControls&&(childrenOverride.hasControls=!1),void 0===childrenOverride.hasRotatingPoint&&(childrenOverride.hasRotatingPoint=!1),childrenOverride.forActiveSelection=!0;for(var i=0,len=this._objects.length;i<len;i++)this._objects[i]._renderControls(ctx,childrenOverride);ctx.restore()}}),fabric.ActiveSelection.fromObject=function(object,callback){fabric.util.enlivenObjects(object.objects,function(enlivenedObjects){delete object.objects,callback&&callback(new fabric.ActiveSelection(enlivenedObjects,object,!0))})})}("undefined"!=typeof exports?exports:this),function(global){"use strict";var extend=fabric.util.object.extend;global.fabric||(global.fabric={}),global.fabric.Image?fabric.warn("fabric.Image is already defined."):(fabric.Image=fabric.util.createClass(fabric.Object,{type:"image",crossOrigin:"",strokeWidth:0,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:fabric.Object.prototype.stateProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,initialize:function(element,options){options||(options={}),this.filters=[],this.cacheKey="texture"+fabric.Object.__uid++,this.callSuper("initialize",options),this._initElement(element,options)},getElement:function(){return this._element||{}},setElement:function(element,options){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=element,this._originalElement=element,this._initConfig(options),this.resizeFilter&&this.applyResizeFilters(),0!==this.filters.length&&this.applyFilters(),this},removeTexture:function(key){var backend=fabric.filterBackend;backend&&backend.evictCachesForKey&&backend.evictCachesForKey(key)},dispose:function(){this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(element){fabric.util.cleanUpJsdomNode(this[element]),this[element]=void 0}.bind(this))},setCrossOrigin:function(value){return this.crossOrigin=value,this._element.crossOrigin=value,this},getOriginalSize:function(){var element=this.getElement();return{width:element.naturalWidth||element.width,height:element.naturalHeight||element.height}},_stroke:function(ctx){if(this.stroke&&0!==this.strokeWidth){var w=this.width/2,h=this.height/2;ctx.beginPath(),ctx.moveTo(-w,-h),ctx.lineTo(w,-h),ctx.lineTo(w,h),ctx.lineTo(-w,h),ctx.lineTo(-w,-h),ctx.closePath()}},_renderDashedStroke:function(ctx){var x=-this.width/2,y=-this.height/2,w=this.width,h=this.height;ctx.save(),this._setStrokeStyles(ctx,this),ctx.beginPath(),fabric.util.drawDashedLine(ctx,x,y,x+w,y,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x+w,y,x+w,y+h,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x+w,y+h,x,y+h,this.strokeDashArray),fabric.util.drawDashedLine(ctx,x,y+h,x,y,this.strokeDashArray),ctx.closePath(),ctx.restore()},toObject:function(propertiesToInclude){var filters=[];this.filters.forEach(function(filterObj){filterObj&&filters.push(filterObj.toObject())});var object=extend(this.callSuper("toObject",["crossOrigin","cropX","cropY"].concat(propertiesToInclude)),{src:this.getSrc(),filters:filters});return this.resizeFilter&&(object.resizeFilter=this.resizeFilter.toObject()),object},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),x=-this.width/2,y=-this.height/2,clipPath="";if(this.hasCrop()){var clipPathId=fabric.Object.__uid++;markup.push('<clipPath id="imageCrop_'+clipPathId+'">\n','\t<rect x="'+x+'" y="'+y+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),clipPath=' clip-path="url(#imageCrop_'+clipPathId+')" '}markup.push('<g transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'">\n');var imageMarkup=["\t<image ",this.getSvgCommons(),'xlink:href="',this.getSvgSrc(!0),'" x="',x-this.cropX,'" y="',y-this.cropY,'" style="',this.getSvgStyles(),'" width="',this._element.width||this._element.naturalWidth,'" height="',this._element.height||this._element.height,'"',clipPath,"></image>\n"];if("fill"===this.paintFirst&&Array.prototype.push.apply(markup,imageMarkup),this.stroke||this.strokeDashArray){var origFill=this.fill;this.fill=null,markup.push("\t<rect ",'x="',x,'" y="',y,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'),this.fill=origFill}return"fill"!==this.paintFirst&&Array.prototype.push.apply(markup,imageMarkup),markup.push("</g>\n"),reviver?reviver(markup.join("")):markup.join("")},getSrc:function(filtered){var element=filtered?this._element:this._originalElement;return element?element.toDataURL?element.toDataURL():element.src:this.src||""},setSrc:function(src,callback,options){return fabric.util.loadImage(src,function(img){this.setElement(img,options),this._setWidthHeight(),callback(this)},this,options&&options.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var filter=this.resizeFilter,minimumScale=this.minimumScaleTrigger,objectScale=this.getTotalObjectScaling(),scaleX=objectScale.scaleX,scaleY=objectScale.scaleY,elementToFilter=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!filter||scaleX>minimumScale&&scaleY>minimumScale)return this._element=elementToFilter,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=scaleX,void(this._lastScaleY=scaleY);fabric.filterBackend||(fabric.filterBackend=fabric.initFilterBackend());var canvasEl=fabric.util.createCanvasElement(),cacheKey=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,sourceWidth=elementToFilter.width,sourceHeight=elementToFilter.height;canvasEl.width=sourceWidth,canvasEl.height=sourceHeight,this._element=canvasEl,this._lastScaleX=filter.scaleX=scaleX,this._lastScaleY=filter.scaleY=scaleY,fabric.filterBackend.applyFilters([filter],elementToFilter,sourceWidth,sourceHeight,this._element,cacheKey),this._filterScalingX=canvasEl.width/this._originalElement.width,this._filterScalingY=canvasEl.height/this._originalElement.height},applyFilters:function(filters){if(filters=(filters=filters||this.filters||[]).filter(function(filter){return filter&&!filter.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===filters.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var imgElement=this._originalElement,sourceWidth=imgElement.naturalWidth||imgElement.width,sourceHeight=imgElement.naturalHeight||imgElement.height;if(this._element===this._originalElement){var canvasEl=fabric.util.createCanvasElement();canvasEl.width=sourceWidth,canvasEl.height=sourceHeight,this._element=canvasEl,this._filteredEl=canvasEl}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,sourceWidth,sourceHeight),this._lastScaleX=1,this._lastScaleY=1;return fabric.filterBackend||(fabric.filterBackend=fabric.initFilterBackend()),fabric.filterBackend.applyFilters(filters,this._originalElement,sourceWidth,sourceHeight,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(ctx){!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(ctx),this._renderPaintInOrder(ctx)},_renderFill:function(ctx){var w=this.width,h=this.height,sW=w*this._filterScalingX,sH=h*this._filterScalingY,x=-w/2,y=-h/2,elementToDraw=this._element;elementToDraw&&ctx.drawImage(elementToDraw,this.cropX*this._filterScalingX,this.cropY*this._filterScalingY,sW,sH,x,y,w,h)},_needsResize:function(){var scale=this.getTotalObjectScaling();return scale.scaleX!==this._lastScaleX||scale.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(element,options){this.setElement(fabric.util.getById(element),options),fabric.util.addClass(this.getElement(),fabric.Image.CSS_CANVAS)},_initConfig:function(options){options||(options={}),this.setOptions(options),this._setWidthHeight(options),this._element&&this.crossOrigin&&(this._element.crossOrigin=this.crossOrigin)},_initFilters:function(filters,callback){filters&&filters.length?fabric.util.enlivenObjects(filters,function(enlivenedObjects){callback&&callback(enlivenedObjects)},"fabric.Image.filters"):callback&&callback()},_setWidthHeight:function(options){options||(options={});var el=this.getElement();this.width=options.width||el.naturalWidth||el.width||0,this.height=options.height||el.naturalHeight||el.height||0},parsePreserveAspectRatioAttribute:function(){var pAR=fabric.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),rWidth=this._element.width,rHeight=this._element.height,scaleX=1,scaleY=1,offsetLeft=0,offsetTop=0,cropX=0,cropY=0,offset,pWidth=this.width,pHeight=this.height,parsedAttributes={width:pWidth,height:pHeight};return!pAR||"none"===pAR.alignX&&"none"===pAR.alignY?(scaleX=pWidth/rWidth,scaleY=pHeight/rHeight):("meet"===pAR.meetOrSlice&&(offset=(pWidth-rWidth*(scaleX=scaleY=fabric.util.findScaleToFit(this._element,parsedAttributes)))/2,"Min"===pAR.alignX&&(offsetLeft=-offset),"Max"===pAR.alignX&&(offsetLeft=offset),offset=(pHeight-rHeight*scaleY)/2,"Min"===pAR.alignY&&(offsetTop=-offset),"Max"===pAR.alignY&&(offsetTop=offset)),"slice"===pAR.meetOrSlice&&(offset=rWidth-pWidth/(scaleX=scaleY=fabric.util.findScaleToCover(this._element,parsedAttributes)),"Mid"===pAR.alignX&&(cropX=offset/2),"Max"===pAR.alignX&&(cropX=offset),offset=rHeight-pHeight/scaleY,"Mid"===pAR.alignY&&(cropY=offset/2),"Max"===pAR.alignY&&(cropY=offset),rWidth=pWidth/scaleX,rHeight=pHeight/scaleY)),{width:rWidth,height:rHeight,scaleX:scaleX,scaleY:scaleY,offsetLeft:offsetLeft,offsetTop:offsetTop,cropX:cropX,cropY:cropY}}}),fabric.Image.CSS_CANVAS="canvas-img",fabric.Image.prototype.getSvgSrc=fabric.Image.prototype.getSrc,fabric.Image.fromObject=function(_object,callback){var object=fabric.util.object.clone(_object);fabric.util.loadImage(object.src,function(img,error){error?callback&&callback(null,error):fabric.Image.prototype._initFilters.call(object,object.filters,function(filters){object.filters=filters||[],fabric.Image.prototype._initFilters.call(object,[object.resizeFilter],function(resizeFilters){object.resizeFilter=resizeFilters[0];var image=new fabric.Image(img,object);callback(image)})})},null,object.crossOrigin)},fabric.Image.fromURL=function(url,callback,imgOptions){fabric.util.loadImage(url,function(img){callback&&callback(new fabric.Image(img,imgOptions))},null,imgOptions&&imgOptions.crossOrigin)},fabric.Image.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin".split(" ")),fabric.Image.fromElement=function(element,callback,options){var parsedAttributes=fabric.parseAttributes(element,fabric.Image.ATTRIBUTE_NAMES);fabric.Image.fromURL(parsedAttributes["xlink:href"],callback,extend(options?fabric.util.object.clone(options):{},parsedAttributes))})}("undefined"!=typeof exports?exports:this),fabric.util.object.extend(fabric.Object.prototype,{_getAngleValueForStraighten:function(){var angle=this.angle%360;return angle>0?90*Math.round((angle-1)/90):90*Math.round(angle/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten()),this},fxStraighten:function(callbacks){var empty=function(){},onComplete=(callbacks=callbacks||{}).onComplete||empty,onChange=callbacks.onChange||empty,_this=this;return fabric.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(value){_this.rotate(value),onChange()},onComplete:function(){_this.setCoords(),onComplete()}}),this}}),fabric.util.object.extend(fabric.StaticCanvas.prototype,{straightenObject:function(object){return object.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(object){return object.fxStraighten({onChange:this.requestRenderAllBound}),this}}),function(){"use strict";function testPrecision(gl,precision){var fragmentSource="precision "+precision+" float;\nvoid main(){}",fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);return gl.shaderSource(fragmentShader,fragmentSource),gl.compileShader(fragmentShader),!!gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS)}function WebglFilterBackend(options){options&&options.tileSize&&(this.tileSize=options.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}fabric.isWebglSupported=function(tileSize){if(fabric.isLikelyNode)return!1;tileSize=tileSize||fabric.WebglFilterBackend.prototype.tileSize;var canvas=document.createElement("canvas"),gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl"),isSupported=!1;if(gl){fabric.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),isSupported=fabric.maxTextureSize>=tileSize;for(var precisions=["highp","mediump","lowp"],i=0;i<3;i++)if(testPrecision(gl,precisions[i])){fabric.webGlPrecision=precisions[i];break}}return this.isSupported=isSupported,isSupported},fabric.WebglFilterBackend=WebglFilterBackend,WebglFilterBackend.prototype={tileSize:2048,resources:{},setupGLContext:function(width,height){this.dispose(),this.createWebGLCanvas(width,height),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(width,height)},chooseFastestCopyGLTo2DMethod:function(width,height){var canMeasurePerf=void 0!==window.performance,canUseImageData;try{new ImageData(1,1),canUseImageData=!0}catch(e){canUseImageData=!1}var canUseArrayBuffer="undefined"!=typeof ArrayBuffer,canUseUint8Clamped="undefined"!=typeof Uint8ClampedArray;if(canMeasurePerf&&canUseImageData&&canUseArrayBuffer&&canUseUint8Clamped){var targetCanvas=fabric.util.createCanvasElement(),imageBuffer=new ArrayBuffer(width*height*4),testContext={imageBuffer:imageBuffer,destinationWidth:width,destinationHeight:height,targetCanvas:targetCanvas},startTime,drawImageTime,putImageDataTime;targetCanvas.width=width,targetCanvas.height=height,startTime=window.performance.now(),copyGLTo2DDrawImage.call(testContext,this.gl,testContext),drawImageTime=window.performance.now()-startTime,startTime=window.performance.now(),copyGLTo2DPutImageData.call(testContext,this.gl,testContext),drawImageTime>(putImageDataTime=window.performance.now()-startTime)?(this.imageBuffer=imageBuffer,this.copyGLTo2D=copyGLTo2DPutImageData):this.copyGLTo2D=copyGLTo2DDrawImage}},createWebGLCanvas:function(width,height){var canvas=fabric.util.createCanvasElement();canvas.width=width,canvas.height=height;var glOptions={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},gl=canvas.getContext("webgl",glOptions);gl||(gl=canvas.getContext("experimental-webgl",glOptions)),gl&&(gl.clearColor(0,0,0,0),this.canvas=canvas,this.gl=gl)},applyFilters:function(filters,source,width,height,targetCanvas,cacheKey){var gl=this.gl,cachedTexture;cacheKey&&(cachedTexture=this.getCachedTexture(cacheKey,source));var pipelineState={originalWidth:source.width||source.originalWidth,originalHeight:source.height||source.originalHeight,sourceWidth:width,sourceHeight:height,destinationWidth:width,destinationHeight:height,context:gl,sourceTexture:this.createTexture(gl,width,height,!cachedTexture&&source),targetTexture:this.createTexture(gl,width,height),originalTexture:cachedTexture||this.createTexture(gl,width,height,!cachedTexture&&source),passes:filters.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:targetCanvas},tempFbo=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,tempFbo),filters.forEach(function(filter){filter&&filter.applyTo(pipelineState)}),resizeCanvasIfNeeded(pipelineState),this.copyGLTo2D(gl,pipelineState),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(pipelineState.sourceTexture),gl.deleteTexture(pipelineState.targetTexture),gl.deleteFramebuffer(tempFbo),targetCanvas.getContext("2d").setTransform(1,0,0,1,0,0),pipelineState},applyFiltersDebug:function(filters,source,width,height,targetCanvas,cacheKey){var gl=this.gl,ret=this.applyFilters(filters,source,width,height,targetCanvas,cacheKey),glError=gl.getError();if(glError!==gl.NO_ERROR){var errorString=this.glErrorToString(gl,glError),error=new Error("WebGL Error "+errorString);throw error.glErrorCode=glError,error}return ret},glErrorToString:function(context,errorCode){if(!context)return"Context undefined for error code: "+errorCode;if("number"!=typeof errorCode)return"Error code is not a number";switch(errorCode){case context.NO_ERROR:return"NO_ERROR";case context.INVALID_ENUM:return"INVALID_ENUM";case context.INVALID_VALUE:return"INVALID_VALUE";case context.INVALID_OPERATION:return"INVALID_OPERATION";case context.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case context.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case context.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"UNKNOWN_ERROR"}},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(gl,width,height,textureImageSource){var texture=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),textureImageSource?gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,textureImageSource):gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),texture},getCachedTexture:function(uniqueId,textureImageSource){if(this.textureCache[uniqueId])return this.textureCache[uniqueId];var texture=this.createTexture(this.gl,textureImageSource.width,textureImageSource.height,textureImageSource);return this.textureCache[uniqueId]=texture,texture},evictCachesForKey:function(cacheKey){this.textureCache[cacheKey]&&(this.gl.deleteTexture(this.textureCache[cacheKey]),delete this.textureCache[cacheKey])},copyGLTo2D:copyGLTo2DDrawImage,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var gl=this.gl,ext=gl.getExtension("WEBGL_debug_renderer_info"),gpuInfo={renderer:"",vendor:""};if(ext){var renderer=gl.getParameter(ext.UNMASKED_RENDERER_WEBGL),vendor=gl.getParameter(ext.UNMASKED_VENDOR_WEBGL);renderer&&(gpuInfo.renderer=renderer.toLowerCase()),vendor&&(gpuInfo.vendor=vendor.toLowerCase())}return this.gpuInfo=gpuInfo,gpuInfo}}}(),function(){"use strict";var noop=function(){};function Canvas2dFilterBackend(){}fabric.Canvas2dFilterBackend=Canvas2dFilterBackend,Canvas2dFilterBackend.prototype={evictCachesForKey:noop,dispose:noop,clearWebGLCaches:noop,resources:{},applyFilters:function(filters,sourceElement,sourceWidth,sourceHeight,targetCanvas){var ctx=targetCanvas.getContext("2d");ctx.drawImage(sourceElement,0,0,sourceWidth,sourceHeight);var imageData,originalImageData,pipelineState={sourceWidth:sourceWidth,sourceHeight:sourceHeight,imageData:ctx.getImageData(0,0,sourceWidth,sourceHeight),originalEl:sourceElement,originalImageData:ctx.getImageData(0,0,sourceWidth,sourceHeight),canvasEl:targetCanvas,ctx:ctx,filterBackend:this};return filters.forEach(function(filter){filter.applyTo(pipelineState)}),pipelineState.imageData.width===sourceWidth&&pipelineState.imageData.height===sourceHeight||(targetCanvas.width=pipelineState.imageData.width,targetCanvas.height=pipelineState.imageData.height),ctx.putImageData(pipelineState.imageData,0,0),pipelineState}}}(),fabric.Image=fabric.Image||{},fabric.Image.filters=fabric.Image.filters||{},fabric.Image.filters.BaseFilter=fabric.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(options){options&&this.setOptions(options)},setOptions:function(options){for(var prop in options)this[prop]=options[prop]},createProgram:function(gl,fragmentSource,vertexSource){fragmentSource=fragmentSource||this.fragmentSource,vertexSource=vertexSource||this.vertexSource,"highp"!==fabric.webGlPrecision&&(fragmentSource=fragmentSource.replace(/precision highp float/g,"precision "+fabric.webGlPrecision+" float"));var vertexShader=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(vertexShader,vertexSource),gl.compileShader(vertexShader),!gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+gl.getShaderInfoLog(vertexShader));var fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(fragmentShader,fragmentSource),gl.compileShader(fragmentShader),!gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+gl.getShaderInfoLog(fragmentShader));var program=gl.createProgram();if(gl.attachShader(program,vertexShader),gl.attachShader(program,fragmentShader),gl.linkProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+gl.getProgramInfoLog(program));var attributeLocations=this.getAttributeLocations(gl,program),uniformLocations=this.getUniformLocations(gl,program)||{};return uniformLocations.uStepW=gl.getUniformLocation(program,"uStepW"),uniformLocations.uStepH=gl.getUniformLocation(program,"uStepH"),{program:program,attributeLocations:attributeLocations,uniformLocations:uniformLocations}},getAttributeLocations:function(gl,program){return{aPosition:gl.getAttribLocation(program,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(gl,attributeLocations,aPositionData){var attributeLocation=attributeLocations.aPosition,buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.enableVertexAttribArray(attributeLocation),gl.vertexAttribPointer(attributeLocation,2,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,aPositionData,gl.STATIC_DRAW)},_setupFrameBuffer:function(options){var gl=options.context,width,height;options.passes>1?(width=options.destinationWidth,height=options.destinationHeight,options.sourceWidth===width&&options.sourceHeight===height||(gl.deleteTexture(options.targetTexture),options.targetTexture=options.filterBackend.createTexture(gl,width,height)),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,options.targetTexture,0)):(gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.finish())},_swapTextures:function(options){options.passes--,options.pass++;var temp=options.targetTexture;options.targetTexture=options.sourceTexture,options.sourceTexture=temp},isNeutralState:function(){var main=this.mainParameter,_class=fabric.Image.filters[this.type].prototype;if(main){if(Array.isArray(_class[main])){for(var i=_class[main].length;i--;)if(this[main][i]!==_class[main][i])return!1;return!0}return _class[main]===this[main]}return!1},applyTo:function(options){options.webgl?(this._setupFrameBuffer(options),this.applyToWebGL(options),this._swapTextures(options)):this.applyTo2d(options)},retrieveShader:function(options){return options.programCache.hasOwnProperty(this.type)||(options.programCache[this.type]=this.createProgram(options.context)),options.programCache[this.type]},applyToWebGL:function(options){var gl=options.context,shader=this.retrieveShader(options);0===options.pass&&options.originalTexture?gl.bindTexture(gl.TEXTURE_2D,options.originalTexture):gl.bindTexture(gl.TEXTURE_2D,options.sourceTexture),gl.useProgram(shader.program),this.sendAttributeData(gl,shader.attributeLocations,options.aPosition),gl.uniform1f(shader.uniformLocations.uStepW,1/options.sourceWidth),gl.uniform1f(shader.uniformLocations.uStepH,1/options.sourceHeight),this.sendUniformData(gl,shader.uniformLocations),gl.viewport(0,0,options.destinationWidth,options.destinationHeight),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(gl,texture,textureUnit){gl.activeTexture(textureUnit),gl.bindTexture(gl.TEXTURE_2D,texture),gl.activeTexture(gl.TEXTURE0)},unbindAdditionalTexture:function(gl,textureUnit){gl.activeTexture(textureUnit),gl.bindTexture(gl.TEXTURE_2D,null),gl.activeTexture(gl.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(value){this[this.mainParameter]=value},sendUniformData:function(){},createHelpLayer:function(options){if(!options.helpLayer){var helpLayer=document.createElement("canvas");helpLayer.width=options.sourceWidth,helpLayer.height=options.sourceHeight,options.helpLayer=helpLayer}},toObject:function(){var object={type:this.type},mainP=this.mainParameter;return mainP&&(object[mainP]=this[mainP]),object},toJSON:function(){return this.toObject()}}),fabric.Image.filters.BaseFilter.fromObject=function(object,callback){var filter=new fabric.Image.filters[object.type](object);return callback&&callback(filter),filter},function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.ColorMatrix=createClass(filters.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(options){this.callSuper("initialize",options),this.matrix=this.matrix.slice(0)},applyTo2d:function(options){var imageData,data=options.imageData.data,iLen=data.length,m=this.matrix,r,g,b,a,i,colorsOnly=this.colorsOnly;for(i=0;i<iLen;i+=4)r=data[i],g=data[i+1],b=data[i+2],colorsOnly?(data[i]=r*m[0]+g*m[1]+b*m[2]+255*m[4],data[i+1]=r*m[5]+g*m[6]+b*m[7]+255*m[9],data[i+2]=r*m[10]+g*m[11]+b*m[12]+255*m[14]):(a=data[i+3],data[i]=r*m[0]+g*m[1]+b*m[2]+a*m[3]+255*m[4],data[i+1]=r*m[5]+g*m[6]+b*m[7]+a*m[8]+255*m[9],data[i+2]=r*m[10]+g*m[11]+b*m[12]+a*m[13]+255*m[14],data[i+3]=r*m[15]+g*m[16]+b*m[17]+a*m[18]+255*m[19])},getUniformLocations:function(gl,program){return{uColorMatrix:gl.getUniformLocation(program,"uColorMatrix"),uConstants:gl.getUniformLocation(program,"uConstants")}},sendUniformData:function(gl,uniformLocations){var m=this.matrix,matrix=[m[0],m[1],m[2],m[3],m[5],m[6],m[7],m[8],m[10],m[11],m[12],m[13],m[15],m[16],m[17],m[18]],constants=[m[4],m[9],m[14],m[19]];gl.uniformMatrix4fv(uniformLocations.uColorMatrix,!1,matrix),gl.uniform4fv(uniformLocations.uConstants,constants)}}),fabric.Image.filters.ColorMatrix.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Brightness=createClass(filters.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(options){if(0!==this.brightness){var imageData,data=options.imageData.data,i,len=data.length,brightness=Math.round(255*this.brightness);for(i=0;i<len;i+=4)data[i]=data[i]+brightness,data[i+1]=data[i+1]+brightness,data[i+2]=data[i+2]+brightness}},getUniformLocations:function(gl,program){return{uBrightness:gl.getUniformLocation(program,"uBrightness")}},sendUniformData:function(gl,uniformLocations){gl.uniform1f(uniformLocations.uBrightness,this.brightness)}}),fabric.Image.filters.Brightness.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Convolute=createClass(filters.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(options){var size=Math.sqrt(this.matrix.length),cacheKey=this.type+"_"+size+"_"+(this.opaque?1:0),shaderSource=this.fragmentSource[cacheKey];return options.programCache.hasOwnProperty(cacheKey)||(options.programCache[cacheKey]=this.createProgram(options.context,shaderSource)),options.programCache[cacheKey]},applyTo2d:function(options){var imageData=options.imageData,data=imageData.data,weights=this.matrix,side=Math.round(Math.sqrt(weights.length)),halfSide=Math.floor(side/2),sw=imageData.width,sh=imageData.height,output=options.ctx.createImageData(sw,sh),dst=output.data,alphaFac=this.opaque?1:0,r,g,b,a,dstOff,scx,scy,srcOff,wt,x,y,cx,cy;for(y=0;y<sh;y++)for(x=0;x<sw;x++){for(dstOff=4*(y*sw+x),r=0,g=0,b=0,a=0,cy=0;cy<side;cy++)for(cx=0;cx<side;cx++)scx=x+cx-halfSide,(scy=y+cy-halfSide)<0||scy>sh||scx<0||scx>sw||(srcOff=4*(scy*sw+scx),wt=weights[cy*side+cx],r+=data[srcOff]*wt,g+=data[srcOff+1]*wt,b+=data[srcOff+2]*wt,alphaFac||(a+=data[srcOff+3]*wt));dst[dstOff]=r,dst[dstOff+1]=g,dst[dstOff+2]=b,dst[dstOff+3]=alphaFac?data[dstOff+3]:a}options.imageData=output},getUniformLocations:function(gl,program){return{uMatrix:gl.getUniformLocation(program,"uMatrix"),uOpaque:gl.getUniformLocation(program,"uOpaque"),uHalfSize:gl.getUniformLocation(program,"uHalfSize"),uSize:gl.getUniformLocation(program,"uSize")}},sendUniformData:function(gl,uniformLocations){gl.uniform1fv(uniformLocations.uMatrix,this.matrix)},toObject:function(){return extend(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),fabric.Image.filters.Convolute.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Grayscale=createClass(filters.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(options){var imageData,data=options.imageData.data,i,len=data.length,value,mode=this.mode;for(i=0;i<len;i+=4)"average"===mode?value=(data[i]+data[i+1]+data[i+2])/3:"lightness"===mode?value=(Math.min(data[i],data[i+1],data[i+2])+Math.max(data[i],data[i+1],data[i+2]))/2:"luminosity"===mode&&(value=.21*data[i]+.72*data[i+1]+.07*data[i+2]),data[i]=value,data[i+1]=value,data[i+2]=value},retrieveShader:function(options){var cacheKey=this.type+"_"+this.mode;if(!options.programCache.hasOwnProperty(cacheKey)){var shaderSource=this.fragmentSource[this.mode];options.programCache[cacheKey]=this.createProgram(options.context,shaderSource)}return options.programCache[cacheKey]},getUniformLocations:function(gl,program){return{uMode:gl.getUniformLocation(program,"uMode")}},sendUniformData:function(gl,uniformLocations){var mode=1;gl.uniform1i(uniformLocations.uMode,1)},isNeutralState:function(){return!1}}),fabric.Image.filters.Grayscale.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Invert=createClass(filters.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(options){var imageData,data=options.imageData.data,i,len=data.length;for(i=0;i<len;i+=4)data[i]=255-data[i],data[i+1]=255-data[i+1],data[i+2]=255-data[i+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(gl,program){return{uInvert:gl.getUniformLocation(program,"uInvert")}},sendUniformData:function(gl,uniformLocations){gl.uniform1i(uniformLocations.uInvert,this.invert)}}),fabric.Image.filters.Invert.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Noise=createClass(filters.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(options){if(0!==this.noise){var imageData,data=options.imageData.data,i,len=data.length,noise=this.noise,rand;for(i=0,len=data.length;i<len;i+=4)rand=(.5-Math.random())*noise,data[i]+=rand,data[i+1]+=rand,data[i+2]+=rand}},getUniformLocations:function(gl,program){return{uNoise:gl.getUniformLocation(program,"uNoise"),uSeed:gl.getUniformLocation(program,"uSeed")}},sendUniformData:function(gl,uniformLocations){gl.uniform1f(uniformLocations.uNoise,this.noise/255),gl.uniform1f(uniformLocations.uSeed,Math.random())},toObject:function(){return extend(this.callSuper("toObject"),{noise:this.noise})}}),fabric.Image.filters.Noise.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Pixelate=createClass(filters.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(options){var imageData=options.imageData,data=imageData.data,iLen=imageData.height,jLen=imageData.width,index,i,j,r,g,b,a,_i,_j,_iLen,_jLen;for(i=0;i<iLen;i+=this.blocksize)for(j=0;j<jLen;j+=this.blocksize)for(r=data[index=4*i*jLen+4*j],g=data[index+1],b=data[index+2],a=data[index+3],_iLen=Math.min(i+this.blocksize,iLen),_jLen=Math.min(j+this.blocksize,jLen),_i=i;_i<_iLen;_i++)for(_j=j;_j<_jLen;_j++)data[index=4*_i*jLen+4*_j]=r,data[index+1]=g,data[index+2]=b,data[index+3]=a},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(gl,program){return{uBlocksize:gl.getUniformLocation(program,"uBlocksize"),uStepW:gl.getUniformLocation(program,"uStepW"),uStepH:gl.getUniformLocation(program,"uStepH")}},sendUniformData:function(gl,uniformLocations){gl.uniform1f(uniformLocations.uBlocksize,this.blocksize)}}),fabric.Image.filters.Pixelate.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extend=fabric.util.object.extend,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.RemoveColor=createClass(filters.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(options){var imageData,data=options.imageData.data,i,distance=255*this.distance,r,g,b,source=new fabric.Color(this.color).getSource(),lowC=[source[0]-distance,source[1]-distance,source[2]-distance],highC=[source[0]+distance,source[1]+distance,source[2]+distance];for(i=0;i<data.length;i+=4)r=data[i],g=data[i+1],b=data[i+2],r>lowC[0]&&g>lowC[1]&&b>lowC[2]&&r<highC[0]&&g<highC[1]&&b<highC[2]&&(data[i+3]=0)},getUniformLocations:function(gl,program){return{uLow:gl.getUniformLocation(program,"uLow"),uHigh:gl.getUniformLocation(program,"uHigh")}},sendUniformData:function(gl,uniformLocations){var source=new fabric.Color(this.color).getSource(),distance=parseFloat(this.distance),lowC=[0+source[0]/255-distance,0+source[1]/255-distance,0+source[2]/255-distance,1],highC=[source[0]/255+distance,source[1]/255+distance,source[2]/255+distance,1];gl.uniform4fv(uniformLocations.uLow,lowC),gl.uniform4fv(uniformLocations.uHigh,highC)},toObject:function(){return extend(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),fabric.Image.filters.RemoveColor.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass,matrices={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var key in matrices)filters[key]=createClass(filters.ColorMatrix,{type:key,matrix:matrices[key],mainParameter:!1,colorsOnly:!0}),fabric.Image.filters[key].fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.BlendColor=createClass(filters.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(mode){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[mode]+"}\n}"},retrieveShader:function(options){var cacheKey=this.type+"_"+this.mode,shaderSource;return options.programCache.hasOwnProperty(cacheKey)||(shaderSource=this.buildSource(this.mode),options.programCache[cacheKey]=this.createProgram(options.context,shaderSource)),options.programCache[cacheKey]},applyTo2d:function(options){var imageData,data=options.imageData.data,iLen=data.length,tr,tg,tb,r,g,b,source,alpha1=1-this.alpha;tr=(source=new fabric.Color(this.color).getSource())[0]*this.alpha,tg=source[1]*this.alpha,tb=source[2]*this.alpha;for(var i=0;i<iLen;i+=4)switch(r=data[i],g=data[i+1],b=data[i+2],this.mode){case"multiply":data[i]=r*tr/255,data[i+1]=g*tg/255,data[i+2]=b*tb/255;break;case"screen":data[i]=255-(255-r)*(255-tr)/255,data[i+1]=255-(255-g)*(255-tg)/255,data[i+2]=255-(255-b)*(255-tb)/255;break;case"add":data[i]=r+tr,data[i+1]=g+tg,data[i+2]=b+tb;break;case"diff":case"difference":data[i]=Math.abs(r-tr),data[i+1]=Math.abs(g-tg),data[i+2]=Math.abs(b-tb);break;case"subtract":data[i]=r-tr,data[i+1]=g-tg,data[i+2]=b-tb;break;case"darken":data[i]=Math.min(r,tr),data[i+1]=Math.min(g,tg),data[i+2]=Math.min(b,tb);break;case"lighten":data[i]=Math.max(r,tr),data[i+1]=Math.max(g,tg),data[i+2]=Math.max(b,tb);break;case"overlay":data[i]=tr<128?2*r*tr/255:255-2*(255-r)*(255-tr)/255,data[i+1]=tg<128?2*g*tg/255:255-2*(255-g)*(255-tg)/255,data[i+2]=tb<128?2*b*tb/255:255-2*(255-b)*(255-tb)/255;break;case"exclusion":data[i]=tr+r-2*tr*r/255,data[i+1]=tg+g-2*tg*g/255,data[i+2]=tb+b-2*tb*b/255;break;case"tint":data[i]=tr+r*alpha1,data[i+1]=tg+g*alpha1,data[i+2]=tb+b*alpha1}},getUniformLocations:function(gl,program){return{uColor:gl.getUniformLocation(program,"uColor")}},sendUniformData:function(gl,uniformLocations){var source=new fabric.Color(this.color).getSource();source[0]=this.alpha*source[0]/255,source[1]=this.alpha*source[1]/255,source[2]=this.alpha*source[2]/255,source[3]=this.alpha,gl.uniform4fv(uniformLocations.uColor,source)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),fabric.Image.filters.BlendColor.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.BlendImage=createClass(filters.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(options){var cacheKey=this.type+"_"+this.mode,shaderSource=this.fragmentSource[this.mode];return options.programCache.hasOwnProperty(cacheKey)||(options.programCache[cacheKey]=this.createProgram(options.context,shaderSource)),options.programCache[cacheKey]},applyToWebGL:function(options){var gl=options.context,texture=this.createTexture(options.filterBackend,this.image);this.bindAdditionalTexture(gl,texture,gl.TEXTURE1),this.callSuper("applyToWebGL",options),this.unbindAdditionalTexture(gl,gl.TEXTURE1)},createTexture:function(backend,image){return backend.getCachedTexture(image.cacheKey,image._element)},calculateMatrix:function(){var image=this.image,width=image._element.width,height=image._element.height;return[1/image.scaleX,0,0,0,1/image.scaleY,0,-image.left/width,-image.top/height,1]},applyTo2d:function(options){var imageData=options.imageData,resources=options.filterBackend.resources,data=imageData.data,iLen=data.length,width=imageData.width,height=imageData.height,tr,tg,tb,ta,r,g,b,a,canvas1,context,image=this.image,blendData;resources.blendImage||(resources.blendImage=fabric.util.createCanvasElement()),context=(canvas1=resources.blendImage).getContext("2d"),canvas1.width!==width||canvas1.height!==height?(canvas1.width=width,canvas1.height=height):context.clearRect(0,0,width,height),context.setTransform(image.scaleX,0,0,image.scaleY,image.left,image.top),context.drawImage(image._element,0,0,width,height),blendData=context.getImageData(0,0,width,height).data;for(var i=0;i<iLen;i+=4)switch(r=data[i],g=data[i+1],b=data[i+2],a=data[i+3],tr=blendData[i],tg=blendData[i+1],tb=blendData[i+2],ta=blendData[i+3],this.mode){case"multiply":data[i]=r*tr/255,data[i+1]=g*tg/255,data[i+2]=b*tb/255,data[i+3]=a*ta/255;break;case"mask":data[i+3]=ta}},getUniformLocations:function(gl,program){return{uTransformMatrix:gl.getUniformLocation(program,"uTransformMatrix"),uImage:gl.getUniformLocation(program,"uImage")}},sendUniformData:function(gl,uniformLocations){var matrix=this.calculateMatrix();gl.uniform1i(uniformLocations.uImage,1),gl.uniformMatrix3fv(uniformLocations.uTransformMatrix,!1,matrix)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),fabric.Image.filters.BlendImage.fromObject=function(object,callback){fabric.Image.fromObject(object.image,function(image){var options=fabric.util.object.clone(object);options.image=image,callback(new fabric.Image.filters.BlendImage(options))})}}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),pow=Math.pow,floor=Math.floor,sqrt=Math.sqrt,abs=Math.abs,round=Math.round,sin=Math.sin,ceil=Math.ceil,filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Resize=createClass(filters.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(gl,program){return{uDelta:gl.getUniformLocation(program,"uDelta"),uTaps:gl.getUniformLocation(program,"uTaps")}},sendUniformData:function(gl,uniformLocations){gl.uniform2fv(uniformLocations.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),gl.uniform1fv(uniformLocations.uTaps,this.taps)},retrieveShader:function(options){var filterWindow=this.getFilterWindow(),cacheKey=this.type+"_"+filterWindow;if(!options.programCache.hasOwnProperty(cacheKey)){var fragmentShader=this.generateShader(filterWindow);options.programCache[cacheKey]=this.createProgram(options.context,fragmentShader)}return options.programCache[cacheKey]},getFilterWindow:function(){var scale=this.tempScale;return Math.ceil(this.lanczosLobes/scale)},getTaps:function(){for(var lobeFunction=this.lanczosCreate(this.lanczosLobes),scale=this.tempScale,filterWindow=this.getFilterWindow(),taps=new Array(filterWindow),i=1;i<=filterWindow;i++)taps[i-1]=lobeFunction(i*scale);return taps},generateShader:function(filterWindow){for(var offsets=new Array(filterWindow),fragmentShader=this.fragmentSourceTOP,filterWindow,i=1;i<=filterWindow;i++)offsets[i-1]=i+".0 * uDelta";return fragmentShader+="uniform float uTaps["+filterWindow+"];\n",fragmentShader+="void main() {\n",fragmentShader+="  vec4 color = texture2D(uTexture, vTexCoord);\n",fragmentShader+="  float sum = 1.0;\n",offsets.forEach(function(offset,i){fragmentShader+="  color += texture2D(uTexture, vTexCoord + "+offset+") * uTaps["+i+"];\n",fragmentShader+="  color += texture2D(uTexture, vTexCoord - "+offset+") * uTaps["+i+"];\n",fragmentShader+="  sum += 2.0 * uTaps["+i+"];\n"}),fragmentShader+="  gl_FragColor = color / sum;\n",fragmentShader+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(options){options.webgl?(options.passes++,this.width=options.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=options.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),options.destinationWidth=this.dW,this._setupFrameBuffer(options),this.applyToWebGL(options),this._swapTextures(options),options.sourceWidth=options.destinationWidth,this.height=options.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),options.destinationHeight=this.dH,this._setupFrameBuffer(options),this.applyToWebGL(options),this._swapTextures(options),options.sourceHeight=options.destinationHeight):this.applyTo2d(options)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(lobes){return function(x){if(x>=lobes||x<=-lobes)return 0;if(x<1.1920929e-7&&x>-1.1920929e-7)return 1;var xx=(x*=Math.PI)/lobes;return sin(x)/x*sin(xx)/xx}},applyTo2d:function(options){var imageData=options.imageData,scaleX=this.scaleX,scaleY=this.scaleY;this.rcpScaleX=1/scaleX,this.rcpScaleY=1/scaleY;var oW=imageData.width,oH=imageData.height,dW=round(oW*scaleX),dH=round(oH*scaleY),newData;"sliceHack"===this.resizeType?newData=this.sliceByTwo(options,oW,oH,dW,dH):"hermite"===this.resizeType?newData=this.hermiteFastResize(options,oW,oH,dW,dH):"bilinear"===this.resizeType?newData=this.bilinearFiltering(options,oW,oH,dW,dH):"lanczos"===this.resizeType&&(newData=this.lanczosResize(options,oW,oH,dW,dH)),options.imageData=newData},sliceByTwo:function(options,oW,oH,dW,dH){var imageData=options.imageData,mult=.5,doneW=!1,doneH=!1,stepW=.5*oW,stepH=.5*oH,resources=fabric.filterBackend.resources,tmpCanvas,ctx,sX=0,sY=0,dX=oW,dY=0;for(resources.sliceByTwo||(resources.sliceByTwo=document.createElement("canvas")),((tmpCanvas=resources.sliceByTwo).width<1.5*oW||tmpCanvas.height<oH)&&(tmpCanvas.width=1.5*oW,tmpCanvas.height=oH),(ctx=tmpCanvas.getContext("2d")).clearRect(0,0,1.5*oW,oH),ctx.putImageData(imageData,0,0),dW=floor(dW),dH=floor(dH);!doneW||!doneH;)oW=stepW,oH=stepH,dW<floor(.5*stepW)?stepW=floor(.5*stepW):(stepW=dW,doneW=!0),dH<floor(.5*stepH)?stepH=floor(.5*stepH):(stepH=dH,doneH=!0),ctx.drawImage(tmpCanvas,sX,sY,oW,oH,dX,dY,stepW,stepH),sX=dX,sY=dY,dY+=stepH;return ctx.getImageData(sX,sY,dW,dH)},lanczosResize:function(options,oW,oH,dW,dH){function process(u){var v,i,weight,idx,a,red,green,blue,alpha,fX,fY;for(center.x=(u+.5)*ratioX,icenter.x=floor(center.x),v=0;v<dH;v++){for(center.y=(v+.5)*ratioY,icenter.y=floor(center.y),a=0,red=0,green=0,blue=0,alpha=0,i=icenter.x-range2X;i<=icenter.x+range2X;i++)if(!(i<0||i>=oW)){fX=floor(1e3*abs(i-center.x)),cacheLanc[fX]||(cacheLanc[fX]={});for(var j=icenter.y-range2Y;j<=icenter.y+range2Y;j++)j<0||j>=oH||(fY=floor(1e3*abs(j-center.y)),cacheLanc[fX][fY]||(cacheLanc[fX][fY]=lanczos(sqrt(pow(fX*rcpRatioX,2)+pow(fY*rcpRatioY,2))/1e3)),(weight=cacheLanc[fX][fY])>0&&(a+=weight,red+=weight*srcData[idx=4*(j*oW+i)],green+=weight*srcData[idx+1],blue+=weight*srcData[idx+2],alpha+=weight*srcData[idx+3]))}destData[idx=4*(v*dW+u)]=red/a,destData[idx+1]=green/a,destData[idx+2]=blue/a,destData[idx+3]=alpha/a}return++u<dW?process(u):destImg}var srcData=options.imageData.data,destImg=options.ctx.createImageData(dW,dH),destData=destImg.data,lanczos=this.lanczosCreate(this.lanczosLobes),ratioX=this.rcpScaleX,ratioY=this.rcpScaleY,rcpRatioX=2/this.rcpScaleX,rcpRatioY=2/this.rcpScaleY,range2X=ceil(ratioX*this.lanczosLobes/2),range2Y=ceil(ratioY*this.lanczosLobes/2),cacheLanc={},center={},icenter={};return process(0)},bilinearFiltering:function(options,oW,oH,dW,dH){var a,b,c,d,x,y,i,j,xDiff,yDiff,chnl,color,offset=0,origPix,ratioX=this.rcpScaleX,ratioY=this.rcpScaleY,w4=4*(oW-1),img,pixels=options.imageData.data,destImage=options.ctx.createImageData(dW,dH),destPixels=destImage.data;for(i=0;i<dH;i++)for(j=0;j<dW;j++)for(xDiff=ratioX*j-(x=floor(ratioX*j)),yDiff=ratioY*i-(y=floor(ratioY*i)),origPix=4*(y*oW+x),chnl=0;chnl<4;chnl++)color=(a=pixels[origPix+chnl])*(1-xDiff)*(1-yDiff)+(b=pixels[origPix+4+chnl])*xDiff*(1-yDiff)+(c=pixels[origPix+w4+chnl])*yDiff*(1-xDiff)+(d=pixels[origPix+w4+4+chnl])*xDiff*yDiff,destPixels[offset++]=color;return destImage},hermiteFastResize:function(options,oW,oH,dW,dH){for(var ratioW=this.rcpScaleX,ratioH=this.rcpScaleY,ratioWHalf=ceil(ratioW/2),ratioHHalf=ceil(ratioH/2),img,data=options.imageData.data,img2=options.ctx.createImageData(dW,dH),data2=img2.data,j=0;j<dH;j++)for(var i=0;i<dW;i++){for(var x2=4*(i+j*dW),weight=0,weights=0,weightsAlpha=0,gxR=0,gxG=0,gxB=0,gxA=0,centerY=(j+.5)*ratioH,yy=floor(j*ratioH);yy<(j+1)*ratioH;yy++)for(var dy=abs(centerY-(yy+.5))/ratioHHalf,centerX=(i+.5)*ratioW,w0=dy*dy,xx=floor(i*ratioW);xx<(i+1)*ratioW;xx++){var dx=abs(centerX-(xx+.5))/ratioWHalf,w=sqrt(w0+dx*dx);w>1&&w<-1||(weight=2*w*w*w-3*w*w+1)>0&&(gxA+=weight*data[(dx=4*(xx+yy*oW))+3],weightsAlpha+=weight,data[dx+3]<255&&(weight=weight*data[dx+3]/250),gxR+=weight*data[dx],gxG+=weight*data[dx+1],gxB+=weight*data[dx+2],weights+=weight)}data2[x2]=gxR/weights,data2[x2+1]=gxG/weights,data2[x2+2]=gxB/weights,data2[x2+3]=gxA/weightsAlpha}return img2},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),fabric.Image.filters.Resize.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Contrast=createClass(filters.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(options){if(0!==this.contrast){var imageData,i,len,data=options.imageData.data,len=data.length,contrast=Math.floor(255*this.contrast),contrastF=259*(contrast+255)/(255*(259-contrast));for(i=0;i<len;i+=4)data[i]=contrastF*(data[i]-128)+128,data[i+1]=contrastF*(data[i+1]-128)+128,data[i+2]=contrastF*(data[i+2]-128)+128}},getUniformLocations:function(gl,program){return{uContrast:gl.getUniformLocation(program,"uContrast")}},sendUniformData:function(gl,uniformLocations){gl.uniform1f(uniformLocations.uContrast,this.contrast)}}),fabric.Image.filters.Contrast.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Saturation=createClass(filters.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(options){if(0!==this.saturation){var imageData,data=options.imageData.data,len=data.length,adjust=-this.saturation,i,max;for(i=0;i<len;i+=4)max=Math.max(data[i],data[i+1],data[i+2]),data[i]+=max!==data[i]?(max-data[i])*adjust:0,data[i+1]+=max!==data[i+1]?(max-data[i+1])*adjust:0,data[i+2]+=max!==data[i+2]?(max-data[i+2])*adjust:0}},getUniformLocations:function(gl,program){return{uSaturation:gl.getUniformLocation(program,"uSaturation")}},sendUniformData:function(gl,uniformLocations){gl.uniform1f(uniformLocations.uSaturation,-this.saturation)}}),fabric.Image.filters.Saturation.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Blur=createClass(filters.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(options){options.webgl?(this.aspectRatio=options.sourceWidth/options.sourceHeight,options.passes++,this._setupFrameBuffer(options),this.horizontal=!0,this.applyToWebGL(options),this._swapTextures(options),this._setupFrameBuffer(options),this.horizontal=!1,this.applyToWebGL(options),this._swapTextures(options)):this.applyTo2d(options)},applyTo2d:function(options){options.imageData=this.simpleBlur(options)},simpleBlur:function(options){var resources=options.filterBackend.resources,canvas1,canvas2,width=options.imageData.width,height=options.imageData.height;resources.blurLayer1||(resources.blurLayer1=fabric.util.createCanvasElement(),resources.blurLayer2=fabric.util.createCanvasElement()),canvas1=resources.blurLayer1,canvas2=resources.blurLayer2,canvas1.width===width&&canvas1.height===height||(canvas2.width=canvas1.width=width,canvas2.height=canvas1.height=height);var ctx1=canvas1.getContext("2d"),ctx2=canvas2.getContext("2d"),nSamples=15,random,percent,j,i,blur=.06*this.blur*.5;for(ctx1.putImageData(options.imageData,0,0),ctx2.clearRect(0,0,width,height),i=-15;i<=15;i++)j=blur*(percent=i/15)*width+(random=(Math.random()-.5)/4),ctx2.globalAlpha=1-Math.abs(percent),ctx2.drawImage(canvas1,j,random),ctx1.drawImage(canvas2,0,0),ctx2.globalAlpha=1,ctx2.clearRect(0,0,canvas2.width,canvas2.height);for(i=-15;i<=15;i++)j=blur*(percent=i/15)*height+(random=(Math.random()-.5)/4),ctx2.globalAlpha=1-Math.abs(percent),ctx2.drawImage(canvas1,random,j),ctx1.drawImage(canvas2,0,0),ctx2.globalAlpha=1,ctx2.clearRect(0,0,canvas2.width,canvas2.height);options.ctx.drawImage(canvas1,0,0);var newImageData=options.ctx.getImageData(0,0,canvas1.width,canvas1.height);return ctx1.globalAlpha=1,ctx1.clearRect(0,0,canvas1.width,canvas1.height),newImageData},getUniformLocations:function(gl,program){return{delta:gl.getUniformLocation(program,"uDelta")}},sendUniformData:function(gl,uniformLocations){var delta=this.chooseRightDelta();gl.uniform2fv(uniformLocations.delta,delta)},chooseRightDelta:function(){var blurScale=1,delta=[0,0],blur;return this.horizontal?this.aspectRatio>1&&(blurScale=1/this.aspectRatio):this.aspectRatio<1&&(blurScale=this.aspectRatio),blur=blurScale*this.blur*.12,this.horizontal?delta[0]=blur:delta[1]=blur,delta}}),filters.Blur.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Gamma=createClass(filters.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(options){this.gamma=[1,1,1],filters.BaseFilter.prototype.initialize.call(this,options)},applyTo2d:function(options){var imageData,data=options.imageData.data,gamma=this.gamma,len=data.length,rInv=1/gamma[0],gInv=1/gamma[1],bInv=1/gamma[2],i;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),i=0,len=256;i<len;i++)this.rVals[i]=255*Math.pow(i/255,rInv),this.gVals[i]=255*Math.pow(i/255,gInv),this.bVals[i]=255*Math.pow(i/255,bInv);for(i=0,len=data.length;i<len;i+=4)data[i]=this.rVals[data[i]],data[i+1]=this.gVals[data[i+1]],data[i+2]=this.bVals[data[i+2]]},getUniformLocations:function(gl,program){return{uGamma:gl.getUniformLocation(program,"uGamma")}},sendUniformData:function(gl,uniformLocations){gl.uniform3fv(uniformLocations.uGamma,this.gamma)}}),fabric.Image.filters.Gamma.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.Composed=createClass(filters.BaseFilter,{type:"Composed",subFilters:[],initialize:function(options){this.callSuper("initialize",options),this.subFilters=this.subFilters.slice(0)},applyTo:function(options){options.passes+=this.subFilters.length-1,this.subFilters.forEach(function(filter){filter.applyTo(options)})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(filter){return filter.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(filter){return!filter.isNeutralState()})}}),fabric.Image.filters.Composed.fromObject=function(object,callback){var filters,subFilters=(object.subFilters||[]).map(function(filter){return new fabric.Image.filters[filter.type](filter)}),instance=new fabric.Image.filters.Composed({subFilters:subFilters});return callback&&callback(instance),instance}}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),filters=fabric.Image.filters,createClass=fabric.util.createClass;filters.HueRotation=createClass(filters.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var rad=this.rotation*Math.PI,cos=fabric.util.cos(rad),sin=fabric.util.sin(rad),aThird=1/3,aThirdSqtSin=Math.sqrt(1/3)*sin,OneMinusCos=1-cos;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=cos+OneMinusCos/3,this.matrix[1]=1/3*OneMinusCos-aThirdSqtSin,this.matrix[2]=1/3*OneMinusCos+aThirdSqtSin,this.matrix[5]=1/3*OneMinusCos+aThirdSqtSin,this.matrix[6]=cos+1/3*OneMinusCos,this.matrix[7]=1/3*OneMinusCos-aThirdSqtSin,this.matrix[10]=1/3*OneMinusCos-aThirdSqtSin,this.matrix[11]=1/3*OneMinusCos+aThirdSqtSin,this.matrix[12]=cos+1/3*OneMinusCos},isNeutralState:function(options){return this.calculateMatrix(),filters.BaseFilter.prototype.isNeutralState.call(this,options)},applyTo:function(options){this.calculateMatrix(),filters.BaseFilter.prototype.applyTo.call(this,options)}}),fabric.Image.filters.HueRotation.fromObject=fabric.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(global){"use strict";var fabric=global.fabric||(global.fabric={}),clone=fabric.util.object.clone;fabric.Text?fabric.warn("fabric.Text is already defined"):(fabric.Text=fabric.util.createClass(fabric.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:fabric.Object.prototype.stateProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),cacheProperties:fabric.Object.prototype.cacheProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),stroke:null,shadow:null,_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(text,options){this.styles=options&&options.styles||{},this.text=text,this.__skipDimension=!0,this.callSuper("initialize",options),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},getMeasuringContext:function(){return fabric._measuringContext||(fabric._measuringContext=this.canvas&&this.canvas.contextCache||fabric.util.createCanvasElement().getContext("2d")),fabric._measuringContext},_splitText:function(){var newLines=this._splitTextIntoLines(this.text);return this.textLines=newLines.lines,this._textLines=newLines.graphemeLines,this._unwrappedTextLines=newLines._unwrappedLines,this._text=newLines.graphemeText,newLines},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var diffSpace,currentLineWidth,numberOfSpaces,accumulatedSpace,line,charBound,spaces,i=0,len=this._textLines.length;i<len;i++)if(("justify"===this.textAlign||i!==len-1&&!this.isEndOfWrapping(i))&&(accumulatedSpace=0,line=this._textLines[i],(currentLineWidth=this.getLineWidth(i))<this.width&&(spaces=this.textLines[i].match(this._reSpacesAndTabs)))){numberOfSpaces=spaces.length,diffSpace=(this.width-currentLineWidth)/numberOfSpaces;for(var j=0,jlen=line.length;j<=jlen;j++)charBound=this.__charBounds[i][j],this._reSpaceAndTab.test(line[j])?(charBound.width+=diffSpace,charBound.kernedWidth+=diffSpace,charBound.left+=accumulatedSpace,accumulatedSpace+=diffSpace):charBound.left+=accumulatedSpace}},isEndOfWrapping:function(lineIndex){return lineIndex===this._textLines.length-1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var dims=this.callSuper("_getCacheCanvasDimensions"),fontSize=this.fontSize;return dims.width+=fontSize*dims.zoomX,dims.height+=fontSize*dims.zoomY,dims},_render:function(ctx){this._setTextStyles(ctx),this._renderTextLinesBackground(ctx),this._renderTextDecoration(ctx,"underline"),this._renderText(ctx),this._renderTextDecoration(ctx,"overline"),this._renderTextDecoration(ctx,"linethrough")},_renderText:function(ctx){"stroke"===this.paintFirst?(this._renderTextStroke(ctx),this._renderTextFill(ctx)):(this._renderTextFill(ctx),this._renderTextStroke(ctx))},_setTextStyles:function(ctx,charStyle,forMeasuring){ctx.textBaseline="alphabetic",ctx.font=this._getFontDeclaration(charStyle,forMeasuring)},calcTextWidth:function(){for(var maxWidth=this.getLineWidth(0),i=1,len=this._textLines.length;i<len;i++){var currentLineWidth=this.getLineWidth(i);currentLineWidth>maxWidth&&(maxWidth=currentLineWidth)}return maxWidth},_renderTextLine:function(method,ctx,line,left,top,lineIndex){this._renderChars(method,ctx,line,left,top,lineIndex)},_renderTextLinesBackground:function(ctx){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var lineTopOffset=0,heightOfLine,lineLeftOffset,originalFill=ctx.fillStyle,line,lastColor,leftOffset=this._getLeftOffset(),topOffset=this._getTopOffset(),boxStart=0,boxWidth=0,charBox,currentColor,i=0,len=this._textLines.length;i<len;i++)if(heightOfLine=this.getHeightOfLine(i),this.textBackgroundColor||this.styleHas("textBackgroundColor",i)){line=this._textLines[i],lineLeftOffset=this._getLineLeftOffset(i),boxWidth=0,boxStart=0,lastColor=this.getValueOfPropertyAt(i,0,"textBackgroundColor");for(var j=0,jlen=line.length;j<jlen;j++)charBox=this.__charBounds[i][j],(currentColor=this.getValueOfPropertyAt(i,j,"textBackgroundColor"))!==lastColor?(ctx.fillStyle=lastColor,lastColor&&ctx.fillRect(leftOffset+lineLeftOffset+boxStart,topOffset+lineTopOffset,boxWidth,heightOfLine/this.lineHeight),boxStart=charBox.left,boxWidth=charBox.width,lastColor=currentColor):boxWidth+=charBox.kernedWidth;currentColor&&(ctx.fillStyle=currentColor,ctx.fillRect(leftOffset+lineLeftOffset+boxStart,topOffset+lineTopOffset,boxWidth,heightOfLine/this.lineHeight)),lineTopOffset+=heightOfLine}else lineTopOffset+=heightOfLine;ctx.fillStyle=originalFill,this._removeShadow(ctx)}},getFontCache:function(decl){var fontFamily=decl.fontFamily.toLowerCase();fabric.charWidthsCache[fontFamily]||(fabric.charWidthsCache[fontFamily]={});var cache=fabric.charWidthsCache[fontFamily],cacheProp=decl.fontStyle.toLowerCase()+"_"+(decl.fontWeight+"").toLowerCase();return cache[cacheProp]||(cache[cacheProp]={}),cache[cacheProp]},_applyCharStyles:function(method,ctx,lineIndex,charIndex,styleDeclaration){this._setFillStyles(ctx,styleDeclaration),this._setStrokeStyles(ctx,styleDeclaration),ctx.font=this._getFontDeclaration(styleDeclaration)},_measureChar:function(_char,charStyle,previousChar,prevCharStyle){var fontCache=this.getFontCache(charStyle),fontDeclaration,previousFontDeclaration,couple=previousChar+_char,stylesAreEqual=this._getFontDeclaration(charStyle)===this._getFontDeclaration(prevCharStyle),width,coupleWidth,previousWidth,fontMultiplier=charStyle.fontSize/this.CACHE_FONT_SIZE,kernedWidth;if(previousChar&&void 0!==fontCache[previousChar]&&(previousWidth=fontCache[previousChar]),void 0!==fontCache[_char]&&(kernedWidth=width=fontCache[_char]),stylesAreEqual&&void 0!==fontCache[couple]&&(kernedWidth=(coupleWidth=fontCache[couple])-previousWidth),void 0===width||void 0===previousWidth||void 0===coupleWidth){var ctx=this.getMeasuringContext();this._setTextStyles(ctx,charStyle,!0)}return void 0===width&&(kernedWidth=width=ctx.measureText(_char).width,fontCache[_char]=width),void 0===previousWidth&&stylesAreEqual&&previousChar&&(previousWidth=ctx.measureText(previousChar).width,fontCache[previousChar]=previousWidth),stylesAreEqual&&void 0===coupleWidth&&(coupleWidth=ctx.measureText(couple).width,fontCache[couple]=coupleWidth,kernedWidth=coupleWidth-previousWidth),{width:width*fontMultiplier,kernedWidth:kernedWidth*fontMultiplier}},getHeightOfChar:function(line,char){return this.getValueOfPropertyAt(line,char,"fontSize")},measureLine:function(lineIndex){var lineInfo=this._measureLine(lineIndex);return 0!==this.charSpacing&&(lineInfo.width-=this._getWidthOfCharSpacing()),lineInfo.width<0&&(lineInfo.width=0),lineInfo},_measureLine:function(lineIndex){var width=0,i,grapheme,line=this._textLines[lineIndex],prevGrapheme,graphemeInfo,numOfSpaces=0,lineBounds=new Array(line.length);for(this.__charBounds[lineIndex]=lineBounds,i=0;i<line.length;i++)grapheme=line[i],graphemeInfo=this._getGraphemeBox(grapheme,lineIndex,i,prevGrapheme),lineBounds[i]=graphemeInfo,width+=graphemeInfo.kernedWidth,prevGrapheme=grapheme;return lineBounds[i]={left:graphemeInfo?graphemeInfo.left+graphemeInfo.width:0,width:0,kernedWidth:0,height:this.fontSize},{width:width,numOfSpaces:0}},_getGraphemeBox:function(grapheme,lineIndex,charIndex,prevGrapheme,skipLeft){var style=this.getCompleteStyleDeclaration(lineIndex,charIndex),prevStyle=prevGrapheme?this.getCompleteStyleDeclaration(lineIndex,charIndex-1):{},info=this._measureChar(grapheme,style,prevGrapheme,prevStyle),kernedWidth=info.kernedWidth,width=info.width,charSpacing;0!==this.charSpacing&&(width+=charSpacing=this._getWidthOfCharSpacing(),kernedWidth+=charSpacing);var box={width:width,left:0,height:style.fontSize,kernedWidth:kernedWidth,deltaY:style.deltaY};if(charIndex>0&&!skipLeft){var previousBox=this.__charBounds[lineIndex][charIndex-1];box.left=previousBox.left+previousBox.width+info.kernedWidth-info.width}return box},getHeightOfLine:function(lineIndex){if(this.__lineHeights[lineIndex])return this.__lineHeights[lineIndex];for(var line=this._textLines[lineIndex],maxHeight=this.getHeightOfChar(lineIndex,0),i=1,len=line.length;i<len;i++)maxHeight=Math.max(this.getHeightOfChar(lineIndex,i),maxHeight);return this.__lineHeights[lineIndex]=maxHeight*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var lineHeight,height=0,i=0,len=this._textLines.length;i<len;i++)lineHeight=this.getHeightOfLine(i),height+=i===len-1?lineHeight/this.lineHeight:lineHeight;return height},_getLeftOffset:function(){return-this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(ctx,method){ctx.save();for(var lineHeights=0,left=this._getLeftOffset(),top=this._getTopOffset(),offsets=this._applyPatternGradientTransform(ctx,"fillText"===method?this.fill:this.stroke),i=0,len=this._textLines.length;i<len;i++){var heightOfLine=this.getHeightOfLine(i),maxHeight=heightOfLine/this.lineHeight,leftOffset=this._getLineLeftOffset(i);this._renderTextLine(method,ctx,this._textLines[i],left+leftOffset-offsets.offsetX,top+lineHeights+maxHeight-offsets.offsetY,i),lineHeights+=heightOfLine}ctx.restore()},_renderTextFill:function(ctx){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(ctx,"fillText")},_renderTextStroke:function(ctx){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(ctx),ctx.save(),this._setLineDash(ctx,this.strokeDashArray),ctx.beginPath(),this._renderTextCommon(ctx,"strokeText"),ctx.closePath(),ctx.restore())},_renderChars:function(method,ctx,line,left,top,lineIndex){var lineHeight=this.getHeightOfLine(lineIndex),isJustify=-1!==this.textAlign.indexOf("justify"),actualStyle,nextStyle,charsToRender="",charBox,boxWidth=0,timeToRender,shortCut=!isJustify&&0===this.charSpacing&&this.isEmptyStyles(lineIndex);if(ctx.save(),top-=lineHeight*this._fontSizeFraction/this.lineHeight,shortCut)return this._renderChar(method,ctx,lineIndex,0,this.textLines[lineIndex],left,top,lineHeight),void ctx.restore();for(var i=0,len=line.length-1;i<=len;i++)timeToRender=i===len||this.charSpacing,charsToRender+=line[i],charBox=this.__charBounds[lineIndex][i],0===boxWidth?(left+=charBox.kernedWidth-charBox.width,boxWidth+=charBox.width):boxWidth+=charBox.kernedWidth,isJustify&&!timeToRender&&this._reSpaceAndTab.test(line[i])&&(timeToRender=!0),timeToRender||(actualStyle=actualStyle||this.getCompleteStyleDeclaration(lineIndex,i),nextStyle=this.getCompleteStyleDeclaration(lineIndex,i+1),timeToRender=this._hasStyleChanged(actualStyle,nextStyle)),timeToRender&&(this._renderChar(method,ctx,lineIndex,i,charsToRender,left,top,lineHeight),charsToRender="",actualStyle=nextStyle,left+=boxWidth,boxWidth=0);ctx.restore()},_renderChar:function(method,ctx,lineIndex,charIndex,_char,left,top){var decl=this._getStyleDeclaration(lineIndex,charIndex),fullDecl=this.getCompleteStyleDeclaration(lineIndex,charIndex),shouldFill="fillText"===method&&fullDecl.fill,shouldStroke="strokeText"===method&&fullDecl.stroke&&fullDecl.strokeWidth;(shouldStroke||shouldFill)&&(decl&&ctx.save(),this._applyCharStyles(method,ctx,lineIndex,charIndex,fullDecl),decl&&decl.textBackgroundColor&&this._removeShadow(ctx),decl&&decl.deltaY&&(top+=decl.deltaY),shouldFill&&ctx.fillText(_char,left,top),shouldStroke&&ctx.strokeText(_char,left,top),decl&&ctx.restore())},setSuperscript:function(start,end){return this._setScript(start,end,this.superscript)},setSubscript:function(start,end){return this._setScript(start,end,this.subscript)},_setScript:function(start,end,schema){var loc=this.get2DCursorLocation(start,!0),fontSize=this.getValueOfPropertyAt(loc.lineIndex,loc.charIndex,"fontSize"),dy=this.getValueOfPropertyAt(loc.lineIndex,loc.charIndex,"deltaY"),style={fontSize:fontSize*schema.size,deltaY:dy+fontSize*schema.baseline};return this.setSelectionStyles(style,start,end),this},_hasStyleChanged:function(prevStyle,thisStyle){return prevStyle.fill!==thisStyle.fill||prevStyle.stroke!==thisStyle.stroke||prevStyle.strokeWidth!==thisStyle.strokeWidth||prevStyle.fontSize!==thisStyle.fontSize||prevStyle.fontFamily!==thisStyle.fontFamily||prevStyle.fontWeight!==thisStyle.fontWeight||prevStyle.fontStyle!==thisStyle.fontStyle||prevStyle.deltaY!==thisStyle.deltaY},_hasStyleChangedForSvg:function(prevStyle,thisStyle){return this._hasStyleChanged(prevStyle,thisStyle)||prevStyle.overline!==thisStyle.overline||prevStyle.underline!==thisStyle.underline||prevStyle.linethrough!==thisStyle.linethrough},_getLineLeftOffset:function(lineIndex){var lineWidth=this.getLineWidth(lineIndex);return"center"===this.textAlign?(this.width-lineWidth)/2:"right"===this.textAlign?this.width-lineWidth:"justify-center"===this.textAlign&&this.isEndOfWrapping(lineIndex)?(this.width-lineWidth)/2:"justify-right"===this.textAlign&&this.isEndOfWrapping(lineIndex)?this.width-lineWidth:0},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var shouldClear=this._forceClearCache;return shouldClear||(shouldClear=this.hasStateChanged("_dimensionAffectingProps")),shouldClear&&(this.dirty=!0,this._forceClearCache=!1),shouldClear},getLineWidth:function(lineIndex){return this.__lineWidths[lineIndex]?this.__lineWidths[lineIndex]:(width=""===this._textLines[lineIndex]?0:(lineInfo=this.measureLine(lineIndex)).width,this.__lineWidths[lineIndex]=width,width);var width,line,lineInfo},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(lineIndex,charIndex,property){var charStyle=this._getStyleDeclaration(lineIndex,charIndex);return charStyle&&void 0!==charStyle[property]?charStyle[property]:this[property]},_renderTextDecoration:function(ctx,type){if(this[type]||this.styleHas(type)){for(var heightOfLine,size,_size,lineLeftOffset,dy,_dy,line,lastDecoration,leftOffset=this._getLeftOffset(),topOffset=this._getTopOffset(),top,boxStart,boxWidth,charBox,currentDecoration,maxHeight,currentFill,lastFill,charSpacing=this._getWidthOfCharSpacing(),i=0,len=this._textLines.length;i<len;i++)if(heightOfLine=this.getHeightOfLine(i),this[type]||this.styleHas(type,i)){line=this._textLines[i],maxHeight=heightOfLine/this.lineHeight,lineLeftOffset=this._getLineLeftOffset(i),boxStart=0,boxWidth=0,lastDecoration=this.getValueOfPropertyAt(i,0,type),lastFill=this.getValueOfPropertyAt(i,0,"fill"),top=topOffset+maxHeight*(1-this._fontSizeFraction),size=this.getHeightOfChar(i,0),dy=this.getValueOfPropertyAt(i,0,"deltaY");for(var j=0,jlen=line.length;j<jlen;j++)charBox=this.__charBounds[i][j],currentDecoration=this.getValueOfPropertyAt(i,j,type),currentFill=this.getValueOfPropertyAt(i,j,"fill"),_size=this.getHeightOfChar(i,j),_dy=this.getValueOfPropertyAt(i,j,"deltaY"),(currentDecoration!==lastDecoration||currentFill!==lastFill||_size!==size||_dy!==dy)&&boxWidth>0?(ctx.fillStyle=lastFill,lastDecoration&&lastFill&&ctx.fillRect(leftOffset+lineLeftOffset+boxStart,top+this.offsets[type]*size+dy,boxWidth,this.fontSize/15),boxStart=charBox.left,boxWidth=charBox.width,lastDecoration=currentDecoration,lastFill=currentFill,size=_size,dy=_dy):boxWidth+=charBox.kernedWidth;ctx.fillStyle=currentFill,currentDecoration&&currentFill&&ctx.fillRect(leftOffset+lineLeftOffset+boxStart,top+this.offsets[type]*size+dy,boxWidth-charSpacing,this.fontSize/15),topOffset+=heightOfLine}else topOffset+=heightOfLine;this._removeShadow(ctx)}},_getFontDeclaration:function(styleObject,forMeasuring){var style=styleObject||this,family=this.fontFamily,fontIsGeneric=fabric.Text.genericFonts.indexOf(family.toLowerCase())>-1,fontFamily=void 0===family||family.indexOf("'")>-1||family.indexOf('"')>-1||fontIsGeneric?style.fontFamily:'"'+style.fontFamily+'"';return[fabric.isLikelyNode?style.fontWeight:style.fontStyle,fabric.isLikelyNode?style.fontStyle:style.fontWeight,forMeasuring?this.CACHE_FONT_SIZE+"px":style.fontSize+"px",fontFamily].join(" ")},render:function(ctx){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",ctx)))},_splitTextIntoLines:function(text){for(var lines=text.split(this._reNewline),newLines=new Array(lines.length),newLine=["\n"],newText=[],i=0;i<lines.length;i++)newLines[i]=fabric.util.string.graphemeSplit(lines[i]),newText=newText.concat(newLines[i],newLine);return newText.pop(),{_unwrappedLines:newLines,lines:lines,graphemeText:newText,graphemeLines:newLines}},toObject:function(propertiesToInclude){var additionalProperties=["text","fontSize","fontWeight","fontFamily","fontStyle","lineHeight","underline","overline","linethrough","textAlign","textBackgroundColor","charSpacing"].concat(propertiesToInclude),obj=this.callSuper("toObject",additionalProperties);return obj.styles=clone(this.styles,!0),obj},set:function(key,value){this.callSuper("set",key,value);var needsDims=!1;if("object"==typeof key)for(var _key in key)needsDims=needsDims||-1!==this._dimensionAffectingProps.indexOf(_key);else needsDims=-1!==this._dimensionAffectingProps.indexOf(key);return needsDims&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),fabric.Text.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),fabric.Text.DEFAULT_SVG_FONT_SIZE=16,fabric.Text.fromElement=function(element,callback,options){if(!element)return callback(null);var parsedAttributes=fabric.parseAttributes(element,fabric.Text.ATTRIBUTE_NAMES),parsedAnchor=parsedAttributes.textAnchor||"left";if((options=fabric.util.object.extend(options?clone(options):{},parsedAttributes)).top=options.top||0,options.left=options.left||0,parsedAttributes.textDecoration){var textDecoration=parsedAttributes.textDecoration;-1!==textDecoration.indexOf("underline")&&(options.underline=!0),-1!==textDecoration.indexOf("overline")&&(options.overline=!0),-1!==textDecoration.indexOf("line-through")&&(options.linethrough=!0),delete options.textDecoration}"dx"in parsedAttributes&&(options.left+=parsedAttributes.dx),"dy"in parsedAttributes&&(options.top+=parsedAttributes.dy),"fontSize"in options||(options.fontSize=fabric.Text.DEFAULT_SVG_FONT_SIZE);var textContent="";"textContent"in element?textContent=element.textContent:"firstChild"in element&&null!==element.firstChild&&"data"in element.firstChild&&null!==element.firstChild.data&&(textContent=element.firstChild.data),textContent=textContent.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var originalStrokeWidth=options.strokeWidth;options.strokeWidth=0;var text=new fabric.Text(textContent,options),textHeightScaleFactor=text.getScaledHeight()/text.height,lineHeightDiff,scaledDiff=((text.height+text.strokeWidth)*text.lineHeight-text.height)*textHeightScaleFactor,textHeight=text.getScaledHeight()+scaledDiff,offX=0;"center"===parsedAnchor&&(offX=text.getScaledWidth()/2),"right"===parsedAnchor&&(offX=text.getScaledWidth()),text.set({left:text.left-offX,top:text.top-(textHeight-text.fontSize*(.07+text._fontSizeFraction))/text.lineHeight,strokeWidth:void 0!==originalStrokeWidth?originalStrokeWidth:1}),callback(text)},fabric.Text.fromObject=function(object,callback){return fabric.Object._fromObject("Text",object,callback,"text")},fabric.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],fabric.util.createAccessors&&fabric.util.createAccessors(fabric.Text))}("undefined"!=typeof exports?exports:this),fabric.util.object.extend(fabric.Text.prototype,{isEmptyStyles:function(lineIndex){if(!this.styles)return!0;if(void 0!==lineIndex&&!this.styles[lineIndex])return!0;var obj=void 0===lineIndex?this.styles:{line:this.styles[lineIndex]};for(var p1 in obj)for(var p2 in obj[p1])for(var p3 in obj[p1][p2])return!1;return!0},styleHas:function(property,lineIndex){if(!this.styles||!property||""===property)return!1;if(void 0!==lineIndex&&!this.styles[lineIndex])return!1;var obj=void 0===lineIndex?this.styles:{line:this.styles[lineIndex]};for(var p1 in obj)for(var p2 in obj[p1])if(void 0!==obj[p1][p2][property])return!0;return!1},cleanStyle:function(property){if(!this.styles||!property||""===property)return!1;var obj=this.styles,stylesCount=0,letterCount,stylePropertyValue,allStyleObjectPropertiesMatch=!0,graphemeCount=0,styleObject;for(var p1 in obj){for(var p2 in letterCount=0,obj[p1]){var styleObject,stylePropertyHasBeenSet;stylesCount++,(styleObject=obj[p1][p2]).hasOwnProperty(property)?(stylePropertyValue?styleObject[property]!==stylePropertyValue&&(allStyleObjectPropertiesMatch=!1):stylePropertyValue=styleObject[property],styleObject[property]===this[property]&&delete styleObject[property]):allStyleObjectPropertiesMatch=!1,0!==Object.keys(styleObject).length?letterCount++:delete obj[p1][p2]}0===letterCount&&delete obj[p1]}for(var i=0;i<this._textLines.length;i++)graphemeCount+=this._textLines[i].length;allStyleObjectPropertiesMatch&&stylesCount===graphemeCount&&(this[property]=stylePropertyValue,this.removeStyle(property))},removeStyle:function(property){if(this.styles&&property&&""!==property){var obj=this.styles,line,lineNum,charNum;for(lineNum in obj){for(charNum in line=obj[lineNum])delete line[charNum][property],0===Object.keys(line[charNum]).length&&delete line[charNum];0===Object.keys(line).length&&delete obj[lineNum]}}},_extendStyles:function(index,styles){var loc=this.get2DCursorLocation(index);this._getLineStyle(loc.lineIndex)||this._setLineStyle(loc.lineIndex,{}),this._getStyleDeclaration(loc.lineIndex,loc.charIndex)||this._setStyleDeclaration(loc.lineIndex,loc.charIndex,{}),fabric.util.object.extend(this._getStyleDeclaration(loc.lineIndex,loc.charIndex),styles)},get2DCursorLocation:function(selectionStart,skipWrapping){void 0===selectionStart&&(selectionStart=this.selectionStart);for(var lines=skipWrapping?this._unwrappedTextLines:this._textLines,len=lines.length,i=0;i<len;i++){if(selectionStart<=lines[i].length)return{lineIndex:i,charIndex:selectionStart};selectionStart-=lines[i].length+1}return{lineIndex:i-1,charIndex:lines[i-1].length<selectionStart?lines[i-1].length:selectionStart}},getSelectionStyles:function(startIndex,endIndex,complete){void 0===startIndex&&(startIndex=this.selectionStart||0),void 0===endIndex&&(endIndex=this.selectionEnd||startIndex);for(var styles=[],i=startIndex;i<endIndex;i++)styles.push(this.getStyleAtPosition(i,complete));return styles},getStyleAtPosition:function(position,complete){var loc=this.get2DCursorLocation(position),style;return(complete?this.getCompleteStyleDeclaration(loc.lineIndex,loc.charIndex):this._getStyleDeclaration(loc.lineIndex,loc.charIndex))||{}},setSelectionStyles:function(styles,startIndex,endIndex){void 0===startIndex&&(startIndex=this.selectionStart||0),void 0===endIndex&&(endIndex=this.selectionEnd||startIndex);for(var i=startIndex;i<endIndex;i++)this._extendStyles(i,styles);return this._forceClearCache=!0,this},_getStyleDeclaration:function(lineIndex,charIndex){var lineStyle=this.styles&&this.styles[lineIndex];return lineStyle?lineStyle[charIndex]:null},getCompleteStyleDeclaration:function(lineIndex,charIndex){for(var style=this._getStyleDeclaration(lineIndex,charIndex)||{},styleObject={},prop,i=0;i<this._styleProperties.length;i++)styleObject[prop=this._styleProperties[i]]=void 0===style[prop]?this[prop]:style[prop];return styleObject},_setStyleDeclaration:function(lineIndex,charIndex,style){this.styles[lineIndex][charIndex]=style},_deleteStyleDeclaration:function(lineIndex,charIndex){delete this.styles[lineIndex][charIndex]},_getLineStyle:function(lineIndex){return this.styles[lineIndex]},_setLineStyle:function(lineIndex,style){this.styles[lineIndex]=style},_deleteLineStyle:function(lineIndex){delete this.styles[lineIndex]}}),function(){function parseDecoration(object){object.textDecoration&&(object.textDecoration.indexOf("underline")>-1&&(object.underline=!0),object.textDecoration.indexOf("line-through")>-1&&(object.linethrough=!0),object.textDecoration.indexOf("overline")>-1&&(object.overline=!0),delete object.textDecoration)}fabric.IText=fabric.util.createClass(fabric.Text,fabric.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"#333",cursorDelay:1e3,cursorDuration:600,caching:!0,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(text,options){this.callSuper("initialize",text,options),this.initBehavior()},setSelectionStart:function(index){index=Math.max(index,0),this._updateAndFire("selectionStart",index)},setSelectionEnd:function(index){index=Math.min(index,this.text.length),this._updateAndFire("selectionEnd",index)},_updateAndFire:function(property,index){this[property]!==index&&(this._fireSelectionChanged(),this[property]=index),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(ctx){this.clearContextTop(),this.callSuper("render",ctx),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(ctx){this.callSuper("_render",ctx)},clearContextTop:function(skipRestore){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var ctx=this.canvas.contextTop,v=this.canvas.viewportTransform;ctx.save(),ctx.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this.transform(ctx),this.transformMatrix&&ctx.transform.apply(ctx,this.transformMatrix),this._clearTextArea(ctx),skipRestore||ctx.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas){var boundaries=this._getCursorBoundaries(),ctx;this.canvas&&this.canvas.contextTop?(ctx=this.canvas.contextTop,this.clearContextTop(!0)):(ctx=this.canvas.contextContainer).save(),this.selectionStart===this.selectionEnd?this.renderCursor(boundaries,ctx):this.renderSelection(boundaries,ctx),ctx.restore()}},_clearTextArea:function(ctx){var width=this.width+4,height=this.height+4;ctx.clearRect(-width/2,-height/2,width,height)},_getCursorBoundaries:function(position){void 0===position&&(position=this.selectionStart);var left=this._getLeftOffset(),top=this._getTopOffset(),offsets=this._getCursorBoundariesOffsets(position);return{left:left,top:top,leftOffset:offsets.left,topOffset:offsets.top}},_getCursorBoundariesOffsets:function(position){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var lineLeftOffset,lineIndex,charIndex,topOffset=0,leftOffset=0,boundaries,cursorPosition=this.get2DCursorLocation(position);charIndex=cursorPosition.charIndex,lineIndex=cursorPosition.lineIndex;for(var i=0;i<lineIndex;i++)topOffset+=this.getHeightOfLine(i);lineLeftOffset=this._getLineLeftOffset(lineIndex);var bound=this.__charBounds[lineIndex][charIndex];return bound&&(leftOffset=bound.left),0!==this.charSpacing&&charIndex===this._textLines[lineIndex].length&&(leftOffset-=this._getWidthOfCharSpacing()),boundaries={top:topOffset,left:lineLeftOffset+(leftOffset>0?leftOffset:0)},this.cursorOffsetCache=boundaries,this.cursorOffsetCache},renderCursor:function(boundaries,ctx){var cursorLocation=this.get2DCursorLocation(),lineIndex=cursorLocation.lineIndex,charIndex=cursorLocation.charIndex>0?cursorLocation.charIndex-1:0,charHeight=this.getValueOfPropertyAt(lineIndex,charIndex,"fontSize"),multiplier=this.scaleX*this.canvas.getZoom(),cursorWidth=this.cursorWidth/multiplier,topOffset=boundaries.topOffset,dy=this.getValueOfPropertyAt(lineIndex,charIndex,"deltaY");topOffset+=(1-this._fontSizeFraction)*this.getHeightOfLine(lineIndex)/this.lineHeight-charHeight*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(boundaries,ctx),ctx.fillStyle=this.getValueOfPropertyAt(lineIndex,charIndex,"fill"),ctx.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,ctx.fillRect(boundaries.left+boundaries.leftOffset-cursorWidth/2,topOffset+boundaries.top+dy,cursorWidth,charHeight)},renderSelection:function(boundaries,ctx){for(var selectionStart=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,isJustify=-1!==this.textAlign.indexOf("justify"),start=this.get2DCursorLocation(selectionStart),end=this.get2DCursorLocation(selectionEnd),startLine=start.lineIndex,endLine=end.lineIndex,startChar=start.charIndex<0?0:start.charIndex,endChar=end.charIndex<0?0:end.charIndex,i=startLine;i<=endLine;i++){var lineOffset=this._getLineLeftOffset(i)||0,lineHeight=this.getHeightOfLine(i),realLineHeight=0,boxStart=0,boxEnd=0;if(i===startLine&&(boxStart=this.__charBounds[startLine][startChar].left),i>=startLine&&i<endLine)boxEnd=isJustify&&!this.isEndOfWrapping(i)?this.width:this.getLineWidth(i)||5;else if(i===endLine)if(0===endChar)boxEnd=this.__charBounds[endLine][endChar].left;else{var charSpacing=this._getWidthOfCharSpacing();boxEnd=this.__charBounds[endLine][endChar-1].left+this.__charBounds[endLine][endChar-1].width-charSpacing}realLineHeight=lineHeight,(this.lineHeight<1||i===endLine&&this.lineHeight>1)&&(lineHeight/=this.lineHeight),this.inCompositionMode?(ctx.fillStyle=this.compositionColor||"black",ctx.fillRect(boundaries.left+lineOffset+boxStart,boundaries.top+boundaries.topOffset+lineHeight,boxEnd-boxStart,1)):(ctx.fillStyle=this.selectionColor,ctx.fillRect(boundaries.left+lineOffset+boxStart,boundaries.top+boundaries.topOffset,boxEnd-boxStart,lineHeight)),boundaries.topOffset+=realLineHeight}},getCurrentCharFontSize:function(){var cp=this._getCurrentCharIndex();return this.getValueOfPropertyAt(cp.l,cp.c,"fontSize")},getCurrentCharColor:function(){var cp=this._getCurrentCharIndex();return this.getValueOfPropertyAt(cp.l,cp.c,"fill")},_getCurrentCharIndex:function(){var cursorPosition=this.get2DCursorLocation(this.selectionStart,!0),charIndex=cursorPosition.charIndex>0?cursorPosition.charIndex-1:0;return{l:cursorPosition.lineIndex,c:charIndex}}}),fabric.IText.fromObject=function(object,callback){if(parseDecoration(object),object.styles)for(var i in object.styles)for(var j in object.styles[i])parseDecoration(object.styles[i][j]);fabric.Object._fromObject("IText",object,callback,"text")}}(),function(){var clone=fabric.util.object.clone;fabric.util.object.extend(fabric.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var _this=this;this.on("added",function(){var canvas=_this.canvas;canvas&&(canvas._hasITextHandlers||(canvas._hasITextHandlers=!0,_this._initCanvasHandlers(canvas)),canvas._iTextInstances=canvas._iTextInstances||[],canvas._iTextInstances.push(_this))})},initRemovedHandler:function(){var _this=this;this.on("removed",function(){var canvas=_this.canvas;canvas&&(canvas._iTextInstances=canvas._iTextInstances||[],fabric.util.removeFromArray(canvas._iTextInstances,_this),0===canvas._iTextInstances.length&&(canvas._hasITextHandlers=!1,_this._removeCanvasHandlers(canvas)))})},_initCanvasHandlers:function(canvas){canvas._mouseUpITextHandler=function(){canvas._iTextInstances&&canvas._iTextInstances.forEach(function(obj){obj.__isMousedown=!1})},canvas.on("mouse:up",canvas._mouseUpITextHandler)},_removeCanvasHandlers:function(canvas){canvas.off("mouse:up",canvas._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(obj,targetOpacity,duration,completeMethod){var tickState;return tickState={isAborted:!1,abort:function(){this.isAborted=!0}},obj.animate("_currentCursorOpacity",targetOpacity,{duration:duration,onComplete:function(){tickState.isAborted||obj[completeMethod]()},onChange:function(){obj.canvas&&obj.selectionStart===obj.selectionEnd&&obj.renderCursorOrSelection()},abort:function(){return tickState.isAborted}}),tickState},_onTickComplete:function(){var _this=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){_this._currentTickCompleteState=_this._animateCursor(_this,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(restart){var _this=this,delay=restart?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){_this._tick()},delay)},abortCursorAnimation:function(){var shouldClear=this._currentTickState||this._currentTickCompleteState,canvas=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,shouldClear&&canvas&&canvas.clearContext(canvas.contextTop||canvas.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(startFrom){var offset=0,index=startFrom-1;if(this._reSpace.test(this._text[index]))for(;this._reSpace.test(this._text[index]);)offset++,index--;for(;/\S/.test(this._text[index])&&index>-1;)offset++,index--;return startFrom-offset},findWordBoundaryRight:function(startFrom){var offset=0,index=startFrom;if(this._reSpace.test(this._text[index]))for(;this._reSpace.test(this._text[index]);)offset++,index++;for(;/\S/.test(this._text[index])&&index<this.text.length;)offset++,index++;return startFrom+offset},findLineBoundaryLeft:function(startFrom){for(var offset=0,index=startFrom-1;!/\n/.test(this._text[index])&&index>-1;)offset++,index--;return startFrom-offset},findLineBoundaryRight:function(startFrom){for(var offset=0,index=startFrom;!/\n/.test(this._text[index])&&index<this.text.length;)offset++,index++;return startFrom+offset},searchWordBoundary:function(selectionStart,direction){for(var index=this._reSpace.test(this.text.charAt(selectionStart))?selectionStart-1:selectionStart,_char=this.text.charAt(index),reNonWord=/[ \n\.,;!\?\-]/;!reNonWord.test(_char)&&index>0&&index<this.text.length;)index+=direction,_char=this.text.charAt(index);return reNonWord.test(_char)&&"\n"!==_char&&(index+=1===direction?0:1),index},selectWord:function(selectionStart){selectionStart=selectionStart||this.selectionStart;var newSelectionStart=this.searchWordBoundary(selectionStart,-1),newSelectionEnd=this.searchWordBoundary(selectionStart,1);this.selectionStart=newSelectionStart,this.selectionEnd=newSelectionEnd,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(selectionStart){selectionStart=selectionStart||this.selectionStart;var newSelectionStart=this.findLineBoundaryLeft(selectionStart),newSelectionEnd=this.findLineBoundaryRight(selectionStart);return this.selectionStart=newSelectionStart,this.selectionEnd=newSelectionEnd,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(e){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(e),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(canvas){canvas._iTextInstances&&canvas._iTextInstances.forEach(function(obj){obj.selected=!1,obj.isEditing&&obj.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(options){if(this.__isMousedown&&this.isEditing){var newSelectionStart=this.getSelectionStartFromPointer(options.e),currentStart=this.selectionStart,currentEnd=this.selectionEnd;(newSelectionStart===this.__selectionStartOnMouseDown&&currentStart!==currentEnd||currentStart!==newSelectionStart&&currentEnd!==newSelectionStart)&&(newSelectionStart>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=newSelectionStart):(this.selectionStart=newSelectionStart,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===currentStart&&this.selectionEnd===currentEnd||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(start,end,text){var smallerTextStart=text.slice(0,start),graphemeStart=fabric.util.string.graphemeSplit(smallerTextStart).length;if(start===end)return{selectionStart:graphemeStart,selectionEnd:graphemeStart};var smallerTextEnd=text.slice(start,end),graphemeEnd;return{selectionStart:graphemeStart,selectionEnd:graphemeStart+fabric.util.string.graphemeSplit(smallerTextEnd).length}},fromGraphemeToStringSelection:function(start,end,_text){var smallerTextStart,graphemeStart=_text.slice(0,start).join("").length,smallerTextEnd,graphemeEnd;return start===end?{selectionStart:graphemeStart,selectionEnd:graphemeStart}:{selectionStart:graphemeStart,selectionEnd:graphemeStart+_text.slice(start,end).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var newSelection=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=newSelection.selectionStart,this.hiddenTextarea.selectionEnd=newSelection.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var newSelection=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=newSelection.selectionEnd,this.inCompositionMode||(this.selectionStart=newSelection.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var style=this._calcTextareaPosition();this.hiddenTextarea.style.left=style.left,this.hiddenTextarea.style.top=style.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var desiredPostion=this.inCompositionMode?this.compositionStart:this.selectionStart,boundaries=this._getCursorBoundaries(desiredPostion),cursorLocation=this.get2DCursorLocation(desiredPostion),lineIndex=cursorLocation.lineIndex,charIndex=cursorLocation.charIndex,charHeight=this.getValueOfPropertyAt(lineIndex,charIndex,"fontSize")*this.lineHeight,leftOffset=boundaries.leftOffset,m=this.calcTransformMatrix(),p={x:boundaries.left+leftOffset,y:boundaries.top+boundaries.topOffset+charHeight},upperCanvas=this.canvas.upperCanvasEl,upperCanvasWidth=upperCanvas.width,upperCanvasHeight=upperCanvas.height,maxWidth=upperCanvasWidth-charHeight,maxHeight=upperCanvasHeight-charHeight,scaleX=upperCanvas.clientWidth/upperCanvasWidth,scaleY=upperCanvas.clientHeight/upperCanvasHeight;return p=fabric.util.transformPoint(p,m),(p=fabric.util.transformPoint(p,this.canvas.viewportTransform)).x*=scaleX,p.y*=scaleY,p.x<0&&(p.x=0),p.x>maxWidth&&(p.x=maxWidth),p.y<0&&(p.y=0),p.y>maxHeight&&(p.y=maxHeight),p.x+=this.canvas._offset.left,p.y+=this.canvas._offset.top,{left:p.x+"px",top:p.y+"px",fontSize:charHeight+"px",charHeight:charHeight}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var isTextChanged=this._textBeforeEdit!==this.text;return this.selected=!1,this.isEditing=!1,this.selectable=!0,this.selectionEnd=this.selectionStart,this.hiddenTextarea&&(this.hiddenTextarea.blur&&this.hiddenTextarea.blur(),this.canvas&&this.hiddenTextarea.parentNode.removeChild(this.hiddenTextarea),this.hiddenTextarea=null),this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),isTextChanged&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),isTextChanged&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var prop in this.styles)this._textLines[prop]||delete this.styles[prop]},removeStyleFromTo:function(start,end){var cursorStart=this.get2DCursorLocation(start,!0),cursorEnd=this.get2DCursorLocation(end,!0),lineStart=cursorStart.lineIndex,charStart=cursorStart.charIndex,lineEnd=cursorEnd.lineIndex,charEnd=cursorEnd.charIndex,i,styleObj;if(lineStart!==lineEnd){if(this.styles[lineStart])for(i=charStart;i<this._unwrappedTextLines[lineStart].length;i++)delete this.styles[lineStart][i];if(this.styles[lineEnd])for(i=charEnd;i<this._unwrappedTextLines[lineEnd].length;i++)(styleObj=this.styles[lineEnd][i])&&(this.styles[lineStart]||(this.styles[lineStart]={}),this.styles[lineStart][charStart+i-charEnd]=styleObj);for(i=lineStart+1;i<=lineEnd;i++)delete this.styles[i];this.shiftLineStyles(lineEnd,lineStart-lineEnd)}else if(this.styles[lineStart]){styleObj=this.styles[lineStart];var diff=charEnd-charStart,numericChar,_char;for(i=charStart;i<charEnd;i++)delete styleObj[i];for(_char in this.styles[lineStart])(numericChar=parseInt(_char,10))>=charEnd&&(styleObj[numericChar-diff]=styleObj[_char],delete styleObj[_char])}},shiftLineStyles:function(lineIndex,offset){var clonedStyles=clone(this.styles);for(var line in this.styles){var numericLine=parseInt(line,10);numericLine>lineIndex&&(this.styles[numericLine+offset]=clonedStyles[numericLine],clonedStyles[numericLine-offset]||delete this.styles[numericLine])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(lineIndex,charIndex,qty,copiedStyle){var currentCharStyle,newLineStyles={},somethingAdded=!1;for(var index in qty||(qty=1),this.shiftLineStyles(lineIndex,qty),this.styles[lineIndex]&&(currentCharStyle=this.styles[lineIndex][0===charIndex?charIndex:charIndex-1]),this.styles[lineIndex]){var numIndex=parseInt(index,10);numIndex>=charIndex&&(somethingAdded=!0,newLineStyles[numIndex-charIndex]=this.styles[lineIndex][index],delete this.styles[lineIndex][index])}for(somethingAdded?this.styles[lineIndex+qty]=newLineStyles:delete this.styles[lineIndex+qty];qty>1;)qty--,copiedStyle&&copiedStyle[qty]?this.styles[lineIndex+qty]={0:clone(copiedStyle[qty])}:currentCharStyle?this.styles[lineIndex+qty]={0:clone(currentCharStyle)}:delete this.styles[lineIndex+qty];this._forceClearCache=!0},insertCharStyleObject:function(lineIndex,charIndex,quantity,copiedStyle){this.styles||(this.styles={});var currentLineStyles=this.styles[lineIndex],currentLineStylesCloned=currentLineStyles?clone(currentLineStyles):{};for(var index in quantity||(quantity=1),currentLineStylesCloned){var numericIndex=parseInt(index,10);numericIndex>=charIndex&&(currentLineStyles[numericIndex+quantity]=currentLineStylesCloned[numericIndex],currentLineStylesCloned[numericIndex-quantity]||delete currentLineStyles[numericIndex])}if(this._forceClearCache=!0,copiedStyle)for(;quantity--;)Object.keys(copiedStyle[quantity]).length&&(this.styles[lineIndex]||(this.styles[lineIndex]={}),this.styles[lineIndex][charIndex+quantity]=clone(copiedStyle[quantity]));else if(currentLineStyles)for(var newStyle=currentLineStyles[charIndex?charIndex-1:1];newStyle&&quantity--;)this.styles[lineIndex][charIndex+quantity]=clone(newStyle)},insertNewStyleBlock:function(insertedText,start,copiedStyle){for(var cursorLoc=this.get2DCursorLocation(start,!0),addedLines=[0],linesLenght=0,i=0;i<insertedText.length;i++)"\n"===insertedText[i]?addedLines[++linesLenght]=0:addedLines[linesLenght]++;addedLines[0]>0&&(this.insertCharStyleObject(cursorLoc.lineIndex,cursorLoc.charIndex,addedLines[0],copiedStyle),copiedStyle=copiedStyle&&copiedStyle.slice(addedLines[0]+1)),linesLenght&&this.insertNewlineStyleObject(cursorLoc.lineIndex,cursorLoc.charIndex+addedLines[0],linesLenght);for(var i=1;i<linesLenght;i++)addedLines[i]>0?this.insertCharStyleObject(cursorLoc.lineIndex+i,0,addedLines[i],copiedStyle):copiedStyle&&(this.styles[cursorLoc.lineIndex+i][0]=copiedStyle[0]),copiedStyle=copiedStyle&&copiedStyle.slice(addedLines[i]+1);addedLines[i]>0&&this.insertCharStyleObject(cursorLoc.lineIndex+i,0,addedLines[i],copiedStyle)},setSelectionStartEndWithShift:function(start,end,newSelection){newSelection<=start?(end===start?this._selectionDirection="left":"right"===this._selectionDirection&&(this._selectionDirection="left",this.selectionEnd=start),this.selectionStart=newSelection):newSelection>start&&newSelection<end?"right"===this._selectionDirection?this.selectionEnd=newSelection:this.selectionStart=newSelection:(end===start?this._selectionDirection="right":"left"===this._selectionDirection&&(this._selectionDirection="right",this.selectionStart=end),this.selectionEnd=newSelection)},setSelectionInBoundaries:function(){var length=this.text.length;this.selectionStart>length?this.selectionStart=length:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>length?this.selectionEnd=length:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),fabric.util.object.extend(fabric.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(options){if(this.canvas){this.__newClickTime=+new Date;var newPointer=options.pointer;this.isTripleClick(newPointer)&&(this.fire("tripleclick",options),this._stopEvent(options.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=newPointer,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(newPointer){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===newPointer.x&&this.__lastPointer.y===newPointer.y},_stopEvent:function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},initClicks:function(){this.on("mousedblclick",function(options){this.selectWord(this.getSelectionStartFromPointer(options.e))}),this.on("tripleclick",function(options){this.selectLine(this.getSelectionStartFromPointer(options.e))})},_mouseDownHandler:function(options){!this.canvas||!this.editable||options.e.button&&1!==options.e.button||(this.__isMousedown=!0,this.selected&&this.setCursorByClick(options.e),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(options){!this.canvas||!this.editable||options.e.button&&1!==options.e.button||this===this.canvas._activeObject&&(this.selected=!0)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(options){this.__isMousedown=!1,!this.editable||this.group||options.transform&&options.transform.actionPerformed||options.e.button&&1!==options.e.button||(this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(options.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0)},setCursorByClick:function(e){var newSelection=this.getSelectionStartFromPointer(e),start=this.selectionStart,end=this.selectionEnd;e.shiftKey?this.setSelectionStartEndWithShift(start,end,newSelection):(this.selectionStart=newSelection,this.selectionEnd=newSelection),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(e){for(var mouseOffset=this.getLocalPointer(e),prevWidth=0,width=0,height=0,charIndex=0,lineIndex=0,lineLeftOffset,line,i=0,len=this._textLines.length;i<len&&height<=mouseOffset.y;i++)height+=this.getHeightOfLine(i)*this.scaleY,lineIndex=i,i>0&&(charIndex+=this._textLines[i-1].length+1);width=(lineLeftOffset=this._getLineLeftOffset(lineIndex))*this.scaleX;for(var j=0,jlen=(line=this._textLines[lineIndex]).length;j<jlen&&(prevWidth=width,(width+=this.__charBounds[lineIndex][j].kernedWidth*this.scaleX)<=mouseOffset.x);j++)charIndex++;return this._getNewSelectionStartFromOffset(mouseOffset,prevWidth,width,charIndex,jlen)},_getNewSelectionStartFromOffset:function(mouseOffset,prevWidth,width,index,jlen){var distanceBtwLastCharAndCursor=mouseOffset.x-prevWidth,distanceBtwNextCharAndCursor=width-mouseOffset.x,offset,newSelectionStart=index+(distanceBtwNextCharAndCursor>distanceBtwLastCharAndCursor||distanceBtwNextCharAndCursor<0?0:1);return this.flipX&&(newSelectionStart=jlen-newSelectionStart),newSelectionStart>this._text.length&&(newSelectionStart=this._text.length),newSelectionStart}}),fabric.util.object.extend(fabric.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=fabric.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var style=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+style.top+"; left: "+style.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingtop: "+style.fontSize+";",fabric.document.body.appendChild(this.hiddenTextarea),fabric.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),fabric.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),fabric.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),fabric.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),fabric.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),fabric.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(fabric.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(e){if(this.isEditing&&!this.inCompositionMode){if(e.keyCode in this.keysMap)this[this.keysMap[e.keyCode]](e);else{if(!(e.keyCode in this.ctrlKeysMapDown&&(e.ctrlKey||e.metaKey)))return;this[this.ctrlKeysMapDown[e.keyCode]](e)}e.stopImmediatePropagation(),e.preventDefault(),e.keyCode>=33&&e.keyCode<=40?(this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(e){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:e.keyCode in this.ctrlKeysMapUp&&(e.ctrlKey||e.metaKey)&&(this[this.ctrlKeysMapUp[e.keyCode]](e),e.stopImmediatePropagation(),e.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(e){var fromPaste=this.fromPaste;if(this.fromPaste=!1,e&&e.stopPropagation(),this.isEditing){var nextText=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,charCount=this._text.length,nextCharCount=nextText.length,removedText,insertedText,charDiff=nextCharCount-charCount;if(""===this.hiddenTextarea.value)return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var textareaSelection=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),backDelete=this.selectionStart>textareaSelection.selectionStart;this.selectionStart!==this.selectionEnd?(removedText=this._text.slice(this.selectionStart,this.selectionEnd),charDiff+=this.selectionEnd-this.selectionStart):nextCharCount<charCount&&(removedText=backDelete?this._text.slice(this.selectionEnd+charDiff,this.selectionEnd):this._text.slice(this.selectionStart,this.selectionStart-charDiff)),insertedText=nextText.slice(textareaSelection.selectionEnd-charDiff,textareaSelection.selectionEnd),removedText&&removedText.length&&(this.selectionStart!==this.selectionEnd?this.removeStyleFromTo(this.selectionStart,this.selectionEnd):backDelete?this.removeStyleFromTo(this.selectionEnd-removedText.length,this.selectionEnd):this.removeStyleFromTo(this.selectionEnd,this.selectionEnd+removedText.length)),insertedText.length&&(fromPaste&&insertedText.join("")===fabric.copiedText?this.insertNewStyleBlock(insertedText,this.selectionStart,fabric.copiedTextStyle):this.insertNewStyleBlock(insertedText,this.selectionStart)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(e){this.compositionStart=e.target.selectionStart,this.compositionEnd=e.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(fabric.copiedText=this.getSelectedText(),fabric.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(e){return e&&e.clipboardData||fabric.window.clipboardData},_getWidthBeforeCursor:function(lineIndex,charIndex){var widthBeforeCursor=this._getLineLeftOffset(lineIndex),bound;return charIndex>0&&(widthBeforeCursor+=(bound=this.__charBounds[lineIndex][charIndex-1]).left+bound.width),widthBeforeCursor},getDownCursorOffset:function(e,isRight){var selectionProp=this._getSelectionForOffset(e,isRight),cursorLocation=this.get2DCursorLocation(selectionProp),lineIndex=cursorLocation.lineIndex;if(lineIndex===this._textLines.length-1||e.metaKey||34===e.keyCode)return this._text.length-selectionProp;var charIndex=cursorLocation.charIndex,widthBeforeCursor=this._getWidthBeforeCursor(lineIndex,charIndex),indexOnOtherLine=this._getIndexOnLine(lineIndex+1,widthBeforeCursor),textAfterCursor;return this._textLines[lineIndex].slice(charIndex).length+indexOnOtherLine+2},_getSelectionForOffset:function(e,isRight){return e.shiftKey&&this.selectionStart!==this.selectionEnd&&isRight?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(e,isRight){var selectionProp=this._getSelectionForOffset(e,isRight),cursorLocation=this.get2DCursorLocation(selectionProp),lineIndex=cursorLocation.lineIndex;if(0===lineIndex||e.metaKey||33===e.keyCode)return-selectionProp;var charIndex=cursorLocation.charIndex,widthBeforeCursor=this._getWidthBeforeCursor(lineIndex,charIndex),indexOnOtherLine=this._getIndexOnLine(lineIndex-1,widthBeforeCursor),textBeforeCursor=this._textLines[lineIndex].slice(0,charIndex);return-this._textLines[lineIndex-1].length+indexOnOtherLine-textBeforeCursor.length},_getIndexOnLine:function(lineIndex,width){for(var line=this._textLines[lineIndex],lineLeftOffset,widthOfCharsOnLine=this._getLineLeftOffset(lineIndex),indexOnLine=0,charWidth,foundMatch,j=0,jlen=line.length;j<jlen;j++)if((widthOfCharsOnLine+=charWidth=this.__charBounds[lineIndex][j].width)>width){foundMatch=!0;var leftEdge=widthOfCharsOnLine-charWidth,rightEdge=widthOfCharsOnLine,offsetFromLeftEdge=Math.abs(leftEdge-width),offsetFromRightEdge;indexOnLine=Math.abs(rightEdge-width)<offsetFromLeftEdge?j:j-1;break}return foundMatch||(indexOnLine=line.length-1),indexOnLine},moveCursorDown:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)},moveCursorUp:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)},_moveCursorUpOrDown:function(direction,e){var action,offset=this["get"+direction+"CursorOffset"](e,"right"===this._selectionDirection);e.shiftKey?this.moveCursorWithShift(offset):this.moveCursorWithoutShift(offset),0!==offset&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(offset){var newSelection="left"===this._selectionDirection?this.selectionStart+offset:this.selectionEnd+offset;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,newSelection),0!==offset},moveCursorWithoutShift:function(offset){return offset<0?(this.selectionStart+=offset,this.selectionEnd=this.selectionStart):(this.selectionEnd+=offset,this.selectionStart=this.selectionEnd),0!==offset},moveCursorLeft:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",e)},_move:function(e,prop,direction){var newValue;if(e.altKey)newValue=this["findWordBoundary"+direction](this[prop]);else{if(!e.metaKey&&35!==e.keyCode&&36!==e.keyCode)return this[prop]+="Left"===direction?-1:1,!0;newValue=this["findLineBoundary"+direction](this[prop])}if(void 0!==typeof newValue&&this[prop]!==newValue)return this[prop]=newValue,!0},_moveLeft:function(e,prop){return this._move(e,prop,"Left")},_moveRight:function(e,prop){return this._move(e,prop,"Right")},moveCursorLeftWithoutShift:function(e){var change=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(change=this._moveLeft(e,"selectionStart")),this.selectionEnd=this.selectionStart,change},moveCursorLeftWithShift:function(e){return"right"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveLeft(e,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection="left",this._moveLeft(e,"selectionStart")):void 0},moveCursorRight:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",e)},_moveCursorLeftOrRight:function(direction,e){var actionName="moveCursor"+direction+"With";this._currentCursorOpacity=1,e.shiftKey?actionName+="Shift":actionName+="outShift",this[actionName](e)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(e){return"left"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveRight(e,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(e,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(e){var changed=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(changed=this._moveRight(e,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,changed},removeChars:function(start,end){void 0===end&&(end=start+1),this.removeStyleFromTo(start,end),this._text.splice(start,end-start),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(text,style,start,end){void 0===end&&(end=start),end>start&&this.removeStyleFromTo(start,end);var graphemes=fabric.util.string.graphemeSplit(text);this.insertNewStyleBlock(graphemes,start,style),this._text=[].concat(this._text.slice(0,start),graphemes,this._text.slice(end)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var toFixed=fabric.util.toFixed,multipleSpacesRegex=/  +/g;fabric.util.object.extend(fabric.Text.prototype,{toSVG:function(reviver){var markup=this._createBaseSVGMarkup(),offsets=this._getSVGLeftTopOffsets(),textAndBg=this._getSVGTextAndBg(offsets.textTop,offsets.textLeft);return this._wrapSVGTextAndBg(markup,textAndBg),reviver?reviver(markup.join("")):markup.join("")},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(markup,textAndBg){var noShadow=!0,filter=this.getSvgFilter(),style=""===filter?"":' style="'+filter+'"',textDecoration=this.getSvgTextDecoration(this);markup.push("\t<g ",this.getSvgCommons(),'transform="',this.getSvgTransform(),this.getSvgTransformMatrix(),'"',style,">\n",textAndBg.textBgRects.join(""),'\t\t<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",textDecoration?'text-decoration="'+textDecoration+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",textAndBg.textSpans.join(""),"</text>\n","\t</g>\n")},_getSVGTextAndBg:function(textTopOffset,textLeftOffset){var textSpans=[],textBgRects=[],height=textTopOffset,lineOffset;this._setSVGBg(textBgRects);for(var i=0,len=this._textLines.length;i<len;i++)lineOffset=this._getLineLeftOffset(i),(this.textBackgroundColor||this.styleHas("textBackgroundColor",i))&&this._setSVGTextLineBg(textBgRects,i,textLeftOffset+lineOffset,height),this._setSVGTextLineText(textSpans,i,textLeftOffset+lineOffset,height),height+=this.getHeightOfLine(i);return{textSpans:textSpans,textBgRects:textBgRects}},_createTextCharSpan:function(_char,styleDecl,left,top){var shouldUseWhitespace=_char!==_char.trim()||_char.match(multipleSpacesRegex),styleProps=this.getSvgSpanStyles(styleDecl,shouldUseWhitespace),fillStyles=styleProps?'style="'+styleProps+'"':"",dy=styleDecl.deltaY,dySpan="",NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS;return dy&&(dySpan=' dy="'+toFixed(dy,NUM_FRACTION_DIGITS)+'" '),['<tspan x="',toFixed(left,NUM_FRACTION_DIGITS),'" y="',toFixed(top,NUM_FRACTION_DIGITS),'" ',dySpan,fillStyles,">",fabric.util.string.escapeXml(_char),"</tspan>"].join("")},_setSVGTextLineText:function(textSpans,lineIndex,textLeftOffset,textTopOffset){var lineHeight=this.getHeightOfLine(lineIndex),isJustify=-1!==this.textAlign.indexOf("justify"),actualStyle,nextStyle,charsToRender="",charBox,style,boxWidth=0,line=this._textLines[lineIndex],timeToRender;textTopOffset+=lineHeight*(1-this._fontSizeFraction)/this.lineHeight;for(var i=0,len=line.length-1;i<=len;i++)timeToRender=i===len||this.charSpacing,charsToRender+=line[i],charBox=this.__charBounds[lineIndex][i],0===boxWidth?(textLeftOffset+=charBox.kernedWidth-charBox.width,boxWidth+=charBox.width):boxWidth+=charBox.kernedWidth,isJustify&&!timeToRender&&this._reSpaceAndTab.test(line[i])&&(timeToRender=!0),timeToRender||(actualStyle=actualStyle||this.getCompleteStyleDeclaration(lineIndex,i),nextStyle=this.getCompleteStyleDeclaration(lineIndex,i+1),timeToRender=this._hasStyleChangedForSvg(actualStyle,nextStyle)),timeToRender&&(style=this._getStyleDeclaration(lineIndex,i)||{},textSpans.push(this._createTextCharSpan(charsToRender,style,textLeftOffset,textTopOffset)),charsToRender="",actualStyle=nextStyle,textLeftOffset+=boxWidth,boxWidth=0)},_pushTextBgRect:function(textBgRects,color,left,top,width,height){var NUM_FRACTION_DIGITS=fabric.Object.NUM_FRACTION_DIGITS;textBgRects.push("\t\t<rect ",this._getFillAttributes(color),' x="',toFixed(left,NUM_FRACTION_DIGITS),'" y="',toFixed(top,NUM_FRACTION_DIGITS),'" width="',toFixed(width,NUM_FRACTION_DIGITS),'" height="',toFixed(height,NUM_FRACTION_DIGITS),'"></rect>\n')},_setSVGTextLineBg:function(textBgRects,i,leftOffset,textTopOffset){for(var line=this._textLines[i],heightOfLine=this.getHeightOfLine(i)/this.lineHeight,boxWidth=0,boxStart=0,charBox,currentColor,lastColor=this.getValueOfPropertyAt(i,0,"textBackgroundColor"),j=0,jlen=line.length;j<jlen;j++)charBox=this.__charBounds[i][j],(currentColor=this.getValueOfPropertyAt(i,j,"textBackgroundColor"))!==lastColor?(lastColor&&this._pushTextBgRect(textBgRects,lastColor,leftOffset+boxStart,textTopOffset,boxWidth,heightOfLine),boxStart=charBox.left,boxWidth=charBox.width,lastColor=currentColor):boxWidth+=charBox.kernedWidth;currentColor&&this._pushTextBgRect(textBgRects,currentColor,leftOffset+boxStart,textTopOffset,boxWidth,heightOfLine)},_getFillAttributes:function(value){var fillColor=value&&"string"==typeof value?new fabric.Color(value):"";return fillColor&&fillColor.getSource()&&1!==fillColor.getAlpha()?'opacity="'+fillColor.getAlpha()+'" fill="'+fillColor.setAlpha(1).toRgb()+'"':'fill="'+value+'"'},_getSVGLineTopOffset:function(lineIndex){for(var lineTopOffset=0,lastHeight=0,j=0;j<lineIndex;j++)lineTopOffset+=this.getHeightOfLine(j);return lastHeight=this.getHeightOfLine(j),{lineTop:lineTopOffset,offset:(this._fontSizeMult-this._fontSizeFraction)*lastHeight/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(skipShadow){var svgStyle;return fabric.Object.prototype.getSvgStyles.call(this,skipShadow)+" white-space: pre;"}})}(),function(global){"use strict";var fabric=global.fabric||(global.fabric={});fabric.Textbox=fabric.util.createClass(fabric.IText,fabric.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:fabric.Text.prototype._dimensionAffectingProps.concat("width"),initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(textInfo){for(var realLineCount=0,realLineCharCount=0,charCount=0,map={},i=0;i<textInfo.graphemeLines.length;i++)"\n"===textInfo.graphemeText[charCount]&&i>0?(realLineCharCount=0,charCount++,realLineCount++):this._reSpaceAndTab.test(textInfo.graphemeText[charCount])&&i>0&&(realLineCharCount++,charCount++),map[i]={line:realLineCount,offset:realLineCharCount},charCount+=textInfo.graphemeLines[i].length,realLineCharCount+=textInfo.graphemeLines[i].length;return map},styleHas:function(property,lineIndex){if(this._styleMap&&!this.isWrapping){var map=this._styleMap[lineIndex];map&&(lineIndex=map.line)}return fabric.Text.prototype.styleHas.call(this,property,lineIndex)},isEmptyStyles:function(lineIndex){var offset=0,nextLineIndex=lineIndex+1,nextOffset,obj,shouldLimit=!1,map=this._styleMap[lineIndex],mapNextLine=this._styleMap[lineIndex+1];for(var p1 in map&&(lineIndex=map.line,offset=map.offset),mapNextLine&&(shouldLimit=(nextLineIndex=mapNextLine.line)===lineIndex,nextOffset=mapNextLine.offset),obj=void 0===lineIndex?this.styles:{line:this.styles[lineIndex]})for(var p2 in obj[p1])if(p2>=offset&&(!shouldLimit||p2<nextOffset))for(var p3 in obj[p1][p2])return!1;return!0},_getStyleDeclaration:function(lineIndex,charIndex){if(this._styleMap&&!this.isWrapping){var map=this._styleMap[lineIndex];if(!map)return null;lineIndex=map.line,charIndex=map.offset+charIndex}return this.callSuper("_getStyleDeclaration",lineIndex,charIndex)},_setStyleDeclaration:function(lineIndex,charIndex,style){var map=this._styleMap[lineIndex];lineIndex=map.line,charIndex=map.offset+charIndex,this.styles[lineIndex][charIndex]=style},_deleteStyleDeclaration:function(lineIndex,charIndex){var map=this._styleMap[lineIndex];lineIndex=map.line,charIndex=map.offset+charIndex,delete this.styles[lineIndex][charIndex]},_getLineStyle:function(lineIndex){var map=this._styleMap[lineIndex];return this.styles[map.line]},_setLineStyle:function(lineIndex,style){var map=this._styleMap[lineIndex];this.styles[map.line]=style},_deleteLineStyle:function(lineIndex){var map=this._styleMap[lineIndex];delete this.styles[map.line]},_wrapText:function(lines,desiredWidth){var wrapped=[],i;for(this.isWrapping=!0,i=0;i<lines.length;i++)wrapped=wrapped.concat(this._wrapLine(lines[i],i,desiredWidth));return this.isWrapping=!1,wrapped},_measureWord:function(word,lineIndex,charOffset){var width=0,prevGrapheme,skipLeft=!0;charOffset=charOffset||0;for(var i=0,len=word.length;i<len;i++){var box;width+=this._getGraphemeBox(word[i],lineIndex,i+charOffset,prevGrapheme,!0).kernedWidth,prevGrapheme=word[i]}return width},_wrapLine:function(_line,lineIndex,desiredWidth,reservedSpace){var lineWidth=0,graphemeLines=[],line=[],words=_line.split(this._reSpaceAndTab),word="",offset=0,infix=" ",wordWidth=0,infixWidth=0,largestWordWidth=0,lineJustStarted=!0,additionalSpace=this._getWidthOfCharSpacing(),reservedSpace;desiredWidth-=reservedSpace=reservedSpace||0;for(var i=0;i<words.length;i++)word=fabric.util.string.graphemeSplit(words[i]),wordWidth=this._measureWord(word,lineIndex,offset),offset+=word.length,(lineWidth+=infixWidth+wordWidth-additionalSpace)>=desiredWidth&&!lineJustStarted?(graphemeLines.push(line),line=[],lineWidth=wordWidth,lineJustStarted=!0):lineWidth+=additionalSpace,lineJustStarted||line.push(" "),line=line.concat(word),infixWidth=this._measureWord([" "],lineIndex,offset),offset++,lineJustStarted=!1,wordWidth>largestWordWidth&&(largestWordWidth=wordWidth);return i&&graphemeLines.push(line),largestWordWidth+reservedSpace>this.dynamicMinWidth&&(this.dynamicMinWidth=largestWordWidth-additionalSpace+reservedSpace),graphemeLines},isEndOfWrapping:function(lineIndex){return!this._styleMap[lineIndex+1]||this._styleMap[lineIndex+1].line!==this._styleMap[lineIndex].line},_splitTextIntoLines:function(text){for(var newText=fabric.Text.prototype._splitTextIntoLines.call(this,text),graphemeLines=this._wrapText(newText.lines,this.width),lines=new Array(graphemeLines.length),i=0;i<graphemeLines.length;i++)lines[i]=graphemeLines[i].join("");return newText.lines=lines,newText.graphemeLines=graphemeLines,newText},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},toObject:function(propertiesToInclude){return this.callSuper("toObject",["minWidth"].concat(propertiesToInclude))}}),fabric.Textbox.fromObject=function(object,callback){return fabric.Object._fromObject("Textbox",object,callback,"text")}}("undefined"!=typeof exports?exports:this),function(){var setObjectScaleOverridden=fabric.Canvas.prototype._setObjectScale;fabric.Canvas.prototype._setObjectScale=function(localMouse,transform,lockScalingX,lockScalingY,by,lockScalingFlip,_dim){var t=transform.target;if(!("x"===by&&t instanceof fabric.Textbox))return setObjectScaleOverridden.call(fabric.Canvas.prototype,localMouse,transform,lockScalingX,lockScalingY,by,lockScalingFlip,_dim);var tw=t._getTransformedDimensions().x,w=t.width*(localMouse.x/tw);return w>=t.getMinWidth()?(t.set("width",w),!0):void 0},fabric.util.object.extend(fabric.Textbox.prototype,{_removeExtraneousStyles:function(){for(var prop in this._styleMap)this._textLines[prop]||delete this.styles[this._styleMap[prop].line]}})}();